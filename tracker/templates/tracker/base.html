{% load static %}
{% load tz %}
{% load date_filters %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Car Service Tracking System - Manage your auto service business efficiently">
    <meta name="keywords" content="car service, auto repair, vehicle maintenance, service tracking, auto shop">
    <meta name="author" content="Superdoll">
    
    <!-- Favicon -->
    <link rel="icon" href="{% static 'assets/images/logo/stm_logo.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'assets/images/logo/stm_logo.png' %}" type="image/x-icon">
    
    <title>{% block title %}POS Tracker{% endblock %}</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    
    <!-- Local font fallback (works offline) -->
    <style>
        /* Prefer Montserrat if available locally or system fallbacks when offline */
        :root { --app-font-stack: "Montserrat", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        html, body { font-family: var(--app-font-stack); }
    </style>

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/font-awesome.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/icofont.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/themify.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/flag-icon.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/feather-icon.css' %}">
    
    <!-- Plugins CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/vendors/slick.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/slick-theme.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/scrollbar.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/animate.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/echart.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/date-picker.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/datatables.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/vendors/select2.css' %}">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/vendors/bootstrap.css' %}">
    
    <!-- App CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link id="color" rel="stylesheet" href="{% static 'assets/css/color-1.css' %}" media="screen">
    
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/responsive.css' %}">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/custom.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/tz-phone.css' %}">

    <!-- Timezone Detection -->
    <script>
        if (!document.cookie.split('; ').find(row => row.startsWith('django_timezone'))) {
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const expires = new Date();
            expires.setTime(expires.getTime() + (365 * 24 * 60 * 60 * 1000));
            document.cookie = `django_timezone=${encodeURIComponent(timezone)};expires=${expires.toUTCString()};path=/`;
            window.location.reload();
        }
    </script>
    
    {% block extra_css %}{% endblock %}
</head>

<body>

    <!-- loader starts-->
    <div class="loader-wrapper">
        <div class="loader">
            <div class="loader4"></div>
        </div>
    </div>
    <!-- loader ends-->
    
    <!-- tap on top starts-->
    <div class="tap-top">
        <i data-feather="chevrons-up"></i>
    </div>
    <!-- tap on tap ends-->
    
    <!-- page-wrapper Start-->
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
        <!-- Page Header Start-->
        <div class="page-header">
            <div class="header-wrapper row m-0">
                <!-- Search Form -->
                <form class="form-inline search-full col" action="#" method="get">
                    <div class="form-group w-100">
                        <div class="Typeahead Typeahead--twitterUsers">
                            <div class="u-posRelative">
                                <input class="demo-input Typeahead-input form-control-plaintext w-100" 
                                       type="text" placeholder="Search Pos .." name="q" title="" autofocus>
                                <div class="spinner-border Typeahead-spinner" role="status">
                                    <span class="sr-only">Loading... </span>
                                </div>
                                <i class="close-search" data-feather="x"></i>
                            </div>
                            <div class="Typeahead-menu"></div>
                        </div>
                    </div>
                </form>
                
                <!-- Logo -->
                <div class="header-logo-wrapper col-auto p-0">
                    <div class="logo-wrapper">
                        <a href="{% url 'tracker:dashboard' %}">
                            <img class="img-fluid for-light" src="{% static 'assets/images/logo/logo_dark.png' %}" alt="logo-light">
                            <img class="img-fluid for-dark" src="{% static 'assets/images/logo/logo.png' %}" alt="logo-dark">
                        </a>
                    </div>
                    <div class="toggle-sidebar">
                        <i class="status_toggle middle sidebar-toggle" data-feather="align-center"></i>
                    </div>
                </div>
                
                <!-- Welcome Message -->
                <div class="left-header col-xxl-5 col-xl-6 col-lg-5 col-md-4 col-sm-3 p-0">
                    <div>
                        <a class="toggle-sidebar" href="#">
                            <i class="iconly-Category icli"></i>
                        </a>
                        <div class="d-flex align-items-center gap-2">
                            <h4 class="f-w-600">Welcome <span style="color: blue;">{{user.username}}</span></h4>
                            <img class="mt-0" src="{% static 'assets/images/hand.gif' %}" alt="hand-gif">
                        </div>
                    </div>
                    <div class="welcome-content d-xl-block d-none">
                        <span class="text-truncate col-12">Here's what's happening with your store today.</span>
                    </div>
                </div>
                
                <!-- Right Navigation -->
                <div class="nav-right col-xxl-7 col-xl-6 col-md-7 col-8 pull-right right-header p-0 ms-auto">
                    <ul class="nav-menus">
                        <!-- Search -->
                        <li class="d-md-block d-none">
                            <div class="form search-form mb-0">
                                <div class="input-group">
                                    <span class="input-icon">
                                        <svg>
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#search-header"></use>
                                        </svg>
                                        <input class="w-100" type="search" placeholder="Search">
                                    </span>
                                </div>
                            </div>
                        </li>
                        
                        <!-- Mobile Search -->
                        <li class="d-md-none d-block">
                            <div class="form search-form mb-0">
                                <div class="input-group">
                                    <span class="input-show">
                                        <svg id="searchIcon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#search-header"></use>
                                        </svg>
                                        <div id="searchInput">
                                            <input type="search" placeholder="Search">
                                        </div>
                                    </span>
                                </div>
                            </div>
                        </li>
                        
                     
                        


                        <!-- Dark Mode Toggle -->
                        <li>
                            <div class="mode">
                                <i class="moon" data-feather="moon"></i>
                            </div>
                        </li>



                        <!-- Profile -->
                        <li class="profile-nav onhover-dropdown">
                            <div class="media profile-media">
                                {% if user.profile.photo %}
                                    <img class="b-r-10" src="{{ user.profile.photo.url }}" alt="{{ user.get_full_name|default:user.username }}">
                                {% else %}
                                    <div class="avatar-placeholder b-r-10" style="width: 40px; height: 40px; background-color: #f0f0f0; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                        <span style="font-size: 18px;">{{ user.get_full_name|default:user.username|first|upper }}</span>
                                    </div>
                                {% endif %}
                                <div class="media-body d-xxl-block d-none box-col-none">
                                    <div class="d-flex align-items-center gap-2">
                                        <span>{{ user.get_full_name|default:user.username }}</span>
                                        <i class="middle fa fa-angle-down"></i>
                                    </div>
                                    <p class="mb-0 font-roboto">
                                        {% if user.is_superuser %}Admin{% elif user.is_staff %}Staff{% else %}User{% endif %}
                                    </p>
                                </div>
                            </div>
                            <ul class="profile-dropdown onhover-show-div">
                                <li>
                                    <a href="{% url 'tracker:profile' %}">
                                        <i data-feather="user"></i>
                                        <span>My Profile</span>
                                    </a>
                                </li>
                                <li>
                                    <form action="{% url 'tracker:logout' %}" method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" style="background: none; border: none; color: inherit; text-decoration: none; cursor: pointer; width: 100%; text-align: left; padding: 0;">
                                            <i data-feather="log-out"></i>
                                            <span>Logout</span>
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <!-- Page Header Ends -->
        
        <!-- Page Body Start -->
        <div class="page-body-wrapper">
            <!-- Page Sidebar Start -->
            <div class="sidebar-wrapper" data-layout="stroke-svg">
                <div>
                    <div class="logo-wrapper">
                        <a href="{% url 'tracker:dashboard' %}">
                            <img class="img-fluid" src="{% static 'assets/images/logo/stm_logo.png' %}" alt="">
                        </a>
                        <div class="back-btn">
                            <i class="fa fa-angle-left"></i>
                        </div>
                        <div class="toggle-sidebar">
                            <i class="status_toggle middle sidebar-toggle" data-feather="grid"></i>
                        </div>
                    </div>
                    <div class="logo-icon-wrapper">
                        <a href="{% url 'tracker:dashboard' %}">
                          <img class="img-fluid" src="{% static 'assets/images/logo/wecare.png' %}" alt="WeCare Logo" style="width: 50px; height: auto;">

                        </a>
                    </div>
                    <nav class="sidebar-main">
                        <div class="left-arrow" id="left-arrow">
                            <i data-feather="arrow-left"></i>
                        </div>
                        <div id="sidebar-menu">
                            <ul class="sidebar-links" id="simple-bar">
                                <li class="back-btn">
                                    <a href="{% url 'tracker:dashboard' %}">
                                        <img class="img-fluid" src="{% static 'assets/images/logo/logo-icon.png' %}" alt="">
                                    </a>
                                    <div class="mobile-back text-end">
                                        <span>Back</span>
                                        <i class="fa fa-angle-right ps-2" aria-hidden="true"></i>
                                    </div>
                                </li>
                                
                                <!-- Dashboard -->
                                <li class="pin-title sidebar-main-title">
                                    <div>
                                        <h6>Pinned</h6>
                                    </div>
                                </li>


                                <li class="sidebar-list">
                                    <i class="fa fa-thumb-tack"></i>
                                    <a class="sidebar-link sidebar-title" href="{% url 'tracker:dashboard' %}">
                                        <svg class="stroke-icon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-home"></use>
                                        </svg>
                                        <span>Dashboard</span>
                                    </a>
                                </li>

                            

                                
                                <!-- Customers -->
                                <li class="sidebar-list">
                                    <i class="fa fa-thumb-tack"></i>
                                    <a class="sidebar-link sidebar-title" href="#">
                                        <svg class="stroke-icon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-user"></use>
                                        </svg>
                                        <span>Customers</span>
                                    </a>
                                    <ul class="sidebar-submenu">
                                        <li><a href="{% url 'tracker:customers_list' %}">All Customers</a></li>
                                        <li><a href="{% url 'tracker:customer_register' %}">Add Customer</a></li>
                                        <li><a href="{% url 'tracker:customer_groups_advanced' %}">Customer Types</a></li>
                                    </ul>
                                </li>
                                
                                <!-- Orders -->
                                <li class="sidebar-list">
                                    <i class="fa fa-thumb-tack"></i>
                                    <a class="sidebar-link sidebar-title" href="#">
                                        <svg class="stroke-icon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-layout"></use>
                                        </svg>
                                        <span>Orders</span>
                                    </a>
                                    <ul class="sidebar-submenu">
                                        <li><a href="{% url 'tracker:orders_list' %}">All Orders</a></li>
                                        <li><a href="{% url 'tracker:inquiries' %}">Inquiries</a></li>
                                    </ul>
                                </li>
                                
                                <!-- Inventory -->
                                <li class="sidebar-list">
                                    <i class="fa fa-thumb-tack"></i>
                                    <a class="sidebar-link sidebar-title" href="#">
                                        <svg class="stroke-icon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-table"></use>
                                        </svg>
                                        <span>Inventory</span>
                                    </a>
                                    <ul class="sidebar-submenu">
                                        <li><a href="{% url 'tracker:inventory_list' %}">All Items</a></li>
                                        <li><a href="{% url 'tracker:inventory_create' %}">Add Item</a></li>
                                        <li><a href="{% url 'tracker:inventory_stock_management' %}">Stock Management</a></li>
                                      
                                        <li><a href="{% url 'tracker:brand_list' %}">Brands</a></li>
                                    </ul>
                                </li>
                         
                                
                           

                                <!-- Vehicle Tracking -->
                                <li class="sidebar-list">
                                    <i class="fa fa-truck"></i>
                                    <a class="sidebar-link sidebar-title" href="{% url 'tracker:vehicle_tracking_dashboard' %}">
                                        <svg class="stroke-icon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-chart"></use>
                                        </svg>
                                        <span>Vehicle Tracking</span>
                                    </a>
                                </li>

                                <!-- Delay Analytics -->
                                <li class="sidebar-list">
                                    <i class="fa fa-chart-line"></i>
                                    <a class="sidebar-link sidebar-title" href="{% url 'tracker:delay_analytics_dashboard' %}">
                                        <svg class="stroke-icon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-chart"></use>
                                        </svg>
                                        <span>Delay Analytics</span>
                                    </a>
                                </li>

                                <!-- Labour Codes -->
                                <li class="sidebar-list">
                                    <i class="fa fa-thumb-tack"></i>
                                    <a class="sidebar-link sidebar-title" href="#">
                                        <svg class="stroke-icon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-table"></use>
                                        </svg>
                                        <span>Labour Codes</span>
                                    </a>
                                    <ul class="sidebar-submenu">
                                        <li><a href="{% url 'tracker:labour_codes_list' %}">All Labour Codes</a></li>
                                        <li><a href="{% url 'tracker:labour_codes_import' %}">Import / Add</a></li>
                                    </ul>
                                </li>

                                <!-- System -->
                                {% if user.is_superuser %}
                                <li class="sidebar-list">
                                    <i class="fa fa-thumb-tack"></i>
                                    <a class="sidebar-link sidebar-title" href="#">
                                        <svg class="stroke-icon">
                                            <use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-learning"></use>
                                        </svg>
                                        <span>System</span>
                                    </a>
                                    <ul class="sidebar-submenu">
                                        <li><a href="{% url 'tracker:users_list' %}">Users</a></li>
                                        <li><a href="{% url 'tracker:branches_list' %}">Branches</a></li>
                                        <li><a href="{% url 'tracker:system_settings' %}">Settings</a></li>
                                        <li><a href="{% url 'tracker:audit_logs' %}">Audit Logs</a></li>
                                        <li><a href="{% url 'tracker:backup_restore' %}">Backup & Restore</a></li>
                                        <li class="mt-2"><span class="small text-muted">Service Settings</span></li>
                                        <li><a href="{% url 'tracker:service_types_list' %}">Service Types</a></li>
                                        <li><a href="{% url 'tracker:service_addons_list' %}">Service Add-ons</a></li>
                                    </ul>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="right-arrow" id="right-arrow">
                            <i data-feather="arrow-right"></i>
                        </div>
                    </nav>
                </div>
            </div>
            <!-- Page Sidebar Ends -->
            
            <!-- Page Body Start -->
            <div class="page-body">
                {% block content %}
                
                {% endblock %}
            </div>
            <!-- Page Body Ends -->
        </div>
        <!-- Page Body Wrapper Ends -->
    </div>
    <!-- page-wrapper Ends -->
    
    <!-- Scripts -->
    <script src="{% static 'assets/js/jquery.min.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'assets/js/icons/feather-icon/feather.min.js' %}"></script>
    <script src="{% static 'assets/js/icons/feather-icon/feather-icon.js' %}"></script>
    <script src="{% static 'assets/js/scrollbar/simplebar.js' %}"></script>
    <script src="{% static 'assets/js/scrollbar/custom.js' %}"></script>
    <script src="{% static 'assets/js/config.js' %}"></script>
    <!-- CSRF Helper - Load early so other scripts can use it -->
    <script src="{% static 'js/csrf_helper.js' %}"></script>
    <script src="{% static 'assets/js/sidebar-menu.js' %}"></script>
    <script src="{% static 'assets/js/sidebar-pin.js' %}"></script>
    <script src="{% static 'assets/js/slick/slick.min.js' %}"></script>
    <script src="{% static 'assets/js/slick/slick.js' %}"></script>
    <script src="{% static 'assets/js/header-slick.js' %}"></script>
    <script src="{% static 'assets/js/script.js' %}"></script>
    <script src="{% static 'js/phone_validation.js' %}"></script>

    <script>
      document.addEventListener('DOMContentLoaded', function(){
        var list = document.getElementById('recentInvoicesList');
        if (!list) return;
        fetch('/api/invoices/recent/', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r=>r.json()).then(data=>{
            data.invoices.forEach(function(inv){
              var li = document.createElement('li');
              li.className = 'mb-2';
              li.innerHTML = '<div class="d-flex justify-content-between align-items-center">'
                +'<div><a href="'+inv.detail_url+'">'+inv.invoice_number+'<br><small class="text-muted">'+inv.customer_name+'</small></a></div>'
                +'<div class="btn-group btn-group-sm ms-2">'
                +'<a class="btn btn-outline-secondary btn-sm" href="'+inv.print_url+'" target="_blank" title="Print"><i class="fa fa-print"></i></a>'
                +'<a class="btn btn-outline-secondary btn-sm" href="'+inv.pdf_url+'" title="Download PDF"><i class="fa fa-download"></i></a>'
                +'</div></div>';
              list.appendChild(li);
            });
          }).catch(function(){/* ignore */});
      });
    </script>

    
    <!-- Notification initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load notifications when page is ready
            if (typeof loadNotifications === 'function') {
                loadNotifications();
                // Refresh notifications every 5 minutes
                setInterval(loadNotifications, 300000);
            }
        });
    </script>

    <script>
        // Provide lightweight no-op stubs for optional external chart libraries when offline
        if (typeof window.echarts === 'undefined') {
            window.echarts = {
                init: function() {
                    return {
                        setOption: function() {},
                        resize: function() {},
                        off: function() {},
                        on: function() {},
                        dispose: function() {}
                    };
                }
            };
        }
        if (typeof window.Chart === 'undefined') {
            window.Chart = function() {
                return { destroy: function() {}, update: function() {} };
            };
        }
    </script>

    <!-- Order Storage Utility -->
    <script src="{% static 'js/order_storage.js' %}"></script>

    {% block extra_js %}{% endblock %}

    <!-- Data Mismatch Handler Modal -->
    {% include 'tracker/partials/data_mismatch_handler.html' %}


    <!-- Start Order Modal -->
    {% include 'tracker/partials/start_order_modal.html' %}

    <!-- Footer -->
    <footer class="footer py-3 mt-4" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6;">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 text-center">
                    <span class="text-muted">superdoll â€” Generated by superdoll.innovation Team</span>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
