{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}
{% load date_filters %}
{% load order_filters %}

{% block title %}Orders{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6">
        <h4>Orders</h4>
        <!-- Tab Toggle for Regular vs Started Orders -->
        <div class="btn-group mt-2" role="tablist">
          <button class="btn btn-outline-primary btn-sm {% if order_view_mode == 'regular' %}active{% endif %}" type="button" onclick="switchOrderView('regular')">
            <i class="fa fa-list me-1"></i>Regular Orders
          </button>
          <button class="btn btn-outline-warning btn-sm {% if order_view_mode == 'started' %}active{% endif %}" type="button" onclick="switchOrderView('started')">
            <i class="fa fa-play-circle me-1"></i>Started Orders
          </button>
        </div>
      </div>
      <div class="col-6">
        <div class="d-flex justify-content-between align-items-start">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'tracker:dashboard' %}"><i class="fa fa-home"></i></a></li>
            <li class="breadcrumb-item active">Orders</li>
          </ol>
          <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#startOrderModal" title="Start a new order">
            <i class="fa fa-plus me-1"></i> Start New Order
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced KPI Cards Section - Regular Orders -->
  <div id="regularOrdersKPIs" class="row g-3 mb-4" style="{% if order_view_mode == 'started' %}display: none;{% endif %}">
    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Total Orders</h6>
              <h3 class="mb-0 fw-bold">{{ total_orders }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-shopping-bag fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">All orders in the system</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-warning text-dark">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Active Orders</h6>
              <h3 class="mb-0 fw-bold">{{ active_orders }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-clock fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Currently in progress</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Completed Today</h6>
              <h3 class="mb-0 fw-bold">{{ completed_today }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-check-circle fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Finished in last 24 hours</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-danger text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Overdue</h6>
              <h3 class="mb-0 fw-bold">{{ overdue_count|default:"0" }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-exclamation-triangle fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Past their due date</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced KPI Cards Section - Started Orders -->
  <div id="startedOrdersKPIs" class="row g-3 mb-4" style="{% if order_view_mode != 'started' %}display: none;{% endif %}">
    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Total Started</h6>
              <h3 class="mb-0 fw-bold">{{ started_total|default:"0" }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-play-circle fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Orders in progress</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-warning text-dark">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Pending</h6>
              <h3 class="mb-0 fw-bold">{{ started_pending|default:"0" }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-hourglass fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Awaiting completion</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Completed</h6>
              <h3 class="mb-0 fw-bold">{{ started_completed|default:"0" }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-check-circle fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Finished orders</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6">
      <div class="card kpi-card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-title mb-1">Documents Uploaded</h6>
              <h3 class="mb-0 fw-bold">{{ documents_uploaded|default:"0" }}</h3>
            </div>
            <div class="kpi-icon">
              <i class="fa fa-file-upload fa-2x opacity-50"></i>
            </div>
          </div>
          <div class="mt-2">
            <small class="opacity-75">Invoices extracted</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search & Filters Section - Regular Orders -->
  <div id="regularOrdersFilters" class="row g-3 mb-3" style="{% if order_view_mode == 'started' %}display: none;{% endif %}">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-filter me-2"></i>Search & Filters</h6>
        </div>
        <div class="card-body">
          <form method="get">
            <input type="hidden" name="view" value="regular">
            <div class="row g-3 align-items-end">
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Status</label>
                <select name="status" class="form-select">
                  {% with s=status %}
                  <option value="all" {% if s == 'all' %}selected{% endif %}>All</option>
                  <option value="created" {% if s == 'created' %}selected{% endif %}>Started</option>
                  <option value="in_progress" {% if s == 'in_progress' %}selected{% endif %}>In Progress</option>
                  <option value="overdue" {% if s == 'overdue' %}selected{% endif %}>Overdue</option>
                  <option value="completed" {% if s == 'completed' %}selected{% endif %}>Completed</option>
                  <option value="cancelled" {% if s == 'cancelled' %}selected{% endif %}>Cancelled</option>
                  {% endwith %}
                </select>
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Type</label>
                <select name="type" class="form-select">
                  {% with t=type %}
                  <option value="all" {% if t == 'all' %}selected{% endif %}>All</option>
                  <option value="service" {% if t == 'service' %}selected{% endif %}>Service</option>
                  <option value="sales" {% if t == 'sales' %}selected{% endif %}>Sales</option>
                  <option value="labour" {% if t == 'labour' %}selected{% endif %}>Labour</option>
                  <option value="inquiry" {% if t == 'inquiry' %}selected{% endif %}>Inquiry</option>
                  <option value="mixed" {% if t == 'mixed' %}selected{% endif %}>Mixed</option>
                  {% endwith %}
                </select>
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Date Range</label>
                <select name="date_range" class="form-select">
                  {% with dr=request.GET.date_range|default:'' %}
                  <option value="">Any</option>
                  <option value="daily" {% if dr == 'daily' or dr == 'today' %}selected{% endif %}>Today</option>
                  <option value="weekly" {% if dr == 'weekly' or dr == 'week' %}selected{% endif %}>Last 7 days</option>
                  <option value="monthly" {% if dr == 'monthly' or dr == 'month' %}selected{% endif %}>Last 30 days</option>
                  <option value="yearly" {% if dr == 'yearly' or dr == 'year' %}selected{% endif %}>This year</option>
                  {% endwith %}
                </select>
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Salesperson</label>
                <select name="salesperson" class="form-select">
                  <option value="">All Salespeople</option>
                  {% for sp in salespersons %}
                  {% if request.GET.salesperson|default:"" == sp.id|stringformat:"s" %}
                  <option value="{{ sp.id }}" selected>{{ sp.code }} - {{ sp.name }}</option>
                  {% else %}
                  <option value="{{ sp.id }}">{{ sp.code }} - {{ sp.name }}</option>
                  {% endif %}
                  {% endfor %}
                </select>
              </div>
              {% if user.is_superuser %}
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Branch (admin)</label>
                <input type="text" name="branch" value="{{ request.GET.branch }}" class="form-control" placeholder="Branch name" list="branchesList">
                {% include 'tracker/partials/branch_datalist.html' %}
              </div>
              {% endif %}
              <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="d-flex gap-2 h-100 pt-3">
                  <button class="btn btn-primary flex-fill" type="submit">
                    <i class="fa fa-filter me-1"></i> Filter
                  </button>
                  {% if request.GET.status or request.GET.type or request.GET.date_range or request.GET.branch %}
                  <a href="{% url 'tracker:orders_list' %}" class="btn btn-outline-secondary" title="Clear Filters">
                    <i class="fa fa-times"></i>
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Search & Filters Section - Started Orders -->
  <div id="startedOrdersFilters" class="row g-3 mb-3" style="{% if order_view_mode != 'started' %}display: none;{% endif %}">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-filter me-2"></i>Search & Filters</h6>
        </div>
        <div class="card-body">
          <form method="get">
            <input type="hidden" name="view" value="started">
            <div class="row g-3 align-items-end">
              <div class="col-xl-3 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Search by Plate Number</label>
                <input type="text" name="plate_search" class="form-control" placeholder="Enter plate number" value="{{ plate_search|default:'' }}">
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Status</label>
                <select name="status" class="form-select">
                  <option value="all" {% if started_status == 'all' %}selected{% endif %}>All</option>
                  <option value="created" {% if started_status == 'created' %}selected{% endif %}>Created</option>
                  <option value="in_progress" {% if started_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                  <option value="completed" {% if started_status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <label class="form-label fw-medium">Sort By</label>
                <select name="sort_by" class="form-select">
                  <option value="-started_at" {% if started_sort == '-started_at' %}selected{% endif %}>Newest First</option>
                  <option value="started_at" {% if started_sort == 'started_at' %}selected{% endif %}>Oldest First</option>
                  <option value="plate_number" {% if started_sort == 'plate_number' %}selected{% endif %}>Plate</option>
                  <option value="customer_name" {% if started_sort == 'customer_name' %}selected{% endif %}>Customer</option>
                </select>
              </div>
              <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="d-flex gap-2 h-100 pt-3">
                  <button class="btn btn-primary flex-fill" type="submit">
                    <i class="fa fa-search me-1"></i> Search
                  </button>
                  {% if request.GET.plate_search or request.GET.status %}
                  <a href="{% url 'tracker:orders_list' %}?view=started" class="btn btn-outline-secondary" title="Clear Filters">
                    <i class="fa fa-times"></i>
                  </a>
                  {% endif %}
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Table - Regular Orders -->
  <div id="regularOrdersTable" class="card shadow-sm" style="{% if order_view_mode == 'started' %}display: none;{% endif %}">
    <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0"><i class="fa fa-list me-2"></i>Orders List</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="fw-semibold">Order #</th>
              <th class="fw-semibold">Customer</th>
              <th class="fw-semibold">Type</th>
              <th class="fw-semibold">Status</th>
              <th class="fw-semibold">Salesperson</th>
              <th class="fw-semibold">Created</th>
              <th class="fw-semibold">Time</th>
              <th class="fw-semibold text-end" style="width: 60px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
            <tr>
              <td>
                <a href="{% url 'tracker:order_detail' pk=o.id %}" class="text-decoration-none fw-medium">
                  {{ o.order_number }}
                </a>
              </td>
              <td>
                <a href="{% url 'tracker:customer_detail' pk=o.customer.id %}" class="text-decoration-none">
                  {{ o.customer.full_name }}
                </a>
              </td>
              <td>
                {% if o.type == 'mixed' %}
                  <span class="badge rounded-pill order-type-badge order-type-mixed" title="Mixed order containing multiple types">
                    <i class="fa fa-layer-group me-1"></i>Mixed
                  </span>
                {% elif o.type == 'service' %}
                  <span class="badge rounded-pill order-type-badge order-type-service">
                    <i class="fa fa-wrench me-1"></i>Service
                  </span>
                {% elif o.type == 'sales' %}
                  <span class="badge rounded-pill order-type-badge order-type-sales">
                    <i class="fa fa-shopping-cart me-1"></i>Sales
                  </span>
                {% elif o.type == 'labour' %}
                  <span class="badge rounded-pill order-type-badge order-type-labour">
                    <i class="fa fa-tools me-1"></i>Labour
                  </span>
                {% elif o.type == 'inquiry' %}
                  <span class="badge rounded-pill order-type-badge order-type-inquiry">
                    <i class="fa fa-question-circle me-1"></i>Inquiry
                  </span>
                {% else %}
                  <span class="badge bg-secondary rounded-pill">{{ o.type }}</span>
                {% endif %}
              </td>
              <td>
                {% if o.status == 'created' %}
                  <span class="badge bg-secondary rounded-pill"><i class="fa fa-play me-1"></i>Started</span>
                {% elif o.status == 'in_progress' %}
                  <span class="badge bg-warning text-dark rounded-pill"><i class="fa fa-clock me-1"></i>In Progress</span>
                {% elif o.status == 'overdue' %}
                  <span class="badge bg-danger rounded-pill"><i class="fa fa-exclamation-triangle me-1"></i>Overdue</span>
                {% elif o.status == 'completed' %}
                  <span class="badge bg-success rounded-pill"><i class="fa fa-check me-1"></i>Completed</span>
                {% elif o.status == 'cancelled' %}
                  <span class="badge bg-dark rounded-pill"><i class="fa fa-times me-1"></i>Cancelled</span>
                {% else %}
                  <span class="badge bg-light text-dark rounded-pill">{{ o.status }}</span>
                {% endif %}
              </td>
              <td>
                {% if o.invoices.all %}
                  {% for inv in o.invoices.all %}
                    {% if inv.salesperson %}
                      <small class="text-dark d-block"><strong>{{ inv.salesperson.code }}</strong></small>
                      <small class="text-muted">{{ inv.salesperson.name }}</small>
                      {% break %}
                    {% endif %}
                  {% endfor %}
                {% else %}
                  <small class="text-muted">-</small>
                {% endif %}
              </td>
              <td class="text-muted small">{{ o.created_at|localtime|date_medium }}</td>
              <td>
                {% if o.type == 'inquiry' %}
                  <div class="time-tracking-cell"></div>
                {% else %}
                  <div class="time-tracking-cell">
                    {% with actual_time=o|actual_time_minutes %}
                      {% if actual_time %}
                        <div class="time-item">
                          <small class="text-muted d-block fw-medium">Actual Time</small>
                          <div class="time-value fw-semibold">{{ actual_time|format_minutes }}</div>
                        </div>
                      {% else %}
                        <span class="badge bg-light text-muted">In Progress</span>
                      {% endif %}
                    {% endwith %}
                  </div>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="dropdown actions-dropdown">
                  <button class="btn btn-action" type="button" data-bs-toggle="dropdown" aria-label="More actions">
                    <i class="fa fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li>
                      <a class="dropdown-item" href="{% url 'tracker:order_detail' pk=o.id %}">
                        <i class="fa fa-eye me-2 text-primary"></i>View Details
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'tracker:order_edit' pk=o.id %}">
                        <i class="fa fa-edit me-2 text-success"></i>Edit Order
                      </a>
                    </li>
                    <li><hr class="dropdown-divider my-1"></li>
                    {% with inv=o.invoices.all|first %}
                    {% if inv %}
                 
                    {% if inv.document %}
                    <li>
                      <a class="dropdown-item" target="_blank" href="{% url 'tracker:invoice_document_view' pk=inv.id %}">
                        <i class="fa fa-external-link-alt me-2 text-info"></i>Open Uploaded Invoice
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'tracker:invoice_document_download' pk=inv.id %}">
                        <i class="fa fa-download me-2 text-dark"></i>Download Uploaded Invoice
                      </a>
                    </li>
                    {% endif %}
                    {% else %}
                    <li>
                      <a class="dropdown-item" href="{% url 'tracker:order_detail' pk=o.id %}#invoice-section">
                        <i class="fa fa-file-upload me-2 text-primary"></i>Upload Invoice
                      </a>
                    </li>
                    {% endif %}
                    {% endwith %}
                    <li><hr class="dropdown-divider my-1"></li>
                    <li>
                      <form method="post" action="{% url 'tracker:order_delete' pk=o.id %}"
                            onsubmit="return confirm('Are you sure you want to delete this order?');">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{% url 'tracker:orders_list' %}">
                        <button type="submit" class="dropdown-item text-danger">
                          <i class="fa fa-trash me-2"></i>Delete Order
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                <div class="d-flex flex-column align-items-center">
                  <i class="fa fa-inbox fa-2x mb-2 text-muted"></i>
                  <span class="mb-2">No orders found</span>
                  {% if request.GET.status or request.GET.type or request.GET.priority or request.GET.date_range %}
                  <a href="{% url 'tracker:orders_list' %}" class="btn btn-sm btn-outline-primary">
                    <i class="fa fa-times me-1"></i>Clear Filters
                  </a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="card-footer bg-light border-top-0">
        <div class="d-flex justify-content-between align-items-center">
          <div class="small text-muted">
            <i class="fa fa-info-circle me-1"></i>
            Showing {{ orders.start_index }}-{{ orders.end_index }} of {{ orders.paginator.count }} orders
          </div>
          <nav>
            <ul class="pagination pagination-sm mb-0">
              {% if orders.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1" title="First page">
                  <i class="fa fa-angle-double-left"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ orders.previous_page_number }}" title="Previous page">
                  <i class="fa fa-angle-left"></i> Prev
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link"><i class="fa fa-angle-double-left"></i></span>
              </li>
              <li class="page-item disabled">
                <span class="page-link"><i class="fa fa-angle-left"></i> Prev</span>
              </li>
              {% endif %}
              
              <li class="page-item active">
                <span class="page-link">{{ orders.number }}</span>
              </li>
              
              {% if orders.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ orders.next_page_number }}" title="Next page">
                  Next <i class="fa fa-angle-right"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ orders.paginator.num_pages }}" title="Last page">
                  <i class="fa fa-angle-double-right"></i>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next <i class="fa fa-angle-right"></i></span>
              </li>
              <li class="page-item disabled">
                <span class="page-link"><i class="fa fa-angle-double-right"></i></span>
              </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Table - Started Orders -->
  <div id="startedOrdersTable" class="card shadow-sm" style="{% if order_view_mode != 'started' %}display: none;{% endif %}">
    <div class="card-header bg-white border-bottom">
      <h5 class="card-title mb-0"><i class="fa fa-play-circle me-2"></i>Started Orders</h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="fw-semibold">Order #</th>
              <th class="fw-semibold">Plate Number</th>
              <th class="fw-semibold">Customer</th>
              <th class="fw-semibold">Phone</th>
              <th class="fw-semibold">Status</th>
              <th class="fw-semibold">Documents</th>
              <th class="fw-semibold text-end" style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for o in started_orders %}
            <tr>
              <td>
                <a href="{% url 'tracker:started_order_detail' order_id=o.id %}" class="text-decoration-none fw-medium">
                  {{ o.order_number }}
                </a>
              </td>
              <td class="fw-medium">{{ o.vehicle.plate_number|default:"â€”" }}</td>
              <td>
                <a href="{% url 'tracker:customer_detail' pk=o.customer.id %}" class="text-decoration-none">
                  {{ o.customer.full_name }}
                </a>
              </td>
              <td>{{ o.customer.phone }}</td>
              <td>
                {% if o.status == 'created' %}
                  <span class="badge bg-secondary rounded-pill"><i class="fa fa-play me-1"></i>Started</span>
                {% elif o.status == 'in_progress' %}
                  <span class="badge bg-warning text-dark rounded-pill"><i class="fa fa-clock me-1"></i>In Progress</span>
                {% elif o.status == 'completed' %}
                  <span class="badge bg-success rounded-pill"><i class="fa fa-check me-1"></i>Completed</span>
                {% else %}
                  <span class="badge bg-light text-dark rounded-pill">{{ o.status }}</span>
                {% endif %}
              </td>
              <td>
                {% if o.document_scans.count > 0 %}
                  <span class="badge bg-success rounded-pill">{{ o.document_scans.count }} <i class="fa fa-check ms-1"></i></span>
                {% else %}
                  <span class="badge bg-light text-muted">None</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="dropdown actions-dropdown">
                  <button class="btn btn-action" type="button" data-bs-toggle="dropdown">
                    <i class="fa fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li>
                      <a class="dropdown-item" href="{% url 'tracker:started_order_detail' order_id=o.id %}">
                        <i class="fa fa-eye me-2 text-primary"></i>View Details
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'tracker:started_order_detail' order_id=o.id %}?tab=documents">
                        <i class="fa fa-file-upload me-2 text-info"></i>Upload Invoice
                      </a>
                    </li>
                    <li><hr class="dropdown-divider my-1"></li>
                    <li>
                      <form method="post" action="{% url 'tracker:complete_order' pk=o.id %}" onsubmit="return confirm('Mark as completed?');">
                        {% csrf_token %}
                        <button type="submit" class="dropdown-item text-success">
                          <i class="fa fa-check me-2"></i>Complete Order
                        </button>
                      </form>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                <i class="fa fa-inbox fa-2x mb-2 text-muted d-block"></i>
                No started orders found
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Include Start Order Modal -->
{% include 'tracker/partials/start_order_modal.html' %}

{% endblock %}

{% block extra_js %}
<script>
// Switch between Regular and Started Orders views
function switchOrderView(mode) {
  const url = new URL(window.location);
  url.searchParams.set('view', mode);
  window.location.href = url.toString();
}

document.addEventListener('DOMContentLoaded', function() {
  // Complete order functionality
  document.querySelectorAll('.js-complete-order').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const orderId = this.dataset.orderId;
      if (confirm('Are you sure you want to mark this order as completed?')) {
        // Add your complete order logic here
        console.log('Completing order:', orderId);
        // You might want to submit a form or make an AJAX request here
      }
    });
  });

  // Cancel order functionality
  document.querySelectorAll('.js-cancel-order').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const orderId = this.dataset.orderId;
      if (confirm('Are you sure you want to cancel this order?')) {
        // Add your cancel order logic here
        console.log('Cancelling order:', orderId);
        // You might want to submit a form or make an AJAX request here
      }
    });
  });

  // Keep dropdown open when clicking inside form elements
  document.querySelectorAll('.actions-dropdown .dropdown-menu form').forEach(form => {
    form.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });
});
</script>

<style>
/* Enhanced KPI Cards */
.kpi-card {
  border: none;
  border-radius: 12px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.kpi-icon {
  opacity: 0.8;
}

/* Clean Action Button - No Dropdown Arrow */
.btn-action {
    width: 32px !important;
    height: 28px !important;
    padding: 0 !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border-radius: 6px !important;
    border: 1px solid #dee2e6 !important;
    background: white !important;
    color: #6c757d !important;
    font-size: 14px !important;
    transition: all 0.2s ease !important;
}

.btn-action::after {
    display: none !important;
}

.btn-action:hover {
    background: #f8f9fa !important;
    border-color: #6c757d !important;
    color: #495057 !important;
    transform: scale(1.05);
}

.btn-action:focus {
    box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25) !important;
}

/* Fixed Dropdown Styles */
.actions-dropdown .dropdown-menu {
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    min-width: 180px;
    padding: 0.5rem;
}

.actions-dropdown .dropdown-item {
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    margin: 0.125rem 0;
    transition: all 0.2s ease;
    font-weight: 500;
    display: flex;
    align-items: center;
    font-size: 0.85rem;
}

.actions-dropdown .dropdown-item:hover {
    transform: translateX(2px);
    text-decoration: none;
}

.actions-dropdown .dropdown-item:hover i.text-primary,
.actions-dropdown .dropdown-item:hover {
    background-color: #0d6efd;
    color: white !important;
}

.actions-dropdown .dropdown-item:hover i.text-success {
    background-color: #198754;
    color: white !important;
}

.actions-dropdown .dropdown-item:hover i.text-warning {
    background-color: #ffc107;
    color: black !important;
}

.actions-dropdown .dropdown-item:hover i.text-danger {
    background-color: #dc3545;
    color: white !important;
}

/* Ensure dropdown stays open when interacting with form */
.actions-dropdown .dropdown-menu form {
    margin: 0;
}

.actions-dropdown .dropdown-menu form .dropdown-item {
    margin: 0;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
}

.actions-dropdown .dropdown-menu form .dropdown-item:focus {
    outline: none;
    box-shadow: none;
}

/* Improved table responsiveness */
.table-responsive {
    border-radius: 8px;
}

/* Enhanced pagination */
.pagination .page-link {
    border-radius: 6px;
    margin: 0 2px;
}

/* Card header improvements */
.card-header {
    border-radius: 8px 8px 0 0 !important;
}

/* Full width search section */
.card-body .row {
    width: 100%;
    margin: 0;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .kpi-card .card-body {
        padding: 1rem;
    }
    
    .kpi-icon {
        display: none;
    }
    
    .actions-dropdown .dropdown-menu {
        min-width: 160px;
    }
    
    .btn-action {
        width: 28px !important;
        height: 26px !important;
        font-size: 12px !important;
    }
}

/* Better spacing for empty states */
.table td.text-center {
    padding: 3rem 1rem;
}

/* Ensure full width for search section */
.row.mb-3 .col-12 {
    padding-left: 0;
    padding-right: 0;
}

/* Table action column fixed width */
th.text-end[style*="width: 60px"],
td.text-end:last-child {
    width: 60px;
    min-width: 60px;
    max-width: 60px;
}

/* Remove any dropdown toggle arrows globally */
.dropdown-toggle::after {
    display: none !important;
}

/* Improved Search & Filter Section */
.card .card-body .form-control:focus,
.card .card-body .form-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Time Tracking Cell Styling */
.time-tracking-cell {
    display: flex;
    align-items: center;
}

.time-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 50px;
}

.time-value {
    font-size: 0.95rem;
    color: #212529;
    line-height: 1.2;
}

/* HIGHLY VISIBLE ORDER TYPE BADGES - IMMEDIATELY VISIBLE */
.order-type-badge {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-weight: 700 !important;
    letter-spacing: 0.5px;
    padding: 0.5rem 0.8rem !important;
    font-size: 0.8rem !important;
    border: 2px solid !important;
    opacity: 1 !important;
    visibility: visible !important;
    min-width: 90px !important;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
}

.order-type-mixed {
    background: linear-gradient(135deg, #e9d5ff 0%, #ddd6fe 100%) !important;
    color: #6b21a8 !important;
    border-color: #c4b5fd !important;
    box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4) !important;
}

.order-type-service {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
    color: #1e40af !important;
    border-color: #93c5fd !important;
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4) !important;
}

.order-type-sales {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%) !important;
    color: #065f46 !important;
    border-color: #6ee7b7 !important;
    box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4) !important;
}

.order-type-labour {
    background: linear-gradient(135deg, #cffafe 0%, #a5f3fc 100%) !important;
    color: #155e75 !important;
    border-color: #67e8f9 !important;
    box-shadow: 0 2px 6px rgba(6, 182, 212, 0.4) !important;
}

.order-type-inquiry {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
    color: #92400e !important;
    border-color: #fcd34d !important;
    box-shadow: 0 2px 6px rgba(245, 158, 11, 0.4) !important;
}

/* Hover effects */
.order-type-badge:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
}

/* Status badges */
.bg-secondary {
    background-color: #6c757d !important;
    color: white !important;
}

.bg-warning {
    background-color: #ffc107 !important;
    color: #212529 !important;
}

.bg-danger {
    background-color: #dc3545 !important;
    color: white !important;
}

.bg-success {
    background-color: #198754 !important;
    color: white !important;
}

.bg-dark {
    background-color: #212529 !important;
    color: white !important;
}

.bg-light {
    background-color: #f8f9fa !important;
    color: #212529 !important;
    border: 1px solid #dee2e6 !important;
}

/* Ensure table cells have proper spacing */
.table td {
    vertical-align: middle !important;
}

/* Make sure the type column has enough space */
.table th:nth-child(3),
.table td:nth-child(3) {
    min-width: 120px;
}

/* Force visibility */
.badge {
    opacity: 1 !important;
    visibility: visible !important;
}
</style>
{% endblock %}
