{% extends 'tracker/base.html' %}
{% load static custom_filters tz %}
{% load date_filters %}
{% load order_filters %}

{% block title %}Order Details{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>Order #{{ order.order_number }}</h4></div>
      <div class="col-6">
        <div class="d-flex justify-content-end align-items-center">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{% url 'tracker:orders_list' %}">Orders</a></li>
           
            <li class="breadcrumb-item active">Detail</li>
          </ol>
          {% if order.status != 'completed' and order.status != 'cancelled' %}
          <div class="ms-3">
            <form method="post" action="{% url 'tracker:order_delete' pk=order.id %}" 
                  onsubmit="return confirm('Are you sure you want to delete this order? This action cannot be undone.');">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="fa fa-trash me-1"></i>Delete Order
              </button>
            </form>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>


  </div>



{% if order.type == 'inquiry' %}
  <!-- Enhanced Inquiry Details Section -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm mb-4 inquiry-main-card">
        <div class="card-header bg-gradient-info text-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <i class="fa fa-question-circle fa-2x me-3"></i>
            <div>
              <h5 class="mb-0">Inquiry Details</h5>
              <small class="opacity-75">Customer Inquiry Information</small>
            </div>
          </div>
          <span class="badge bg-light text-info fs-6 px-3 py-2">INQUIRY ORDER</span>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <!-- Inquiry Type Card -->
            <div class="col-md-6 col-lg-3">
              <div class="inquiry-feature-card inquiry-type-card">
                <div class="card-icon">
                  <i class="fa fa-tag"></i>
                </div>
                <div class="card-content">
                  <small class="text-muted fw-bold">INQUIRY TYPE</small>
                  <div class="fw-bold text-primary fs-5 mt-1">{{ order.inquiry_type|default:'Not specified' }}</div>
                </div>
              </div>
            </div>
            
            <!-- Contact Preference Card -->
            <div class="col-md-6 col-lg-3">
              <div class="inquiry-feature-card inquiry-contact-card">
                <div class="card-icon">
                  <i class="fa fa-phone"></i>
                </div>
                <div class="card-content">
                  <small class="text-muted fw-bold">CONTACT PREFERENCE</small>
                  <div class="fw-bold text-success fs-5 mt-1">{{ order.contact_preference|default:'Not specified' }}</div>
                </div>
              </div>
            </div>
            
            <!-- Status Card -->
            <div class="col-md-6 col-lg-3">
              <div class="inquiry-feature-card inquiry-status-card">
                <div class="card-icon">
                  <i class="fa fa-flag"></i>
                </div>
                <div class="card-content">
                  <small class="text-muted fw-bold">STATUS</small>
                  <div class="fw-bold text-warning fs-5 mt-1">{{ order.get_status_display }}</div>
                </div>
              </div>
            </div>

  <!-- Customer Information for Inquiries -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="fa fa-user text-primary"></i>
                </div>
                <div>
                  <small class="text-muted d-block">Customer</small>
                  <a href="{% url 'tracker:customer_detail' pk=order.customer.id %}" class="text-decoration-none fw-medium">{{ order.customer.full_name }}</a>
                </div>
              </div>
            </div>

          </div>
          <hr class="my-3">
          <div class="row g-3">
            <div class="col-md-6">
              <small class="text-muted d-block">Phone</small>
              <div class="fw-medium">{{ order.customer.phone|default:"-" }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Email</small>
              <div class="fw-medium">{{ order.customer.email|default:"-" }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Type</small>
              <div>
                <span class="badge bg-secondary">{{ order.customer.get_customer_type_display|default:"Personal" }}</span>
                {% if order.customer.personal_subtype %}<small class="text-muted ms-2">���� {{ order.customer.get_personal_subtype_display }}</small>{% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Organization</small>
              <div class="fw-medium">{{ order.customer.organization_name|default:"-" }}</div>
            </div>
            <div class="col-12">
              <small class="text-muted d-block">Address</small>
              <div class="fw-medium">{{ order.customer.address|default:"-" }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Customer Code</small>
              <div class="fw-medium">{{ order.customer.code }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Registered</small>
              <div class="fw-medium">{{ order.customer.registration_date|localtime|date_medium }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
<!-- Vehicle Information -->
{% if order.vehicle %}
<div class="vehicle-info-card">
  <div class="vehicle-info-header">
    <i class="fa fa-car"></i>
    Vehicle Information
  </div>
  <div class="vehicle-detail-grid">
    <div class="vehicle-detail-item">
      <span class="vehicle-detail-label">Plate Number</span>
      <span class="vehicle-detail-value">{{ order.vehicle.plate_number|default:'Not specified' }}</span>
    </div>
    <div class="vehicle-detail-item">
      <span class="vehicle-detail-label">Vehicle Type</span>
      <span class="vehicle-detail-value">{{ order.vehicle.vehicle_type|default:'Not specified'|title }}</span>
    </div>
    <div class="vehicle-detail-item">
      <span class="vehicle-detail-label">Make</span>
      <span class="vehicle-detail-value">{{ order.vehicle.make|default:'-' }}</span>
    </div>
    <div class="vehicle-detail-item">
      <span class="vehicle-detail-label">Model</span>
      <span class="vehicle-detail-value">{{ order.vehicle.model|default:'-' }}</span>
    </div>
  </div>
</div>
{% endif %}

<!-- Questions -->
{% if order.questions %}
<div class="mb-3">
  <small class="text-muted d-block mb-1">Questions</small>
  <div class="content-box-questions">
    <p class="content-box-text" style="max-height: 80px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
      {{ order.questions }}
    </p>
    {% if order.questions|length > 100 %}
    <button class="btn btn-sm read-more-btn p-0 mt-1" data-bs-toggle="modal" data-bs-target="#questionsModal">
      Read full text
    </button>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Description -->
{% if order.description %}
<div class="mb-2">
  <small class="text-muted d-block mb-1">Description</small>
  <div class="content-box-description">
    <p class="content-box-text" style="max-height: 80px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
      {{ order.description }}
    </p>
    {% if order.description|length > 100 %}
    <button class="btn btn-sm read-more-btn p-0 mt-1" data-bs-toggle="modal" data-bs-target="#descriptionModal">
      Read full text
    </button>
    {% endif %}
  </div>
</div>
{% endif %}
  </div>

  <!-- Timeline for Inquiries -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-clock me-2"></i>Timeline</h6>
        </div>
        <div class="card-body">
          <div class="timeline">
            <div class="timeline-item">
              <div class="timeline-marker bg-primary"></div>
              <div class="timeline-content">
                <small class="text-muted">Created</small>
                <div class="fw-medium">{{ order.created_at|localtime|date_medium }}</div>
              </div>
            </div>
            {% if order.started_at and order.completed_at %}
            <div class="timeline-item">
              <div class="timeline-marker bg-warning"></div>
              <div class="timeline-content">
                <small class="text-muted">Started</small>
                <div class="fw-medium">{{ order.started_at|localtime|date_medium }}</div>
              </div>
            </div>
            {% endif %}
            {% if order.completed_at %}
            <div class="timeline-item">
              <div class="timeline-marker bg-success"></div>
              <div class="timeline-content">
                <small class="text-muted">Completed</small>
                <div class="fw-medium">{{ order.completed_at|localtime|date_medium }}</div>
              </div>
            </div>
            {% endif %}
            {% if order.cancelled_at %}
            <div class="timeline-item">
              <div class="timeline-marker bg-danger"></div>
              <div class="timeline-content">
                <small class="text-muted">Cancelled</small>
                <div class="fw-medium">{{ order.cancelled_at|localtime|date_medium }}</div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

{% else %}
  <!-- ALL OTHER ORDER TYPES (SERVICE, SALES) - KEEP EXACTLY THE SAME -->
  <div class="row">
    <div class="col-lg-12">
      <!-- Time Summary & Additional Information Combined Card -->
      <div class="card shadow-sm mb-4 time-info-combined-card">
        <div class="card-header bg-gradient-primary text-white">
          <h6 class="mb-0"><i class="fa fa-hourglass-half me-2"></i>Order Timeline & Information</h6>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <!-- Time Metrics Section -->
            <div class="col-lg-6 col-md-12">
              <div class="time-metrics-group">
                <h6 class="text-muted mb-3"><i class="fa fa-clock me-2"></i>Time Metrics</h6>
                <div class="time-metrics-list">
                  {% if order.completed_at %}
                  <div class="metric-row">
                    <span class="metric-label">Actual Duration</span>
                    <span class="metric-value fw-bold text-success" id="timeActualValue">
                      {% if order.actual_duration %}
                        {{ order.actual_duration }} minutes
                      {% elif order.completed_at and order.created_at %}
                        {{ order.completed_at|timesince:order.created_at }}
                      {% else %}
                        Calculating...
                      {% endif %}
                    </span>
                  </div>
                  {% else %}
                  <div class="metric-row">
                    <span class="metric-label">Elapsed Time</span>
                    <span class="metric-value fw-bold text-info" id="timeElapsedValue">--</span>
                  </div>
                  {% endif %}

                  {% if order.completed_at %}
                  <div class="metric-row">
                    <span class="metric-label">Completion Date</span>
                    <span class="metric-value fw-medium text-dark">{{ order.completed_at|localtime|date_medium }}</span>
                  </div>
                  {% endif %}

                  {% if order.signed_by %}
                  <div class="metric-row">
                    <span class="metric-label">Signed By</span>
                    <span class="metric-value fw-medium text-dark">{{ order.signed_by.get_full_name|default:order.signed_by.username }}</span>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Timeline Events Section -->
            <div class="col-lg-6 col-md-12">
              <div class="timeline-events-group">
                <h6 class="text-muted mb-3"><i class="fa fa-timeline me-2"></i>Event Timeline</h6>
                <div class="timeline-events-list">
                  <div class="timeline-event-item">
                    <div class="event-marker created">
                      <i class="fa fa-plus-circle"></i>
                    </div>
                    <div class="event-details">
                      <div class="event-label">Created</div>
                      <div class="event-time">{{ order.created_at|localtime|date:"M j, Y g:i a" }}</div>
                    </div>
                  </div>

                  {% if order.completed_at %}
                  <div class="timeline-event-item">
                    <div class="event-marker completed">
                      <i class="fa fa-check-circle"></i>
                    </div>
                    <div class="event-details">
                      <div class="event-label">Completed</div>
                      <div class="event-time">{{ order.completed_at|localtime|date:"M j, Y g:i a" }}</div>
                    </div>
                  </div>
                  {% endif %}

                  {% if order.cancelled_at %}
                  <div class="timeline-event-item">
                    <div class="event-marker cancelled">
                      <i class="fa fa-times-circle"></i>
                    </div>
                    <div class="event-details">
                      <div class="event-label">Cancelled</div>
                      <div class="event-time">{{ order.cancelled_at|localtime|date:"M j, Y g:i a" }}</div>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Delay Reason Display - Shows red alert when 9+ hours exceeded with delay reason -->
            {% if order.overrun_reason and order.exceeded_9_hours %}
            <div class="col-12">
              <div class="alert alert-danger bg-danger bg-opacity-10 border-danger">
                <div class="d-flex align-items-start">
                  <i class="fa fa-exclamation-circle text-danger me-3 mt-1"></i>
                  <div>
                    <strong><i class="fa fa-clock me-2"></i>Order Exceeded 9 Working Hours (Took Longer)</strong>
                    <p class="mb-0 mt-2 text-dark">{{ order.overrun_reason }}</p>
                  </div>
                </div>
              </div>
            </div>
            {% elif order.overrun_reason %}
            <div class="col-12">
              <div class="alert alert-info bg-info bg-opacity-10 border-info">
                <div class="d-flex align-items-start">
                  <i class="fa fa-comment-dots text-info me-3 mt-1"></i>
                  <div>
                    <strong>Delay Reason</strong>
                    <p class="mb-0 mt-1 text-dark">{{ order.overrun_reason }}</p>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Customer & Order Info -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0"><i class="fa fa-user me-2"></i>Customer Information</h6>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                  <i class="fa fa-user text-primary"></i>
                </div>
                <div>
                  <small class="text-muted d-block">Customer</small>
                  <a href="{% url 'tracker:customer_detail' pk=order.customer.id %}" class="text-decoration-none fw-medium">{{ order.customer.full_name }}</a>
                </div>
              </div>
            </div>

          </div>
          <hr class="my-3">
          <div class="row g-3">
            <div class="col-md-6">
              <small class="text-muted d-block">Phone</small>
              <div class="fw-medium">{{ order.customer.phone|default:"-" }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Email</small>
              <div class="fw-medium">{{ order.customer.email|default:"-" }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Type</small>
              <div>
                <span class="badge bg-secondary">{{ order.customer.get_customer_type_display|default:"Personal" }}</span>
                {% if order.customer.personal_subtype %}<small class="text-muted ms-2">�� {{ order.customer.get_personal_subtype_display }}</small>{% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Organization</small>
              <div class="fw-medium">{{ order.customer.organization_name|default:"-" }}</div>
            </div>
            <div class="col-12">
              <small class="text-muted d-block">Address</small>
              <div class="fw-medium">{{ order.customer.address|default:"-" }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Customer Code</small>
              <div class="fw-medium">{{ order.customer.code }}</div>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Registered</small>
              <div class="fw-medium">{{ order.customer.registration_date|localtime|date_medium }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Invoice Section -->
      <div class="card shadow-sm mb-4" id="invoice-section">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fa fa-file-invoice me-2"></i>Invoices</h6>
          <div>
            {% if invoice %}
              <div class="btn-group btn-group-sm">
                {% if invoice %}
                  <a href="{% url 'tracker:invoice_detail' pk=invoice.id %}" class="btn btn-outline-primary"><i class="fa fa-eye me-1"></i>View Primary</a>
                  <a href="{% url 'tracker:invoice_print' pk=invoice.id %}" target="_blank" class="btn btn-outline-secondary"><i class="fa fa-print me-1"></i>Print</a>
                  <form method="post" action="{% url 'tracker:invoice_pdf' pk=invoice.id %}" style="display:inline-block;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-success"><i class="fa fa-file-pdf me-1"></i>PDF</button>
                  </form>
                  {% if invoice.document %}
                    <a href="{% url 'tracker:invoice_document_view' pk=invoice.id %}" target="_blank" class="btn btn-outline-info"><i class="fa fa-external-link-alt me-1"></i>Open Doc</a>
                    <a href="{% url 'tracker:invoice_document_download' pk=invoice.id %}" class="btn btn-outline-dark"><i class="fa fa-download me-1"></i>Download</a>
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
        <div class="card-body">
          {% if invoice %}
            <!-- Primary Invoice -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <div class="p-3 border rounded bg-light-primary">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <span class="badge bg-primary">PRIMARY INVOICE</span>
                      <h6 class="mt-2 mb-1">{{ invoice.invoice_number }}</h6>
                      <small class="text-muted">{{ invoice.invoice_date|date:"d/m/Y" }}</small>
                    </div>
                    {% if invoice.document %}
                    <a href="{% url 'tracker:invoice_document_download' pk=invoice.id %}" class="btn btn-sm btn-outline-primary" title="Download original invoice"><i class="fa fa-download"></i></a>
                    {% endif %}
                  </div>
                  <div class="row g-2 mt-3">
                    <div class="col-md-4" style="color: #0d6efd;">
                      <small class="text-muted d-block">Subtotal (NET)</small>
                      <div class="fw-bold">{{ invoice.subtotal|floatformat:2|default:'-' }}</div>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted d-block">Tax/VAT</small>
                      <div class="fw-bold text-warning">{{ invoice.tax_amount|floatformat:2|default:'-' }}</div>
                    </div>
                    <div class="col-md-4">
                      <small class="text-muted d-block">Total Amount (GROSS)</small>
                      <div class="fw-bold text-success fs-5">{{ invoice.total_amount|floatformat:2 }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {% if invoice.line_items.all %}
            <div class="row g-3 mb-4">
              <div class="col-12">
                <div class="mb-3">
                  <h6 class="text-muted mb-2"><i class="fa fa-list me-2"></i>Line Items - Primary Invoice</h6>
                </div>
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0 invoice-line-items-table" style="table-layout: fixed;">
                    <thead class="table-light">
                      <tr style="background-color: #f8f9fa;">
                        <th class="col-line-item-sr" style="width: 5%; text-align: center;">#</th>
                        <th class="col-line-item-code" style="width: 10%;">Code</th>
                        <th class="col-line-item-desc" style="width: 35%; word-break: break-word;">Description</th>
                        <th class="col-line-item-type" style="width: 10%;">Type</th>
                        <th class="col-line-item-unit" style="width: 8%;">Unit</th>
                        <th class="col-line-item-qty" style="width: 8%; text-align: center;">Qty</th>
                        <th class="col-line-item-rate" style="width: 11%; text-align: right;">Unit Price</th>
                        <th class="col-line-item-total" style="width: 9%; text-align: right;">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in invoice.line_items.all %}
                      <tr>
                        <td class="col-line-item-sr" style="text-align: center;"><small class="fw-semibold">{{ forloop.counter }}</small></td>
                        <td class="col-line-item-code"><small class="text-muted">{{ item.code|default:'-' }}</small></td>
                        <td class="col-line-item-desc" style="word-break: break-word; white-space: normal; overflow-wrap: break-word;">
                          <small class="text-dark">{{ item.description|default:'-' }}</small>
                        </td>
                        <td class="col-line-item-type" style="text-align: center;">
                          {% if item.code %}
                            {% with cat=line_item_categories|dict_get:item.code %}
                              {% if cat and cat.order_type == 'labour' %}
                                <small class="text-muted"><span class="badge bg-info"><i class="fa fa-tools me-1"></i>Labour</span></small>
                              {% elif cat and cat.order_type == 'service' %}
                                <small class="text-muted"><span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span></small>
                              {% elif cat and cat.order_type == 'sales' %}
                                <small class="text-muted"><span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span></small>
                              {% else %}
                                <small class="text-muted"><span class="badge bg-secondary">-</span></small>
                              {% endif %}
                            {% endwith %}
                          {% else %}
                            <small class="text-muted">-</small>
                          {% endif %}
                        </td>
                        <td class="col-line-item-unit"><small class="text-muted">{{ item.unit|default:'-' }}</small></td>
                        <td class="col-line-item-qty" style="text-align: center;"><small class="fw-semibold">{{ item.quantity|floatformat:0 }}</small></td>
                        <td class="col-line-item-rate" style="text-align: right;"><small>{{ item.unit_price|floatformat:2 }}</small></td>
                        <td class="col-line-item-total" style="text-align: right;"><small><strong class="text-success">{{ item.line_total|floatformat:2 }}</strong></small></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Additional Invoices Section -->
            {% if order.invoice_links.all %}
            <div id="additionalInvoicesSection" class="row g-3 mb-4">
              <div class="col-12">
                <div class="mb-3">
                  <h6 class="text-muted mb-3"><i class="fa fa-file-invoice me-2"></i>Additional Invoices</h6>
                </div>
                <div id="additionalInvoicesList" class="additional-invoices-container">
                  {% for link in order.invoice_links.all %}
                    {% if not link.is_primary %}
                    <div class="row g-3 mb-4 additional-invoice-card" data-invoice-id="{{ link.invoice.id }}">
                      <div class="col-12">
                        <div class="p-3 border rounded bg-light-secondary">
                          <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                              <span class="badge bg-secondary">ADDITIONAL INVOICE</span>
                              <h6 class="mt-2 mb-1">{{ link.invoice.invoice_number }}</h6>
                              <small class="text-muted">{{ link.invoice.invoice_date|date:"d/m/Y" }}</small>
                            </div>
                            <div class="d-flex gap-2">
                              {% if link.invoice.document %}
                              <a href="{% url 'tracker:invoice_document_download' pk=link.invoice.id %}" class="btn btn-sm btn-outline-secondary" title="Download original invoice"><i class="fa fa-download"></i></a>
                              {% endif %}
                              <a href="{% url 'tracker:invoice_detail' pk=link.invoice.id %}" class="btn btn-sm btn-outline-secondary" title="View invoice details"><i class="fa fa-eye"></i></a>
                            </div>
                          </div>
                          <div class="row g-2 mt-3">
                            <div class="col-md-4" style="color: #6c757d;">
                              <small class="text-muted d-block">Subtotal (NET)</small>
                              <div class="fw-bold">{{ link.invoice.subtotal|floatformat:2|default:'-' }}</div>
                            </div>
                            <div class="col-md-4">
                              <small class="text-muted d-block">Tax/VAT</small>
                              <div class="fw-bold text-warning">{{ link.invoice.tax_amount|floatformat:2|default:'-' }}</div>
                            </div>
                            <div class="col-md-4">
                              <small class="text-muted d-block">Total Amount (GROSS)</small>
                              <div class="fw-bold text-success fs-5">{{ link.invoice.total_amount|floatformat:2 }}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    {% if link.invoice.line_items.all %}
                    <div class="row g-3 mb-4">
                      <div class="col-12">
                        <div class="mb-3">
                          <h6 class="text-muted mb-2"><i class="fa fa-list me-2"></i>Line Items - {{ link.invoice.invoice_number }}</h6>
                        </div>
                        <div class="table-responsive">
                          <table class="table table-sm table-hover mb-0 invoice-line-items-table" style="table-layout: fixed;">
                            <thead class="table-light">
                              <tr style="background-color: #f8f9fa;">
                                <th class="col-line-item-sr" style="width: 5%; text-align: center;">#</th>
                                <th class="col-line-item-code" style="width: 10%;">Code</th>
                                <th class="col-line-item-desc" style="width: 35%; word-break: break-word;">Description</th>
                                <th class="col-line-item-type" style="width: 10%;">Type</th>
                                <th class="col-line-item-unit" style="width: 8%;">Unit</th>
                                <th class="col-line-item-qty" style="width: 8%; text-align: center;">Qty</th>
                                <th class="col-line-item-rate" style="width: 11%; text-align: right;">Unit Price</th>
                                <th class="col-line-item-total" style="width: 9%; text-align: right;">Total</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for item in link.invoice.line_items.all %}
                              <tr>
                                <td class="col-line-item-sr" style="text-align: center;"><small class="fw-semibold">{{ forloop.counter }}</small></td>
                                <td class="col-line-item-code"><small class="text-muted">{{ item.code|default:'-' }}</small></td>
                                <td class="col-line-item-desc" style="word-break: break-word; white-space: normal; overflow-wrap: break-word;">
                                  <small class="text-dark">{{ item.description|default:'-' }}</small>
                                </td>
                                <td class="col-line-item-type" style="text-align: center;">
                                  {% if item.code %}
                                    {% with cat=line_item_categories|dict_get:item.code %}
                                      {% if cat and cat.order_type == 'labour' %}
                                        <small class="text-muted"><span class="badge bg-info"><i class="fa fa-tools me-1"></i>Labour</span></small>
                                      {% elif cat and cat.order_type == 'service' %}
                                        <small class="text-muted"><span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span></small>
                                      {% elif cat and cat.order_type == 'sales' %}
                                        <small class="text-muted"><span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span></small>
                                      {% else %}
                                        <small class="text-muted"><span class="badge bg-secondary">-</span></small>
                                      {% endif %}
                                    {% endwith %}
                                  {% else %}
                                    <small class="text-muted">-</small>
                                  {% endif %}
                                </td>
                                <td class="col-line-item-unit"><small class="text-muted">{{ item.unit|default:'-' }}</small></td>
                                <td class="col-line-item-qty" style="text-align: center;"><small class="fw-semibold">{{ item.quantity|floatformat:0 }}</small></td>
                                <td class="col-line-item-rate" style="text-align: right;"><small>{{ item.unit_price|floatformat:2 }}</small></td>
                                <td class="col-line-item-total" style="text-align: right;"><small><strong class="text-success">{{ item.line_total|floatformat:2 }}</strong></small></td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                    {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endif %}
          {% else %}
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted"><i class="fa fa-info-circle me-2"></i>No invoices linked to this order yet.</div>
              <div class="btn-group btn-group-sm">
                <button type="button" id="orderUploadInvoiceBtn" class="btn btn-primary">
                  <i class="fa fa-file-upload me-1"></i>
                </button>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Order Details - Separated by Type -->
      {% if order.type == 'service' %}
      <div class="card shadow-sm mb-4 order-details-service">
        <div class="card-header bg-light d-flex align-items-center">
          <i class="fa fa-wrench me-2 text-primary"></i>
          <h6 class="mb-0">Service Order Details</h6>
          <span class="badge bg-primary rounded-pill ms-2">SERVICE</span>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted"><i class="fa fa-clipboard me-2"></i>Description</label>
                <div class="p-3 border rounded" style="background-color: #f8f9fa;">{{ order.description|default:"No description provided" }}</div>
              </div>
            </div>
            {% if order.vehicle %}
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted"><i class="fa fa-car me-2"></i>Vehicle Information</label>
                <div class="p-3 border rounded" style="background-color: #f8f9fa;">
                  <div class="row">
                    <div class="col-md-3">
                      <small class="text-muted d-block">Plate Number</small>
                      <div class="fw-medium">{{ order.vehicle.plate_number|default:'-' }}</div>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted d-block">Type</small>
                      <div class="fw-medium">{{ order.vehicle.vehicle_type|default:'-' }}</div>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted d-block">Make</small>
                      <div class="fw-medium">{{ order.vehicle.make|default:'-' }}</div>
                    </div>
                    <div class="col-md-3">
                      <small class="text-muted d-block">Model</small>
                      <div class="fw-medium">{{ order.vehicle.model|default:'-' }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% elif order.type == 'labour' %}
      <div class="card shadow-sm mb-4 order-details-labour">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <i class="fa fa-tools fa-lg me-2"></i>
            <h6 class="mb-0">Labour Details</h6>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Description</h6>
              <p class="mb-3">{{ order.description|default:"No description provided" }}</p>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted mb-2">Status</h6>
              <p class="mb-3">
                {% if order.status == 'created' %}
                  <span class="badge bg-secondary"><i class="fa fa-circle-o me-1"></i>Started</span>
                {% elif order.status == 'in_progress' %}
                  <span class="badge bg-warning text-dark"><i class="fa fa-clock me-1"></i>In Progress</span>
                {% elif order.status == 'completed' %}
                  <span class="badge bg-success"><i class="fa fa-check me-1"></i>Completed</span>
                {% else %}
                  <span class="badge bg-secondary">{{ order.status|title }}</span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>
      {% elif order.type == 'sales' %}
      
      {% elif order.type == 'inquiry' %}
      <div class="card shadow-sm mb-4 order-details-inquiry">
        <div class="card-header bg-light d-flex align-items-center">
          <i class="fa fa-question-circle me-2 text-info"></i>
          <h6 class="mb-0">Inquiry Order Details</h6>
          <span class="badge bg-info rounded-pill ms-2">INQUIRY</span>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted"><i class="fa fa-list-alt me-2"></i>Inquiry Type</label>
                <div class="p-3 border rounded" style="background-color: #f8f9fa;">{{ order.inquiry_type|default:"-" }}</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted"><i class="fa fa-comments me-2"></i>Contact Preference</label>
                <div class="p-3 border rounded" style="background-color: #f8f9fa;">{{ order.contact_preference|default:"-" }}</div>
              </div>
            </div>
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted"><i class="fa fa-comment-o me-2"></i>Questions / Details</label>
                <div class="p-3 border rounded" style="background-color: #f8f9fa;">{{ order.questions|default:"No further details provided" }}</div>
              </div>
            </div>
            {% if order.description %}
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label fw-medium text-muted"><i class="fa fa-sticky-note-o me-2"></i>Additional Notes</label>
                <div class="p-3 border rounded" style="background-color: #f8f9fa;">{{ order.description }}</div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
      {% if order.cancellation_reason %}
      <div class="card shadow-sm mb-4 border border-danger">
        <div class="card-header bg-danger bg-opacity-10">
          <h6 class="mb-0"><i class="fa fa-exclamation-circle me-2 text-danger"></i>Cancellation Reason</h6>
        </div>
        <div class="card-body">
          <div class="p-3 bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded">{{ order.cancellation_reason }}</div>
        </div>
      </div>
      {% endif %}

      <!-- Multiple Order Types Section -->
      {% if order.type != 'inquiry' %}
      <div class="card shadow-sm mb-4 order-components-card" style="background-color: #f0f8ff; border: 2px solid #0d6efd;">
        <div class="card-header bg-gradient-info text-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fa fa-layer-group me-2"></i>Additional Items & Services</h6>
          {% if order.status != 'cancelled' %}
          <div class="btn-group btn-group-sm" role="group">

            <button type="button" class="btn btn-warning fw-bold text-dark" id="uploadAdditionalInvoiceBtn" data-bs-toggle="modal" data-bs-target="#uploadAdditionalInvoiceModal" style="background-color: #FFB300; border: none; padding: 0.6rem 1.2rem; font-size: 0.95rem; box-shadow: 0 2px 8px rgba(255, 179, 0, 0.4);">
              <i class="fa fa-file-upload me-1"></i>Upload Invoice
            </button>
          </div>
          {% endif %}
        </div>
        <div class="card-body" style="background-color: #f0f8ff;">
          {% if order.components.exists %}
          <div class="components-and-invoices-list">
            <!-- Order Components -->
            {% if order.components.exists %}
            <div class="components-section mb-4">
              <h6 class="text-muted mb-3"><i class="fa fa-cubes me-2"></i>Added Components</h6>
              {% for component in order.components.all %}
              <div class="component-item mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                      {% if component.type == 'service' %}
                        <i class="fa fa-wrench text-primary me-2"></i>
                        <span class="badge bg-primary">SERVICE</span>
                      {% elif component.type == 'sales' %}
                        <i class="fa fa-shopping-cart text-success me-2"></i>
                        <span class="badge bg-success">SALES</span>
                      {% endif %}
                      <small class="text-muted ms-2">Added {{ component.added_at|localtime|date:"M j, Y g:i a" }}</small>
                    </div>
                    {% if component.reason %}
                    <div class="mt-2">
                      <small class="text-muted d-block"><strong>Reason:</strong></small>
                      <p class="mb-0 text-dark">{{ component.reason }}</p>
                    </div>
                    {% endif %}
                    {% if component.invoice %}
                    <div class="mt-2">
                      <small class="text-muted d-block"><strong>Invoice:</strong></small>
                      <div class="d-flex align-items-center gap-2">
                        <i class="fa fa-file-pdf text-danger"></i>
                        <a href="{% url 'tracker:invoice_detail' pk=component.invoice.id %}" class="text-decoration-none fw-medium">
                          {{ component.invoice.invoice_number }}
                        </a>
                        <span class="badge bg-secondary">{{ component.invoice.total_amount|floatformat:2 }}</span>
                      </div>
                    </div>
                    {% endif %}
                  </div>
                  <div class="component-actions">
                    {% if component.signed_at %}
                    <span class="badge bg-success"><i class="fa fa-check me-1"></i>Signed</span>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            
          </div>
          {% else %}
          <div class="text-muted text-center py-4">
            <i class="fa fa-cube fa-2x opacity-50 mb-2"></i>
            <p class="mb-2">No additional items or services added yet.</p>
            <small>Use the "Add Item/Service" button to include more items with this order.</small>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}


      <!-- Enhanced Attachments & Signatures Section -->
      <div class="card shadow-sm mb-4 attachments-card">
        <!-- <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0"><i class="fa fa-paperclip me-2"></i>Documents & Signatures</h6>
          {% if order.status != 'completed' and order.status != 'cancelled' and order.type != 'inquiry' %}
          <div class="document-actions">
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#attachmentModal">
              <i class="fa fa-plus me-1"></i>Add Files
            </button>
            <button type="button" class="btn btn-sm btn-success complete-order-trigger" data-bs-toggle="modal" data-bs-target="#completeModal">
              <i class="fa fa-pen me-1"></i>Capture Signature
            </button>
          </div>
          {% endif %}
        </div> -->
        <div class="card-body">
          {% if order.status != 'completed' and order.status != 'cancelled' and order.type != 'inquiry' %}
          <div class="document-workflow-alert alert alert-info">
            <div class="d-flex align-items-center">
              <i class="fa fa-info-circle fa-lg me-3"></i>
              <div>
                <strong>Document Workflow:</strong> Upload supporting files first, then capture the customer's signature when they are ready to leave. The signature process will complete the order.
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Document Categories -->
          <div class="document-categories mb-4">
            <div class="row g-3">
              <!-- Supporting Documents -->
              <div class="col-md-4">
                <div class="document-category-card">
                  <div class="category-header">
                    <i class="fa fa-files-o text-primary"></i>
                    <span class="category-title">Supporting Documents</span>
                    <span class="document-count">{{ order.attachments.all|length }}</span>
                  </div>
                  <div class="category-description">
                    Upload receipts, photos, or additional files
                  </div>
                  {% if order.status != 'cancelled' and order.type != 'inquiry' %}
                  <button type="button" class="btn btn-sm btn-outline-primary w-100 mt-2" data-bs-toggle="modal" data-bs-target="#attachmentModal">
                    <i class="fa fa-upload me-1"></i>Upload Files
                  </button>
                  {% endif %}
                </div>
              </div>

              <!-- Completion Document -->
              <div class="col-md-4">
                <div class="document-category-card {% if not order.completion_attachment %}category-pending{% endif %}">
                  <div class="category-header">
                    <i class="fa fa-file-text-o text-info"></i>
                    <span class="category-title">Completion Document</span>
                    <span class="document-status">
                      {% if order.completion_attachment %}
                        <i class="fa fa-check text-success"></i>
                      {% else %}
                        <i class="fa fa-clock text-warning"></i>
                      {% endif %}
                    </span>
                  </div>
                  <div class="category-description">
                    Final document for customer signature
                  </div>
                  {% if order.completion_attachment %}
                  <div class="document-actions-stacked mt-2">
                    <a href="{{ order.completion_attachment.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                      <i class="fa fa-eye me-1"></i>View
                    </a>
                    <a href="{{ order.completion_attachment.url }}" download class="btn btn-sm btn-outline-secondary">
                      <i class="fa fa-download me-1"></i>Download
                    </a>
                  </div>
                  {% elif order.status != 'completed' and order.status != 'cancelled' and order.type != 'inquiry' %}
                  <button type="button" class="btn btn-sm btn-outline-info w-100 mt-2 complete-order-trigger" data-bs-toggle="modal" data-bs-target="#completeModal">
                    <i class="fa fa-plus me-1"></i>Add Document
                  </button>
                  {% endif %}
                </div>
              </div>

              <!-- Digital Signature -->
              <div class="col-md-4">
                <div class="document-category-card {% if not order.signature_file %}category-pending{% endif %}">
                  <div class="category-header">
                    <i class="fa fa-signature text-success"></i>
                    <span class="category-title">Digital Signature</span>
                    <span class="document-status">
                      {% if order.signature_file %}
                        <i class="fa fa-check text-success"></i>
                      {% else %}
                        <i class="fa fa-clock text-warning"></i>
                      {% endif %}
                    </span>
                  </div>
                  <div class="category-description">
                    Customer signature capture
                  </div>
                  {% if order.signature_file %}
                  <div class="document-actions-stacked mt-2">
                    <a href="{{ order.signature_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                      <i class="fa fa-eye me-1"></i>View
                    </a>
                  </div>
                  {% elif order.status != 'completed' and order.status != 'cancelled' and order.type != 'inquiry' %}
                  <button type="button" class="btn btn-sm btn-success w-100 mt-2 complete-order-trigger" data-bs-toggle="modal" data-bs-target="#completeModal">
                    <i class="fa fa-pen me-1"></i>Capture Signature
                  </button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

     
        

          {% if order.attachments.all %}
          <div class="mt-3">
            <h6 class="mb-2"><i class="fa fa-paperclip me-2"></i>Supporting Documents</h6>
            <div class="table-responsive">
              <table class="table table-hover attachments-table align-middle">
                <thead class="table-light">
                  <tr>
                    <th>File</th>
                    <th>Uploaded</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for att in order.attachments.all %}
                  {% with name=att.filename|default:att.file.name url=att.file.url %}
                  <tr>
                    <td>
                      <i class="fa fa-file-text-o me-2 text-muted"></i>
                      <a href="{{ url }}" target="_blank" class="text-decoration-none">{{ name }}</a>
                      {% if att.signature %}
                      <span class="badge bg-success ms-2"><i class="fa fa-check me-1"></i>Signed</span>
                      {% endif %}
                    </td>
                    <td><small class="text-muted">{{ att.uploaded_at|localtime|date_medium }}</small></td>
                    <td class="text-end action-buttons-compact">
                      <a href="{{ url }}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa fa-eye me-1"></i>View</a>
                      {% if att.signature %}
                      <a href="{{ att.signature.signed_file.url }}" download class="btn btn-sm btn-outline-secondary"><i class="fa fa-download me-1"></i>Download Signed</a>
                      {% else %}
                      <a href="{{ url }}" download class="btn btn-sm btn-outline-secondary"><i class="fa fa-download me-1"></i>Download</a>
                      {% endif %}
                      {% if order.status == 'completed' and not att.signature and order.type != 'inquiry' %}
                      <button type="button" class="btn btn-sm btn-info supporting-doc-sign-btn" data-file-url="{{ url }}" data-file-name="{{ name }}" data-attachment-id="{{ att.id }}" data-bs-toggle="modal" data-bs-target="#signSupportingDocsModal"><i class="fa fa-pen me-1"></i>Sign</button>
                      {% elif att.signature %}
                      <a href="{{ att.signature.signed_file.url }}" target="_blank" class="btn btn-sm btn-success"><i class="fa fa-file-contract me-1"></i>View Signed</a>
                      {% endif %}
                    </td>
                  </tr>
                  {% endwith %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endif %}

          <!-- Signed Document Preview -->
          {% if order.signature_file and order.completion_attachment %}
          <div class="signed-document-preview mt-4">
            <h6 class="mb-3"><i class="fa fa-file-contract me-2"></i>Signed Document</h6>
            <div class="border rounded overflow-hidden bg-light">
              {% with fname=order.completion_attachment.name|lower url=order.completion_attachment.url %}
                {% if '.jpg' in fname or '.jpeg' in fname or '.png' in fname or '.gif' in fname or '.webp' in fname %}
                  <div class="position-relative w-100">
                    <img src="{{ url }}" alt="Signed Document" class="w-100 h-auto completion-attachment-img" style="display:block; object-fit:contain; max-height: 600px;">
                  </div>
                {% elif fname and '.pdf' in fname %}
                  <div class="position-relative w-100">
                    <div class="pdf-embed-host w-100" data-pdf-url="{{ url }}" style="min-height: 500px; background: #f8f9fa;"></div>
                  </div>
                {% else %}
                  <div class="w-100 d-flex align-items-center justify-content-center p-4" style="min-height: 200px;">
                    <div class="text-center text-muted">
                      <i class="fa fa-file fa-3x mb-3"></i>
                      <p class="mb-2">Document: {{ order.completion_attachment.name }}</p>
                      <a href="{{ url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fa fa-download me-1"></i>Download Document
                      </a>
                    </div>
                  </div>
                {% endif %}
              {% endwith %}
            </div>
            <div class="mt-2 text-center text-muted small">
              <i class="fa fa-info-circle me-1"></i>
              Signed document (embedded signature) - Completed on {{ order.completion_date|date_medium }}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Attachments Upload Modal -->
{% if order.type != 'inquiry' %}
<div class="modal fade" id="attachmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content border-0 signature-modal-content shadow-lg">
      <div class="modal-header signature-modal-header bg-gradient-primary text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fa fa-cloud-upload-alt me-3 fa-lg"></i>
          <div>
            <h5 class="modal-title fw-bold mb-0">Upload Supporting Documents</h5>
            <small class="opacity-75">Add files to support this order (receipts, photos, invoices, etc.)</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" enctype="multipart/form-data" action="{% url 'tracker:add_order_attachments' pk=order.id %}">
        <div class="modal-body p-4 signature-modal-body">
          {% csrf_token %}
          <div class="row g-4">
            <div class="col-md-7">
              <label class="form-label fw-bold"><i class="fa fa-file me-2"></i>Select Files to Upload <span class="text-danger">*</span></label>
              <div class="border-2 rounded p-4 text-center bg-light" style="border-color: #dee2e6; border-style: dashed; cursor: pointer;" id="dropZone">
                <i class="fa fa-cloud-upload-alt fa-3x text-muted mb-3 d-block"></i>
                <p class="mb-2 fw-medium text-dark">Drag files here or click to select</p>
                <small class="text-muted d-block">Supported: PDF, Images (JPG, PNG, GIF), Documents (DOC, DOCX, XLS, XLSX), ZIP</small>
              </div>
              <input type="file" class="form-control d-none" name="attachments" id="attachmentsInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.zip">
              <div id="selectedFiles" class="mt-3"></div>
            </div>
            <div class="col-md-5">
              <label class="form-label fw-bold"><i class="fa fa-eye me-2"></i>Preview</label>
              <div class="border rounded p-3 bg-light" style="min-height: 300px; max-height: 400px; overflow-y: auto;">
                <div id="filePreviewContainer" class="text-center text-muted">
                  <i class="fa fa-images fa-3x mb-3 d-block opacity-50"></i>
                  <small>Selected files will appear here</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light border-top signature-modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary fw-bold" id="uploadFilesBtn" disabled>
            <i class="fa fa-upload me-2"></i>Upload Files
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Capture Signature Modal - Enhanced -->
<div class="modal fade" id="completeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg signature-modal-container">
    <div class="modal-content border-0 signature-modal-content shadow-lg">
      <div class="modal-header signature-modal-header bg-gradient-success text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fa fa-pen-fancy me-3 fa-lg"></i>
          <div>
            <h5 class="modal-title fw-bold mb-0">Complete Order & Capture Signature</h5>
            <small class="opacity-75">Select a document and capture customer signature</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 signature-modal-body">
        <form method="post" enctype="multipart/form-data" action="{% url 'tracker:complete_order' pk=order.id %}" id="completeForm">
          {% csrf_token %}
          <input type="hidden" name="signature_data" id="signatureDataInput">
          <input type="hidden" name="overrun_reason" id="completeOverrunHidden" value="{{ order.overrun_reason|default:''|escape }}">
          <input type="hidden" name="selected_document" id="selectedDocumentInput">

          <!-- Tab Navigation -->
          <div class="border-bottom px-4 pt-4">
            <ul class="nav nav-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="documentTab" data-bs-toggle="tab" data-bs-target="#documentSection" type="button" role="tab" aria-controls="documentSection" aria-selected="true">
                  <i class="fa fa-file-contract me-2"></i>Select Document
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="signatureTab" data-bs-toggle="tab" data-bs-target="#signatureSection" type="button" role="tab" aria-controls="signatureSection" aria-selected="false">
                  <i class="fa fa-signature me-2"></i>Capture Signature
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="detailsTab" data-bs-toggle="tab" data-bs-target="#detailsSection" type="button" role="tab" aria-controls="detailsSection" aria-selected="false">
                  <i class="fa fa-info-circle me-2"></i>Details
                </button>
              </li>
            </ul>
          </div>

          <!-- Tab Content -->
          <div class="tab-content p-4">
            <!-- Document Selection Tab -->
            <div class="tab-pane fade show active" id="documentSection" role="tabpanel">
              <div class="mb-4">
                <div class="alert alert-primary bg-primary bg-opacity-10 border-primary mb-4">
                  <i class="fa fa-info-circle me-2"></i>
                  <strong>Select a document to sign:</strong> Use the completion document or upload a new one. The selected document will be displayed below.
                </div>

                {% if order.completion_attachment %}
                <div class="mb-4">
                  <h6 class="text-muted mb-3"><i class="fa fa-file text-success me-1"></i>Available Documents</h6>
                  <div class="document-list-selection">
                    <div class="document-selection-item mb-2">
                      <div class="form-check">
                        <input class="form-check-input doc-selector" type="radio" name="document_choice" id="doc-completion" value="completion" data-doc-name="Completion Document" data-doc-type="completion">
                        <label class="form-check-label w-100 flex-grow-1" for="doc-completion">
                          <div class="d-flex align-items-center justify-content-between w-100">
                            <div class="d-flex align-items-center flex-grow-1">
                              <div class="doc-selector-icon">
                                <i class="fa fa-file-contract"></i>
                              </div>
                              <div>
                                <div class="fw-semibold">Completion Document</div>
                                <small class="text-muted d-block">Final document for completion & signature</small>
                              </div>
                            </div>
                            <span class="badge bg-success">Completion</span>
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- New Document Upload -->
                <div class="upload-new-document-section">
                  <h6 class="text-muted mb-3"><i class="fa fa-cloud-upload-alt me-2 text-warning"></i>Upload a New Document</h6>
                  <div class="mb-3">
                    <div class="upload-document-input-wrapper">
                      <input type="file" id="attachmentInput" name="completion_attachment" class="form-control form-control-lg" accept="image/*,.pdf" data-doc-name="Newly uploaded document">
                      <small class="text-muted d-block mt-2">Supported formats: PDF, PNG, JPG, JPEG</small>
                    </div>
                  </div>
                </div>

                <!-- Selected Document Summary -->
                <div id="selectedDocInfo" class="mt-4" style="display: none;">
                  <div class="selected-document-summary">
                    <div class="summary-header">
                      <i class="fa fa-check-circle text-success me-2"></i>
                      <strong>Document Selected</strong>
                    </div>
                    <div class="summary-content">
                      <div class="d-flex align-items-center gap-2">
                        <i class="fa fa-file-alt text-primary fa-lg"></i>
                        <div>
                          <div class="fw-semibold text-dark" id="selectedDocName"></div>
                          <small class="text-muted">This document will be signed in the next step</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Signature Capture Tab -->
            <div class="tab-pane fade" id="signatureSection" role="tabpanel">
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <label class="form-label fw-bold text-dark mb-0">
                    <i class="fa fa-pen me-2 text-success"></i>Draw Customer Signature <span class="text-danger">*</span>
                  </label>
                  <small class="text-muted">Use mouse or touch to draw</small>
                </div>
                <!-- Signature Pad - Styled to match completion document -->
                <div id="docSignContainer" class="signature-canvas-container position-relative overflow-hidden bg-white border-2 rounded d-flex align-items-center justify-content-center" style="height: 280px; border-color: #dee2e6; border-style: solid; cursor: crosshair; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);">
                  <div id="docPreviewHost" class="w-100 h-100 d-flex align-items-center justify-content-center text-muted">
                    <div class="text-center pointer-events-none">
                      <i class="fa fa-pen-fancy fa-3x mb-3 text-muted opacity-25"></i>
                      <p class="mb-1 fw-medium">Click and draw signature</p>
                      <small class="text-muted">Use your mouse or touchpad</small>
                    </div>
                  </div>
                  <canvas id="signaturePad" class="position-absolute top-0 start-0 w-100 h-100" style="cursor: crosshair; z-index: 2; display: none;"></canvas>
                </div>
                <div class="d-flex gap-2 mt-3 align-items-center flex-wrap justify-content-between">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clearSignatureBtn" style="display: none;">
                    <i class="fa fa-eraser me-1"></i>Clear Signature
                  </button>
                  <div id="signaturePreviewSmall" class="d-flex align-items-center gap-2" style="display: none;">
                    <small class="text-muted fw-medium">Signature Preview:</small>
                    <div class="border rounded" style="padding: 4px; background: white;">
                      <canvas id="signaturePreviewMini" width="140" height="70" style="border: 1px solid #e9ecef; border-radius: 4px; background: white; display: block;"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Details Tab -->
            <div class="tab-pane fade" id="detailsSection" role="tabpanel">
              <!-- Order Duration -->
              {% if order.estimated_duration %}
              <div class="mb-4">
                <label class="form-label fw-bold text-dark mb-2">
                  <i class="fa fa-hourglass me-2 text-warning"></i>Order Duration
                </label>
                <div class="row g-2">
                  <div class="col-6">
                    <div class="p-3 bg-light border rounded">
                      <small class="text-muted d-block">Estimated</small>
                      <div class="fw-medium text-dark">{{ order.estimated_duration }} minutes</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="p-3 bg-light border rounded">
                      <small class="text-muted d-block">Actual</small>
                      <div class="fw-medium text-dark" id="actualDurationDisplay">Calculating...</div>
                    </div>
                  </div>
                </div>
              </div>
              {% endif %}

              <!-- Delay Reason - Free Text Input -->
              <div class="mb-3" id="delayReasonSection">
                <label class="form-label fw-bold text-dark mb-2">
                  <i class="fa fa-comment-dots me-2 text-info"></i>Reason for Delay <small class="fw-normal text-muted">(optional)</small>
                </label>

                <textarea id="delayReasonText" name="delay_reason_text" class="form-control form-control-sm" rows="3"></textarea>

                <small class="text-muted d-block mt-2">
                  <i class="fa fa-info-circle me-1"></i>Provide any relevant details about delays if the order took longer than expected.
                </small>
              </div>
            </div>
          </div>
      </div>
      <div class="modal-footer bg-light border-top signature-modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success fw-bold" id="footerSignAndComplete">
          <i class="fa fa-check-circle me-2"></i>Complete Order
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overrun modal for signature flow -->
<div class="modal fade" id="completeOverrunModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-gradient-warning text-dark border-0">
        <h5 class="modal-title fw-bold"><i class="fa fa-exclamation-triangle me-2"></i>Order Took Longer - Add Reason</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="alert alert-warning border-0 bg-warning bg-opacity-10 mb-3">
          <i class="fa fa-clock me-2"></i>
          <strong>This order exceeded its estimated duration.</strong> Please provide a reason before completing.
        </div>
        <div class="mb-0">
          <label class="form-label fw-semibold">What caused the delay?</label>
          <textarea id="completeOverrunReason" class="form-control" rows="4" placeholder="e.g., Additional repairs discovered, customer delayed arrival, supply shortage, technical issues..."></textarea>
          <div id="completeOverrunError" class="text-danger mt-2" style="display:none;"></div>
        </div>
      </div>
      <div class="modal-footer bg-light border-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="completeOverrunSave" class="btn btn-warning fw-semibold">
          <i class="fa fa-arrow-right me-1"></i>Continue to Signature
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const footerBtn = document.getElementById('footerSignAndComplete');
  const signAndCompleteBtn = document.getElementById('signAndCompleteBtn');
  const completeForm = document.getElementById('completeForm');
  const hiddenOverrun = document.getElementById('completeOverrunHidden');
  const overrunModalEl = document.getElementById('completeOverrunModal');
  const overrunModal = overrunModalEl ? new bootstrap.Modal(overrunModalEl) : null;
  const overrunTextarea = document.getElementById('completeOverrunReason');
  const overrunError = document.getElementById('completeOverrunError');
  const completeModalEl = document.getElementById('completeModal');

  const startedAtStr = '{{ order.started_at|date:"c" }}';
  const estimatedDuration = {{ order.estimated_duration|default:'null' }};
  const orderType = '{{ order.type }}';

  function needsOverrun(){
    if ((orderType !== 'service' && orderType !== 'sales') || !estimatedDuration) return false;
    if (!startedAtStr) return false;
    try{
      const started = new Date(startedAtStr);
      const now = new Date();
      const elapsed = Math.floor((now - started)/60000);
      return elapsed > Number(estimatedDuration);
    }catch(e){ return false; }
  }

  // Initialize when the signature/completion modal opens
  const completionModalEl = document.getElementById('completeModal');
  if (completionModalEl) {
    completionModalEl.addEventListener('shown.bs.modal', function() {
      // Re-initialize delay reason fields when modal is shown
      if (typeof initializeDelayReasonFields === 'function') {
        initializeDelayReasonFields();
      }
    });
  }

  function openSignatureModal(){
    if (overrunModal) {
      const instance = bootstrap.Modal.getInstance(overrunModalEl);
      if (instance) instance.hide();
    }
    if (completeModalEl) {
      new bootstrap.Modal(completeModalEl).show();
    }
  }

  function ensureAndSubmit(){
    // Capture the reason from signature modal if provided
    const reasonField = document.getElementById('signatureReasonField');
    if (reasonField && reasonField.value) {
      if (hiddenOverrun) hiddenOverrun.value = reasonField.value;
    }

    if (!needsOverrun()){
      completeForm.submit();
      return;
    }
    // if order already has overrun reason on server, hiddenOverrun may be set via template; check it
    if (hiddenOverrun && hiddenOverrun.value) { completeForm.submit(); return; }
    // Close the signature modal first
    if (completeModalEl) {
      const modal = bootstrap.Modal.getInstance(completeModalEl);
      if (modal) modal.hide();
    }
    // Show overrun modal
    if (overrunModal) overrunModal.show();
  }

  function openCompleteFlow(){
    openSignatureModal();
  }

  // Attach handlers to complete-order-trigger buttons (from document)
  document.querySelectorAll('.complete-order-trigger').forEach(function(btn){
    btn.addEventListener('click', openCompleteFlow);
  });

  // Attach handlers to buttons inside signature modal
  const exceeds9HoursCheck = {{ exceeds_9_hours|lower }};
  const delayReasonDropdownRef = document.getElementById('delayReasonDropdown');

  function handleFooterButtonClick(e) {
    e.preventDefault();

    // Re-initialize delay reason fields before validation
    if (typeof initializeDelayReasonFields === 'function') {
      initializeDelayReasonFields();
    }

    // Check if delay reason is required and validate
    const delayReasonText = document.getElementById('delayReasonText');
    if (exceeds9HoursCheck && delayReasonDropdownRef) {
      const selectedReason = delayReasonDropdownRef.value;
      if (!selectedReason) {
        // Switch to details tab to show the delay reason field
        const detailsTab = document.getElementById('detailsTab');
        if (detailsTab) detailsTab.click();
        alert('Order has exceeded 9 working hours. Please select a delay reason before completing.');
        return false;
      }
    }

    ensureAndSubmit();
  }

  if (footerBtn) footerBtn.addEventListener('click', handleFooterButtonClick);
  if (signAndCompleteBtn) signAndCompleteBtn.addEventListener('click', handleFooterButtonClick);

  if (overrunModal && document.getElementById('completeOverrunSave')){
    document.getElementById('completeOverrunSave').addEventListener('click', function(){
      const v = (overrunTextarea.value||'').trim();
      overrunError.style.display = 'none';
      if (!v){ overrunError.textContent = 'Please provide a reason for the delay.'; overrunError.style.display = ''; return; }
      // Set hidden input
      if (hiddenOverrun) hiddenOverrun.value = v;
      // Persist via AJAX to API
      fetch('{% url "tracker:api_report_overrun" order_id=order.id %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken() || '',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ reason: v })
      }).finally(() => {
        if (overrunModal) overrunModal.hide();
        // Open signature modal after reason is saved
        openSignatureModal();
      });
    });
  }
})();
</script>

<!-- Delay Reason Dropdown Handler -->
<script>
(function(){
  const exceeds9Hours = {{ exceeds_9_hours|lower }};

  // Build delay reasons from Django context with fallback
  const delayReasonsByCategoryJson = {};
  try {
    {% for category, reasons in delay_reasons_by_category.items %}
      delayReasonsByCategoryJson['{{ category }}'] = [
        {% for reason in reasons %}
          { id: {{ reason.id }}, reason_text: '{{ reason.reason_text|escapejs }}' },
        {% endfor %}
      ];
    {% endfor %}
  } catch(e) {
    console.warn('Failed to load delay reasons:', e);
  }

  // Fallback delay reasons if database is not initialized
  if (Object.keys(delayReasonsByCategoryJson).length === 0) {
    delayReasonsByCategoryJson['parts'] = [
      { id: 1, reason_text: 'Spare parts out of stock' },
      { id: 2, reason_text: 'Incorrect part delivered or mismatch with vehicle model' },
      { id: 3, reason_text: 'Delayed parts shipment from supplier' },
      { id: 4, reason_text: 'Need for special-order parts (rare or imported)' },
    ];
    delayReasonsByCategoryJson['technical'] = [
      { id: 5, reason_text: 'Unexpected faults discovered during routine service' },
      { id: 6, reason_text: 'Complex diagnostics needed (electrical issues, sensor faults, ECU problems)' },
      { id: 7, reason_text: 'Need for specialist technician to inspect certain problems' },
      { id: 8, reason_text: 'Software updates or reprogramming taking longer' },
    ];
    delayReasonsByCategoryJson['workload'] = [
      { id: 9, reason_text: 'High number of vehicles in queue' },
      { id: 10, reason_text: 'Insufficient technicians available (leave, training, or peak hours)' },
      { id: 11, reason_text: 'Workshop overload due to special promotions or seasonal rush' },
      { id: 12, reason_text: 'Equipment or service bay not available' },
    ];
    delayReasonsByCategoryJson['customer'] = [
      { id: 13, reason_text: 'Customer delayed approval for additional repairs or parts' },
      { id: 14, reason_text: 'Inaccurate information provided about the issue' },
      { id: 15, reason_text: 'Late vehicle drop-off vs. scheduled time' },
    ];
    delayReasonsByCategoryJson['administrative'] = [
      { id: 16, reason_text: 'POS system or billing delays' },
      { id: 17, reason_text: 'Job order not updated correctly' },
      { id: 18, reason_text: 'Miscommunication between front desk and workshop' },
      { id: 19, reason_text: 'Warranty validation delays' },
    ];
    delayReasonsByCategoryJson['quality'] = [
      { id: 20, reason_text: 'Extended road testing required' },
      { id: 21, reason_text: 'Rechecking after repair for safety or accuracy' },
      { id: 22, reason_text: 'Final inspection backlog' },
    ];
    delayReasonsByCategoryJson['external'] = [
      { id: 23, reason_text: 'Power outage' },
      { id: 24, reason_text: 'Bad weather affecting testing (e.g., rain for brake tests)' },
      { id: 25, reason_text: 'Transport limitations (for outsourced tasks like painting)' },
    ];
  }

  // Simple delay reason textarea handling (optional field)
  // Delay reason is now a free text input field stored in delay_reason_text POST parameter
  // The field is optional and will be saved as overrun_reason on the server side
})();
</script>

<!-- Sign Existing Document Modal -->
<div class="modal fade" id="signExistingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg signature-modal-container">
    <div class="modal-content border-0 signature-modal-content shadow-lg">
      <div class="modal-header signature-modal-header bg-gradient-success text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fa fa-pen-fancy me-3 fa-lg"></i>
          <div>
            <h5 class="modal-title fw-bold mb-0">Sign Document</h5>
            <small class="opacity-75">Sign supporting documents to complete</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 signature-modal-body">
        <form method="post" enctype="multipart/form-data" action="{% url 'tracker:sign_existing_document' pk=order.id %}" id="signExistingForm">
          {% csrf_token %}
          <input type="hidden" name="signature_data" id="signExistingSignatureData">
          <input type="hidden" name="attachment_id" id="signExistingAttachmentId">
          <input type="hidden" name="file_name" id="signExistingFileName">

          <div class="border-bottom px-4 pt-4">
            <ul class="nav nav-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="existingDocumentTab" data-bs-toggle="tab" data-bs-target="#existingDocumentSection" type="button" role="tab" aria-controls="existingDocumentSection" aria-selected="true">
                  <i class="fa fa-file me-2"></i>Document
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="existingSignatureTab" data-bs-toggle="tab" data-bs-target="#existingSignatureSection" type="button" role="tab" aria-controls="existingSignatureSection" aria-selected="false">
                  <i class="fa fa-signature me-2"></i>Signature
                </button>
              </li>
            </ul>
          </div>

          <div class="tab-content p-4">
            <!-- Document Selection Tab -->
            <div class="tab-pane fade show active" id="existingDocumentSection" role="tabpanel">
              <div class="alert alert-info bg-info bg-opacity-10 border-info mb-4">
                <i class="fa fa-info-circle me-2"></i>
                <strong>Document will be preserved:</strong> A signed copy will be created. The original document remains unchanged.
              </div>

              {% if order.attachments.all %}
              <div class="mb-4">
                <h6 class="text-muted mb-3"><i class="fa fa-file-pdf me-2 text-danger"></i>Available Documents</h6>
                <div class="document-list-selection">
                  {% for att in order.attachments.all %}
                  <div class="document-selection-item mb-2">
                    <div class="form-check">
                      <input class="form-check-input existing-doc-selector" type="radio" name="existing_doc_choice" id="existing-doc-{{ att.id }}" value="attachment-{{ att.id }}" data-doc-name="{{ att.filename|default:att.file.name }}" data-doc-url="{{ att.file.url }}" data-attachment-id="{{ att.id }}">
                      <label class="form-check-label w-100 flex-grow-1" for="existing-doc-{{ att.id }}">
                        <div class="d-flex align-items-center justify-content-between w-100">
                          <div class="d-flex align-items-center flex-grow-1">
                            <div class="doc-selector-icon">
                              <i class="fa fa-file-pdf"></i>
                            </div>
                            <div>
                              <div class="fw-semibold">{{ att.filename|default:att.file.name }}</div>
                              <small class="text-muted d-block">Uploaded {{ att.uploaded_at|localtime|date:"M j, Y g:i a" }}</small>
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
              {% endif %}

              <div id="existingSelectedDocInfo" class="mt-4" style="display: none;">
                <div class="selected-document-summary">
                  <div class="summary-header">
                    <i class="fa fa-check-circle text-success me-2"></i>
                    <strong>Document Selected</strong>
                  </div>
                  <div class="summary-content">
                    <div class="d-flex align-items-center gap-2">
                      <i class="fa fa-file-alt text-primary fa-lg"></i>
                      <div>
                        <div class="fw-semibold text-dark" id="existingSelectedDocName"></div>
                        <small class="text-muted">Ready to sign</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div id="existingDocPreviewSection" class="mt-4" style="display: none;">
                <h6 class="mb-3"><i class="fa fa-eye me-2"></i>Document Preview</h6>
                <div class="border rounded overflow-hidden bg-light" style="max-height: 400px; overflow-y: auto;">
                  <div id="existingDocPreviewHost" class="w-100 d-flex align-items-center justify-content-center text-muted" style="min-height: 300px;">
                    <div class="text-center">
                      <i class="fa fa-file fa-3x mb-3 opacity-50"></i>
                      <p class="text-muted">Document preview</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Signature Capture Tab -->
            <div class="tab-pane fade" id="existingSignatureSection" role="tabpanel">
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <label class="form-label fw-bold text-dark mb-0">
                    <i class="fa fa-pen me-2 text-success"></i>Draw Customer Signature <span class="text-danger">*</span>
                  </label>
                  <small class="text-muted">Use mouse or touch to draw</small>
                </div>
                <div id="existingDocSignContainer" class="signature-canvas-container position-relative overflow-hidden bg-white border-2 rounded d-flex align-items-center justify-content-center" style="height: 280px; border-color: #dee2e6; border-style: solid; cursor: crosshair; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);">
                  <div id="existingDocSignPreviewHost" class="w-100 h-100 d-flex align-items-center justify-content-center text-muted">
                    <div class="text-center pointer-events-none">
                      <i class="fa fa-pen-fancy fa-3x mb-3 text-muted opacity-25"></i>
                      <p class="mb-1 fw-medium">Click and draw signature</p>
                      <small class="text-muted">Use your mouse or touchpad</small>
                    </div>
                  </div>
                  <canvas id="existingDocSignaturePad" class="position-absolute top-0 start-0 w-100 h-100" style="cursor: crosshair; z-index: 2; display: none;"></canvas>
                </div>
                <div class="d-flex gap-2 mt-3 align-items-center flex-wrap justify-content-between">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clearExistingSignatureBtn" style="display: none;">
                    <i class="fa fa-eraser me-1"></i>Clear Signature
                  </button>
                  <div id="existingSignaturePreviewSmall" class="d-flex align-items-center gap-2" style="display: none;">
                    <small class="text-muted fw-medium">Signature Preview:</small>
                    <div class="border rounded" style="padding: 4px; background: white;">
                      <canvas id="existingSignaturePreviewMini" width="140" height="70" style="border: 1px solid #e9ecef; border-radius: 4px; background: white; display: block;"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <button type="submit" id="signExistingDocBtn" style="display: none;">Sign</button>
        </form>
      </div>
      <div class="modal-footer bg-light border-top signature-modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success fw-bold" id="footerSignExistingDoc">
          <i class="fa fa-check-circle me-2"></i>Sign & Save Document
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Sign Supporting Documents Modal (Only after order is completed) -->
{% if order.status == 'completed' and order.attachments.all and order.type != 'inquiry' %}
<div class="modal fade" id="signSupportingDocsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg signature-modal-container">
    <div class="modal-content border-0 signature-modal-content shadow-lg">
      <div class="modal-header signature-modal-header bg-gradient-info text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fa fa-pen-fancy me-3 fa-lg"></i>
          <div>
            <h5 class="modal-title fw-bold mb-0">Sign Supporting Document</h5>
            <small class="opacity-75">Sign uploaded supporting documents with customer signature</small>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0 signature-modal-body">
        <div id="signSupportingDocsContent">
          <input type="hidden" id="supportingDocSignatureData">
          <input type="hidden" id="supportingDocAttachmentId">

          <div class="border-bottom px-4 pt-4">
            <ul class="nav nav-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="supportingDocSelectTab" data-bs-toggle="tab" data-bs-target="#supportingDocSelectSection" type="button" role="tab">
                  <i class="fa fa-file me-2"></i>Select Document
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="supportingDocSignTab" data-bs-toggle="tab" data-bs-target="#supportingDocSignSection" type="button" role="tab">
                  <i class="fa fa-signature me-2"></i>Signature
                </button>
              </li>
            </ul>
          </div>

          <div class="tab-content p-4">
            <!-- Document Selection Tab -->
            <div class="tab-pane fade show active" id="supportingDocSelectSection" role="tabpanel">
              <div class="alert alert-info bg-info bg-opacity-10 border-info mb-4">
                <i class="fa fa-info-circle me-2"></i>
                <strong>Document Signing:</strong> A signed copy will be created. The original document remains unchanged.
              </div>

              <h6 class="text-muted mb-3"><i class="fa fa-paperclip me-2"></i>Available Documents</h6>
              <div class="document-list-selection">
                {% for att in order.attachments.all %}
                {% if not att.signature %}
                <div class="document-selection-item mb-2">
                  <div class="form-check">
                    <input class="form-check-input supporting-doc-selector" type="radio" name="supporting_doc_choice" id="supporting-doc-{{ att.id }}" value="{{ att.id }}" data-doc-name="{{ att.filename|default:att.file.name }}" data-doc-url="{{ att.file.url }}" data-attachment-id="{{ att.id }}">
                    <label class="form-check-label w-100 flex-grow-1" for="supporting-doc-{{ att.id }}">
                      <div class="d-flex align-items-center justify-content-between w-100">
                        <div class="d-flex align-items-center flex-grow-1">
                          <div class="doc-selector-icon">
                            <i class="fa fa-file-pdf"></i>
                          </div>
                          <div>
                            <div class="fw-semibold">{{ att.filename|default:att.file.name }}</div>
                            <small class="text-muted d-block">Uploaded {{ att.uploaded_at|localtime|date:"M j, Y g:i a" }}</small>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
                {% endif %}
                {% endfor %}
              </div>

              <div id="supportingDocSelectedInfo" class="mt-4" style="display: none;">
                <div class="selected-document-summary">
                  <div class="summary-header">
                    <i class="fa fa-check-circle text-success me-2"></i>
                    <strong>Document Selected</strong>
                  </div>
                  <div class="summary-content">
                    <div class="d-flex align-items-center gap-2">
                      <i class="fa fa-file-alt text-primary fa-lg"></i>
                      <div>
                        <div class="fw-semibold text-dark" id="supportingDocSelectedName"></div>
                        <small class="text-muted">Ready to sign</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div id="supportingDocPreviewSection" class="mt-4" style="display: none;">
                <h6 class="mb-3"><i class="fa fa-eye me-2"></i>Document Preview</h6>
                <div class="border rounded overflow-hidden bg-light" style="max-height: 400px; overflow-y: auto;">
                  <div id="supportingDocPreviewHost" class="w-100 d-flex align-items-center justify-content-center text-muted" style="min-height: 300px;">
                    <div class="text-center">
                      <i class="fa fa-file fa-3x mb-3 opacity-50"></i>
                      <p class="text-muted">Document preview</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Signature Capture Tab -->
            <div class="tab-pane fade" id="supportingDocSignSection" role="tabpanel">
              <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <label class="form-label fw-bold text-dark mb-0">
                    <i class="fa fa-pen me-2 text-success"></i>Draw Customer Signature <span class="text-danger">*</span>
                  </label>
                  <small class="text-muted">Use mouse or touch to draw</small>
                </div>
                <div id="supportingDocSignContainer" class="signature-canvas-container position-relative overflow-hidden bg-white border-2 rounded d-flex align-items-center justify-content-center" style="height: 280px; border-color: #dee2e6; border-style: solid; cursor: crosshair; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);">
                  <div id="supportingDocSignPreviewHost" class="w-100 h-100 d-flex align-items-center justify-content-center text-muted">
                    <div class="text-center pointer-events-none">
                      <i class="fa fa-pen-fancy fa-3x mb-3 text-muted opacity-25"></i>
                      <p class="mb-1 fw-medium">Click and draw signature</p>
                      <small class="text-muted">Use your mouse or touchpad</small>
                    </div>
                  </div>
                  <canvas id="supportingDocSignaturePad" class="position-absolute top-0 start-0 w-100 h-100" style="cursor: crosshair; z-index: 2; display: none;"></canvas>
                </div>
                <div class="d-flex gap-2 mt-3 align-items-center flex-wrap justify-content-between">
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clearSupportingDocSignatureBtn" style="display: none;">
                    <i class="fa fa-eraser me-1"></i>Clear Signature
                  </button>
                  <div id="supportingDocSignaturePreviewSmall" class="d-flex align-items-center gap-2" style="display: none;">
                    <small class="text-muted fw-medium">Signature Preview:</small>
                    <div class="border rounded" style="padding: 4px; background: white;">
                      <canvas id="supportingDocSignaturePreviewMini" width="140" height="70" style="border: 1px solid #e9ecef; border-radius: 4px; background: white; display: block;"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light border-top signature-modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info fw-bold" id="footerSignSupportingDoc">
          <i class="fa fa-check-circle me-2"></i>Sign & Save Document
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Upload Additional Invoice Modal -->
<div class="modal fade" id="uploadAdditionalInvoiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title">
          <i class="fa fa-file-invoice me-2"></i>Upload & Extract Additional Invoice for Order {{ order.order_number }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="additionalInvoiceForm" method="post" action="{% url 'tracker:api_create_invoice_from_upload' %}">
        {% csrf_token %}
        <input type="hidden" name="selected_order_id" value="{{ order.id }}">
        {% if order.customer %}<input type="hidden" name="customer_id" value="{{ order.customer.id }}">{% endif %}

        <!-- Hidden fields for extracted data -->
        <div id="additionalInvoiceHiddenFields"></div>

        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
          <!-- Info Alert -->
          <div class="alert alert-info mb-3 border-0" role="alert">
            <div class="d-flex align-items-center">
              <i class="fa fa-lightbulb me-3" style="font-size: 18px;"></i>
              <div>
                <strong>Upload Additional Invoice PDF:</strong> Upload an invoice document to automatically extract data. All extracted data will be displayed below for review before adding to the order. Amounts are preserved exactly as extracted from the PDF without recalculation.
              </div>
            </div>
          </div>

          <!-- Upload Section -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-file-upload me-2"></i>Select PDF File</strong>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Invoice PDF File *</label>
                <input type="file" id="additionalInvoiceFile" class="form-control" accept=".pdf" data-max-file-size="50485760" required>
                <small class="text-muted">PDF files only. Maximum 50MB.</small>
              </div>

              <div id="additionalUploadError" class="alert alert-danger" style="display:none" role="alert"></div>
              <div id="additionalExtractionSuccess" class="alert alert-success" style="display:none" role="alert">
                <i class="fa fa-check-circle me-2"></i>Invoice data extracted successfully! Review the extracted information below.
              </div>
              <div id="additionalUploadProgress" class="progress" style="display:none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" id="additionalUploadProgressBar" role="progressbar" style="width: 0%"></div>
              </div>

              <button type="button" id="additionalUploadBtn" class="btn btn-primary">
                <i class="fa fa-upload me-2"></i>Upload & Extract
              </button>
            </div>
          </div>

          <!-- Extracted Data Preview -->
          <div id="additionalExtractedDataPreview" style="display:none;" class="card mb-3">
            <div class="card-header bg-light">
              <strong><i class="fa fa-check-circle me-2 text-success"></i>Extracted Information</strong>
              <small class="text-muted ms-2">Review before confirming</small>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
              <!-- Invoice Information -->
              <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="fa fa-file-invoice me-2"></i>Invoice Details</h6>
                <div class="row g-2">
                  <div class="col-md-6">
                    <small class="text-muted d-block">Invoice Number</small>
                    <p id="additionalPreviewInvoiceNumber" class="mb-2 fw-medium">-</p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Invoice Date</small>
                    <p id="additionalPreviewInvoiceDate" class="mb-2 fw-medium">-</p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Subtotal</small>
                    <p id="additionalPreviewSubtotal" class="mb-2 fw-medium">-</p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Tax/VAT</small>
                    <p id="additionalPreviewTax" class="mb-2 fw-medium">-</p>
                  </div>
                  <div class="col-md-6">
                    <small class="text-muted d-block">Total Amount</small>
                    <p id="additionalPreviewTotal" class="mb-2 fw-medium">-</p>
                  </div>
                </div>
              </div>

              <hr class="my-3">

              <!-- Extracted Line Items -->
              <div id="additionalExtractedLineItemsSection" class="card" style="display:none;">
                <div class="card-header bg-light">
                  <strong><i class="fa fa-list me-2"></i>Line Items</strong>
                  <small class="text-muted ms-2">Items from invoice</small>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0 extracted-line-items-table">
                      <thead class="table-light">
                        <tr style="background-color: #f8f9fa;">
                          <th style="width: 5%; text-align: center;">#</th>
                          <th style="width: 10%;">Code</th>
                          <th style="width: 32%; word-break: break-word;">Description</th>
                          <th style="width: 10%; text-align: center;">Type</th>
                          <th style="width: 10%;">Unit</th>
                          <th style="width: 8%; text-align: center;">Qty</th>
                          <th style="width: 12%; text-align: right;">Unit Price</th>
                          <th style="width: 13%; text-align: right;">Total</th>
                        </tr>
                      </thead>
                      <tbody id="additionalLineItemsBody" class="extracted-line-items-body"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 20px; background: #f8f9fa;">
          <div class="text-center w-100 mb-3">
            <p class="text-muted small mb-0">
              <i class="fa fa-info-circle me-1"></i>
              Upload an invoice PDF to extract data. Review the information and click "Add Invoice" to save and link it to this order.
            </p>
          </div>
          <div class="w-100 d-flex gap-2" style="margin-top: -15px;">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
              <i class="fa fa-times me-2"></i>Cancel
            </button>
            <button type="submit" class="btn btn-success btn-lg flex-grow-1" id="addAdditionalInvoiceBtn" style="font-weight: 600;" disabled>
              <i class="fa fa-check-circle me-2"></i>Add Invoice
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fa fa-times-circle me-2"></i>Cancel Order</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'tracker:cancel_order' pk=order.id %}" id="cancelForm">
        <div class="modal-body">
          {% csrf_token %}
          <label class="form-label fw-medium"><i class="fa fa-comment me-1"></i>Cancellation Reason</label>
          <textarea name="reason" class="form-control" rows="3" required placeholder="Please provide a reason for cancellation..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-danger" type="submit"><i class="fa fa-times me-1"></i>Cancel Order</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- Add Order Type/Component Modal -->
<div class="modal fade" id="addOrderTypeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title"><i class="fa fa-plus-circle me-2"></i>Add Order Component</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'tracker:add_order_component' pk=order.id %}" id="addComponentForm">
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label fw-bold">Component Type <span class="text-danger">*</span></label>
            <select name="component_type" class="form-select" required>
              <option value="">-- Select Type --</option>
              {% if order.type != 'service' and not order.components|has_type:'service' %}
              <option value="service">Service</option>
              {% endif %}
              {% if order.type != 'sales' and not order.components|has_type:'sales' %}
              <option value="sales">Sales</option>
              {% endif %}
            </select>
            <small class="text-muted">Add a different service or sales component to this order</small>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Reason for Adding <span class="text-danger">*</span></label>
            <textarea name="reason" class="form-control" rows="3" placeholder="e.g., Customer requested additional service, found damage during inspection..." required></textarea>
            <small class="text-muted">Explain why you are adding this component</small>
          </div>

          <ul class="nav nav-tabs nav-fill mb-3" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="existingInvoiceTab" data-bs-toggle="tab" data-bs-target="#existingInvoicePane" type="button" role="tab">
                <i class="fa fa-file-invoice me-2"></i>Existing Invoice
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="uploadInvoiceTab" data-bs-toggle="tab" data-bs-target="#uploadInvoicePane" type="button" role="tab">
                <i class="fa fa-upload me-2"></i>Upload Invoice
              </button>
            </li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane fade show active" id="existingInvoicePane" role="tabpanel">
              <div class="mb-3">
                <label class="form-label fw-bold">Link Existing Invoice <span class="text-muted">(optional)</span></label>
                <select name="invoice_id" class="form-select" id="existingInvoiceSelect">
                  <option value="">-- Select Invoice (optional) --</option>
                  {% for invoice in order.invoices.all %}
                  <option value="{{ invoice.id }}">{{ invoice.invoice_number }} - {{ invoice.total_amount|floatformat:2 }}</option>
                  {% endfor %}
                </select>
                <small class="text-muted">Attach an existing invoice to this component</small>
              </div>
            </div>
            <div class="tab-pane fade" id="uploadInvoicePane" role="tabpanel">
              <div class="mb-3">
                <label class="form-label fw-bold">Upload Invoice Document <span class="text-muted">(optional)</span></label>
                <input type="file" name="invoice_file" class="form-control" id="componentInvoiceFile" accept=".pdf,.jpg,.jpeg,.png" />
                <small class="text-muted">Upload a PDF or image file of the invoice</small>
              </div>

              <div class="row g-2 mb-3">
                <div class="col-md-4">
                  <label class="form-label fw-bold">Net Value</label>
                  <div class="input-group">
                    <input type="number" name="invoice_subtotal" class="form-control" id="componentNetValue" placeholder="0.00" step="0.01" min="0" />
                    <span class="input-group-text">{{ request.user.userprofile.currency_symbol|default:'$' }}</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-bold">VAT %</label>
                  <input type="number" name="invoice_vat_rate" class="form-control" id="componentVATRate" placeholder="0.00" step="0.01" min="0" max="100" />
                </div>
                <div class="col-md-4">
                  <label class="form-label fw-bold">VAT Amount</label>
                  <div class="input-group">
                    <input type="number" name="invoice_tax_amount" class="form-control" id="componentVATAmount" placeholder="0.00" step="0.01" min="0" readonly />
                    <span class="input-group-text">{{ request.user.userprofile.currency_symbol|default:'$' }}</span>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-bold">Gross Value (Total)</label>
                <div class="input-group">
                  <input type="number" name="invoice_total_amount" class="form-control" id="componentGrossValue" placeholder="0.00" step="0.01" min="0" readonly />
                  <span class="input-group-text">{{ request.user.userprofile.currency_symbol|default:'$' }}</span>
                </div>
                <small class="text-muted">Net Value + VAT Amount</small>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-check me-1"></i>Add Component
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const netValueInput = document.getElementById('componentNetValue');
  const vatRateInput = document.getElementById('componentVATRate');
  const vatAmountInput = document.getElementById('componentVATAmount');
  const grossValueInput = document.getElementById('componentGrossValue');
  const existingInvoiceSelect = document.getElementById('existingInvoiceSelect');

  function calculateValues() {
    const netValue = parseFloat(netValueInput.value) || 0;
    const vatRate = parseFloat(vatRateInput.value) || 0;
    const vatAmount = (netValue * vatRate) / 100;
    const grossValue = netValue + vatAmount;

    vatAmountInput.value = vatAmount.toFixed(2);
    grossValueInput.value = grossValue.toFixed(2);
  }

  if (netValueInput) {
    netValueInput.addEventListener('input', calculateValues);
  }
  if (vatRateInput) {
    vatRateInput.addEventListener('input', calculateValues);
  }

  const addComponentForm = document.getElementById('addComponentForm');
  if (addComponentForm) {
    addComponentForm.addEventListener('submit', function(e) {
      const activeTab = document.querySelector('.nav-link.active');
      if (activeTab && activeTab.id === 'uploadInvoiceTab') {
        const netValue = parseFloat(netValueInput.value) || 0;
        const grossValue = parseFloat(grossValueInput.value) || 0;
        if (netValue > 0 || grossValue > 0) {
          e.preventDefault();
          const formData = new FormData(this);
          fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
            }
          }).then(response => {
            if (response.ok) {
              window.location.reload();
            } else {
              alert('Error adding component. Please try again.');
            }
          }).catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
          });
        }
      }
    });
  }
});
</script>

<!-- Link Invoice Modal -->
<div class="modal fade" id="linkInvoiceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title"><i class="fa fa-link me-2"></i>Link Invoice to Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'tracker:link_invoice_to_order' pk=order.id %}" id="linkInvoiceForm">
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label fw-bold">Select Invoice <span class="text-danger">*</span></label>
            <select name="invoice_id" class="form-select" required>
              <option value="">-- Choose an Invoice --</option>
              {% for invoice in available_invoices %}
              <option value="{{ invoice.id }}">{{ invoice.invoice_number }} ({{ invoice.customer.full_name }})</option>
              {% endfor %}
            </select>
            <small class="text-muted">Choose an invoice to link to this order. You can only link invoices from this customer.</small>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Reason for Linking <span class="text-danger">*</span></label>
            <textarea name="reason" class="form-control" rows="3" placeholder="e.g., Additional parts purchased, Follow-up service charges, Repair materials..." required></textarea>
            <small class="text-muted">Explain why you are linking this invoice to the order</small>
          </div>

          <div class="mb-0">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="is_primary" id="isPrimaryInvoice">
              <label class="form-check-label" for="isPrimaryInvoice">
                Set as primary invoice for this order
              </label>
              <small class="text-muted d-block mt-1">Primary invoice is the main invoice for this order</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-check me-1"></i>Link Invoice
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Remove Invoice Link Modal -->
<div class="modal fade" id="removeInvoiceLinkModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger bg-opacity-10 border-bottom border-danger">
        <h5 class="modal-title text-danger"><i class="fa fa-exclamation-circle me-2"></i>Remove Invoice Link?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Are you sure you want to remove this invoice link from the order?</p>
        <div class="alert alert-warning">
          <small>
            <i class="fa fa-info-circle me-2"></i>
            This will only remove the link. The invoice itself will not be deleted and can be linked again later.
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="post" action="{% url 'tracker:remove_invoice_link' pk=order.id %}" style="display: inline;">
          {% csrf_token %}
          <input type="hidden" name="link_id" id="removeInvoiceLinkId">
          <button type="submit" class="btn btn-danger">
            <i class="fa fa-unlink me-1"></i>Remove Link
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Questions Full Text Modal -->
{% if order.questions %}
<div class="modal fade" id="questionsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fa fa-comments me-2"></i>Questions & Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="p-3 bg-light rounded">
          {{ order.questions|linebreaks }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Invoice Upload Modal (Shared/Reusable) -->
{% include 'tracker/partials/invoice_upload_modal.html' %}

<!-- Description Full Text Modal -->
{% if order.description %}
<div class="modal fade" id="descriptionModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fa fa-file-text me-2"></i>Order Description</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="p-3 bg-light rounded">
          {{ order.description|linebreaks }}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<style>
  /* Time & Information Combined Card Styles */
  .time-info-combined-card {
    border: none;
    border-radius: 12px;
    overflow: hidden;
  }

  .bg-gradient-primary {
    background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%) !important;
  }

  .bg-light-primary {
    background-color: #e7f1ff !important;
  }

  .bg-light-secondary {
    background-color: #f0f2f5 !important;
  }

  .additional-invoice-card {
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .time-metrics-group,
  .timeline-events-group {
    padding: 0.5rem 0;
  }

  .time-metrics-list,
  .timeline-events-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid #0d6efd;
  }

  .metric-label {
    color: #6c757d;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .metric-value {
    color: #212529;
    font-size: 1rem;
  }

  .timeline-event-item {
    display: flex;
    gap: 1rem;
    padding: 0.75rem 0;
    position: relative;
  }

  .timeline-event-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 20px;
    top: 50px;
    width: 2px;
    height: 40px;
    background: #e9ecef;
  }

  .event-marker {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
  }

  .event-marker.created {
    background: #e3f2fd;
    border-color: #90caf9;
    color: #1565c0;
  }

  .event-marker.started {
    background: #fff3e0;
    border-color: #ffb74d;
    color: #f57c00;
  }

  .event-marker.completed {
    background: #e8f5e9;
    border-color: #81c784;
    color: #2e7d32;
  }

  .event-marker.cancelled {
    background: #ffebee;
    border-color: #ef5350;
    color: #c62828;
  }

  .event-details {
    flex: 1;
    padding-top: 0.25rem;
  }

  .event-label {
    font-weight: 600;
    color: #212529;
    font-size: 0.95rem;
  }

  .event-time {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }

  /* Enhanced Document Section Styles */
  .document-actions {
    display: flex;
    gap: 0.5rem;
  }

  /* Invoice Line Items Table Styling */
  .invoice-line-items-table {
    font-size: 0.85rem;
    width: 100%;
  }

  .invoice-line-items-table thead {
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
  }

  .invoice-line-items-table th,
  .invoice-line-items-table td {
    padding: 0.6rem 0.4rem;
    vertical-align: middle;
    border: 1px solid #dee2e6;
  }

  .invoice-line-items-table th {
    font-weight: 600;
    text-align: left;
    background-color: #f8f9fa;
  }

  .col-line-item-desc {
    word-break: break-word;
    white-space: normal;
    overflow-wrap: break-word;
    max-width: 0;
  }

  .col-line-item-sr {
    text-align: center;
  }

  @media (max-width: 768px) {
    .invoice-line-items-table {
      font-size: 0.75rem;
    }

    .invoice-line-items-table th,
    .invoice-line-items-table td {
      padding: 0.4rem 0.25rem;
    }
  }
  
  .document-workflow-alert {
    border-left: 4px solid #17a2b8;
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }
  
  .document-categories {
    margin-bottom: 2rem;
  }
  
  .document-category-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 1.25rem;
    height: 100%;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .document-category-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .document-category-card.category-pending {
    border-left: 4px solid #ffc107;
    background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
  }
  
  .category-header {
    display: flex;
    align-items: center;
    margin-bottom: 0.75rem;
    gap: 0.75rem;
  }
  
  .category-header i {
    font-size: 1.5rem;
    width: 24px;
  }
  
  .category-title {
    font-weight: 600;
    color: #495057;
    flex: 1;
  }
  
  .document-count, .document-status {
    font-size: 0.875rem;
    font-weight: 600;
  }
  
  .document-count {
    background: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    min-width: 30px;
    text-align: center;
  }
  
  .category-description {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 1rem;
    line-height: 1.4;
  }
  
  .document-actions-stacked {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .document-actions-stacked .btn {
    flex: 1;
    min-width: 80px;
  }
  
  .action-buttons-compact {
    display: flex;
    gap: 0.25rem;
  }
  
  .action-buttons-compact .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }
  
  /* Enhanced Inquiry Section Styles */
  .inquiry-main-card {
    border: none;
    border-radius: 12px;
    overflow: hidden;
  }
  
  .bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
  }
  
  .inquiry-feature-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .inquiry-feature-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .card-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
  }
  
  .inquiry-type-card .card-icon {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    color: #1565c0;
  }
  
  .inquiry-contact-card .card-icon {
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
    color: #2e7d32;
  }
  
  .inquiry-status-card .card-icon {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    color: #f57c00;
  }
  
  .bg-gradient-info {
    background: linear-gradient(135deg, #0dcaf0 0%, #13b0f5 100%) !important;
  }

  /* Order Components Card Styles */
  .order-components-card {
    border: none;
    border-radius: 12px;
    overflow: hidden;
  }

  .components-and-invoices-list {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .component-item,
  .invoice-link-item {
    background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 100%);
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.3s ease;
  }

  .component-item:hover,
  .invoice-link-item:hover {
    border-color: #0d6efd;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.1);
  }

  /* Signature Modal Document Selection Styles */
  .document-list-selection {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .document-selection-item {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.875rem;
    transition: all 0.3s ease;
    background: #f8f9fa;
  }

  .document-selection-item:hover {
    border-color: #0d6efd;
    background: #f0f5ff;
    transform: translateX(4px);
  }

  .document-selection-item .form-check-input:checked ~ .form-check-label {
    color: #0d6efd;
  }

  .document-selection-item .form-check-input:checked {
    border-color: #0d6efd;
    background-color: #0d6efd;
  }

  .doc-selector-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-radius: 6px;
    font-size: 1.25rem;
    color: #1565c0;
    margin-right: 0.75rem;
    flex-shrink: 0;
  }

  .upload-new-document-section {
    background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%);
    border: 2px dashed #ffc107;
    border-radius: 8px;
    padding: 1.25rem;
  }

  .upload-document-input-wrapper {
    position: relative;
  }

  .selected-document-summary {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border: 2px solid #81c784;
    border-radius: 8px;
    padding: 1rem;
  }

  .summary-header {
    font-size: 0.95rem;
    font-weight: 600;
    color: #2e7d32;
    margin-bottom: 0.75rem;
  }

  .summary-content {
    background: white;
    border-radius: 6px;
    padding: 0.75rem;
    border-left: 4px solid #4caf50;
  }
  
  .card-content {
    flex: 1;
  }
  
  .inquiry-details-card {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    overflow: hidden;
  }
  
  .inquiry-content {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #495057;
    padding: 1rem 0;
  }
  
  .inquiry-timeline-card {
    background: white;
    border-radius: 10px;
    padding: 1.25rem;
    border: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 1rem;
    height: 100%;
  }
  
  .inquiry-timeline-card .card-icon {
    width: 40px;
    height: 40px;
    background: #f8f9fa;
    color: #6c757d;
  }
  
  /* Enhanced Vehicle Information Styles */
  .vehicle-info-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(14, 165, 233, 0.1);
  }
  
  .vehicle-info-header {
    color: #0369a1;
    font-weight: 600;
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .vehicle-info-header i {
    font-size: 1rem;
  }
  
  .vehicle-detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }
  
  .vehicle-detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .vehicle-detail-label {
    font-size: 0.75rem;
    color: #64748b;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .vehicle-detail-value {
    font-size: 0.875rem;
    color: #0f172a;
    font-weight: 600;
  }
  
  /* Enhanced Content Box Styles */
  .content-box-questions {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 0.75rem;
  }
  
  .content-box-description {
    background: linear-gradient(135deg, #fef7cd 0%, #fef3c7 100%);
    border: 1px solid #fcd34d;
    border-radius: 8px;
    padding: 0.75rem;
  }
  
  .content-box-text {
    color: #1e293b;
    font-size: 0.875rem;
    line-height: 1.5;
    margin: 0;
  }
  
  .read-more-btn {
    color: #0369a1 !important;
    font-size: 0.75rem;
    text-decoration: none;
    font-weight: 500;
  }
  
  .read-more-btn:hover {
    color: #075985 !important;
    text-decoration: underline;
  }
  
  /* Keep all original styles exactly the same */
  .time-tracking-card .time-tracking-overview {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .time-tracking-card .time-tracking-stat {
    flex: 1 1 150px;
    background-color: #f8f9fa;
    border-radius: .5rem;
    padding: .75rem 1rem;
  }
  
  .time-tracking-card .time-tracking-label {
    display: block;
    font-size: .75rem;
    text-transform: uppercase;
    letter-spacing: .04em;
    color: #6c757d;
    margin-bottom: .25rem;
  }
  
  .time-tracking-card .time-tracking-value {
    font-weight: 600;
    color: #212529;
    font-size: 1rem;
  }
  
  .time-tracking-card .time-progress-bar {
    height: 10px;
    background-color: #e9ecef;
    border-radius: .5rem;
    overflow: hidden;
    margin-top: 1.25rem;
  }
  
  .time-tracking-card .progress-bar {
    transition: width .6s ease;
  }
  
  .time-progress-status {
    color: #495057;
  }
  
  .time-progress-over {
    background-color: #dc3545 !important;
  }
  
  /* PDF embedding styles */
  .pdf-embed-host iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
  }
  
  .signed-document-preview {
    border-left: 4px solid #28a745 !important;
    padding-left: 1rem;
  }
  
  .signed-document-preview .border {
    border-color: #dee2e6 !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Order Details Sections by Type */
  .order-details-service .card-header {
    border-left: 4px solid #0d6efd;
    background-color: #f0f6ff !important;
  }

  .order-details-sales .card-header {
    border-left: 4px solid #198754;
    background-color: #f0fdf4 !important;
  }

  .order-details-inquiry .card-header {
    border-left: 4px solid #0dcaf0;
    background-color: #f0f9fc !important;
  }

  /* Order Section Cards in Customer Registration Step 4 */
  .order-section-service .card-header {
    border-left: 4px solid #0d6efd;
    background-color: #f0f6ff !important;
  }

  .order-section-sales .card-header {
    border-left: 4px solid #198754;
    background-color: #f0fdf4 !important;
  }

  .order-section-inquiry .card-header {
    border-left: 4px solid #0dcaf0;
    background-color: #f0f9fc !important;
  }

  .order-section-vehicle .card-header {
    border-left: 4px solid #0dcaf0;
    background-color: #f0f9fc !important;
  }

  /* Improved badge styles for order summaries */
  .order-section-service .badge-sm,
  .order-details-service .badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.7rem;
  }

  .order-section-sales .badge-sm,
  .order-details-sales .badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.7rem;
  }

  .order-section-inquiry .badge-sm,
  .order-details-inquiry .badge {
    font-size: 0.8rem;
    padding: 0.4rem 0.7rem;
  }

  /* Card body improvements */
  .order-details-service .card-body,
  .order-details-sales .card-body,
  .order-details-inquiry .card-body,
  .order-section-service .card-body,
  .order-section-sales .card-body,
  .order-section-inquiry .card-body {
    padding: 1.5rem;
  }

  /* Separate field styling */
  .order-details-service [class*="mb-3"],
  .order-details-sales [class*="mb-3"],
  .order-details-inquiry [class*="mb-3"] {
    margin-bottom: 1.25rem;
  }

  .order-details-service .form-label,
  .order-details-sales .form-label,
  .order-details-inquiry .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
  }

  /* Field value styling */
  .order-details-service [style*="background-color"],
  .order-details-sales [style*="background-color"],
  .order-details-inquiry [style*="background-color"] {
    padding: 0.75rem 1rem;
    font-weight: 500;
    color: #212529;
    word-break: break-word;
  }

  /* Alert styling for empty states */
  .order-section-service .alert,
  .order-section-sales .alert,
  .order-section-inquiry .alert {
    margin-bottom: 0;
    border: none;
    border-radius: 6px;
  }

  /* Grid improvements */
  .order-details-service .row,
  .order-details-sales .row,
  .order-details-inquiry .row {
    row-gap: 1rem;
  }

  /* Responsive adjustments for order details */
  @media (max-width: 768px) {
    .order-details-service .card-header,
    .order-details-sales .card-header,
    .order-details-inquiry .card-header {
      flex-direction: column;
      align-items: flex-start !important;
    }

    .order-details-service .card-header h6,
    .order-details-sales .card-header h6,
    .order-details-inquiry .card-header h6 {
      margin-right: 0;
    }

    .order-details-service .badge,
    .order-details-sales .badge,
    .order-details-inquiry .badge {
      margin-top: 0.5rem;
    }
  }

  @media (max-width: 767.98px) {
    .time-tracking-card .time-tracking-stat {
      flex: 1 1 100%;
    }
    
    .inquiry-feature-card {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }
    
    .vehicle-detail-grid {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }
    
    .document-actions {
      flex-direction: column;
      width: 100%;
    }
    
    .document-actions .btn {
      width: 100%;
    }
    
    .document-actions-stacked {
      flex-direction: column;
    }
    
    .action-buttons-compact {
      flex-direction: column;
    }
  }
  
  .timeline {
    position: relative;
    padding-left: 30px;
  }
  .timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
  }
  .timeline-item {
    position: relative;
    margin-bottom: 20px;
  }
  .timeline-item:last-child {
    margin-bottom: 0;
  }
  .timeline-marker {
    position: absolute;
    left: -26px;
    top: 2px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #dee2e6;
  }
  .timeline-content {
    padding-left: 10px;
  }
  
  /* Attachments Table Styles */
  .attachments-table {
    font-size: 0.9rem;
  }
  
  .attachments-table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
    background-color: #f8f9fa;
  }
  
  .attachments-table td {
    vertical-align: middle;
  }
  
  .attachments-table .badge {
    font-size: 0.75rem;
  }
  
  .signature-capture-section {
    border-left: 4px solid #198754 !important;
  }
  
  .signed-doc-wrapper .completion-attachment-img {
    width: 100%;
    height: auto;
    display: block;
    max-height: 650px;
    object-fit: contain;
  }
  
  .signature-overlay {
    position: absolute;
    right: 12px;
    bottom: 12px;
    max-width: 30%;
    opacity: .95;
    z-index: 10;
    border: 2px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  
  /* Unified action buttons styling */
  .action-buttons-container {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  @media (max-width: 991.98px) {
    .action-buttons-container {
      flex-direction: column;
      width: 100%;
    }

    .action-buttons-container .btn {
      width: 100%;
    }
  }

  /* Enhanced Signature Modal Styles */
  .signature-modal-container {
    max-width: 550px;
  }

  .signature-modal-content {
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    overflow: hidden;
  }

  .signature-modal-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
  }

  .signature-modal-body {
    background: white;
    max-height: 70vh;
    overflow-y: auto;
  }

  .signature-modal-footer {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
  }

  .signature-pad-wrapper {
    background: white;
    border-width: 2px;
    border-color: #dee2e6;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .signature-pad-wrapper:hover {
    border-color: #28a745;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.1);
  }

  .signature-pad-wrapper:active {
    border-color: #28a745;
    box-shadow: 0 6px 16px rgba(40, 167, 69, 0.15);
  }

  #signaturePad {
    background: white;
  }

  #signaturePreviewMini {
    background: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  /* Responsive adjustments for signature modal */
  @media (max-width: 576px) {
    .signature-modal-container {
      max-width: 95vw;
    }

    .signature-modal-body {
      max-height: 80vh;
      padding: 1rem !important;
    }
  }

  /* Button styling for signature modal */
  .signature-modal-footer .btn-success {
    min-width: 150px;
    padding: 0.75rem 1.5rem;
  }

  .signature-modal-footer .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
  }

  /* Enhanced Timeline for Compact View */
  .timeline-compact {
    position: relative;
    padding-left: 0;
  }

  .timeline-compact-item {
    display: flex;
    gap: 1rem;
    padding-bottom: 1.5rem;
    position: relative;
  }

  .timeline-compact-item:last-child {
    padding-bottom: 0;
  }

  .timeline-compact-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 1.25rem;
    top: 2.5rem;
    width: 2px;
    height: calc(100% + 0.5rem);
    background: #dee2e6;
  }

  .timeline-compact-marker {
    flex-shrink: 0;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 50%;
    font-size: 1rem;
    position: relative;
    z-index: 1;
  }

  .timeline-compact-content {
    flex: 1;
    padding-top: 0.25rem;
  }

  /* Order Types and Invoices Cards */
  .order-types-card, .invoices-card {
    transition: all 0.3s ease;
  }

  .component-item, .invoice-link-item {
    transition: all 0.3s ease;
  }

  .component-item:hover, .invoice-link-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .component-actions, .invoice-actions {
    display: flex;
    gap: 0.5rem;
  }

  /* Tab styling for signature modal */
  .signature-modal-container .nav-tabs {
    border-bottom: 2px solid #e9ecef;
  }

  .signature-modal-container .nav-link {
    border: none;
    color: #6c757d;
    padding: 0.75rem 1rem;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
  }

  .signature-modal-container .nav-link:hover {
    color: #495057;
    border-bottom-color: #dee2e6;
  }

  .signature-modal-container .nav-link.active {
    color: #198754;
    border-bottom-color: #198754;
    background: transparent;
  }

  /* Signature Pad Container */
  .signature-pad-wrapper {
    transition: all 0.3s ease;
  }

  .signature-pad-wrapper:focus-within {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
  }

  /* Modal Header Gradient */
  .bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
  }

  .bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%) !important;
  }

  /* Enhanced Invoice Line Items Table Styling */
  .invoice-line-items-table {
    font-size: 0.85rem;
    margin-bottom: 0;
  }

  .invoice-line-items-table thead {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
  }

  .invoice-line-items-table thead th {
    font-weight: 600;
    color: #495057;
    padding: 0.75rem;
    border-color: #dee2e6;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
  }

  .invoice-line-items-table tbody td {
    padding: 0.75rem;
    vertical-align: middle;
    border-color: #f1f3f5;
  }

  .invoice-line-items-table tbody tr:hover {
    background-color: #f8f9fa;
  }

  .col-line-item-sr {
    width: 50px;
    text-align: center;
    flex-shrink: 0;
  }

  .col-line-item-code {
    width: 110px;
    min-width: 110px;
    word-break: break-word;
  }

  .col-line-item-desc {
    min-width: 200px;
    flex-grow: 1;
    word-break: break-word;
  }

  .col-line-item-unit {
    width: 80px;
    text-align: center;
  }

  .col-line-item-qty {
    width: 80px;
    text-align: center;
    flex-shrink: 0;
  }

  .col-line-item-rate {
    width: 120px;
    text-align: right;
    flex-shrink: 0;
  }

  .col-line-item-total {
    width: 120px;
    text-align: right;
    flex-shrink: 0;
  }

  @media (max-width: 1200px) {
    .col-line-item-desc {
      min-width: 150px;
    }

    .invoice-line-items-table thead th,
    .invoice-line-items-table tbody td {
      padding: 0.6rem;
      font-size: 0.8rem;
    }
  }

  @media (max-width: 768px) {
    .col-line-item-code {
      width: 90px;
      min-width: 90px;
    }

    .col-line-item-desc {
      min-width: 120px;
    }

    .col-line-item-rate,
    .col-line-item-total {
      width: 100px;
    }

    .invoice-line-items-table thead th,
    .invoice-line-items-table tbody td {
      padding: 0.5rem 0.3rem;
      font-size: 0.75rem;
    }

    .invoice-line-items-table thead th {
      font-size: 0.7rem;
    }
  }
</style>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  // PDF embedding with graceful fallback - CORRECTED VERSION
  function initializePdfEmbeds(){
    var hosts = document.querySelectorAll('.pdf-embed-host');
    hosts.forEach(function(host){
      var url = host.getAttribute('data-pdf-url') || '';
      if(!url) return;
      
      try {
        // Create a proper URL object to handle relative paths
        var fullUrl = url;
        if (url.startsWith('/')) {
          // If it's a relative URL, make it absolute
          fullUrl = window.location.origin + url;
        }
        
        // For signed PDFs, we should always try to embed them
        // Check if this is a signed document by checking the URL or context
        var isSignedDocument = url.includes('-signed') || 
                              host.closest('.signed-document-preview') !== null ||
                              host.closest('.attachments-card') !== null;
        
        if(isSignedDocument) {
          // For signed documents, always use iframe embedding
          var iframe = document.createElement('iframe');
          iframe.src = fullUrl + '#toolbar=0&navpanes=0&scrollbar=0';
          iframe.title = 'Signed PDF Document';
          iframe.className = 'w-100 h-100';
          iframe.style.border = '0';
          iframe.style.minHeight = '400px';
          iframe.style.background = 'white';
          host.innerHTML = '';
          host.appendChild(iframe);
          
          // Add fallback in case iframe fails to load
          iframe.onerror = function() {
            host.innerHTML = '<div class="d-flex w-100 h-100 align-items-center justify-content-center text-center text-muted p-3"><div><i class="fa fa-file-pdf-o fa-2x mb-2"></i><div>PDF preview unavailable</div><a class="btn btn-outline-primary btn-sm mt-2" target="_blank" rel="noopener" href="'+fullUrl+'"><i class="fa fa-external-link me-1"></i>Open PDF</a></div></div>';
          };
        } else {
          // For regular PDFs, use the existing logic
          var a = document.createElement('a');
          a.href = fullUrl;
          var sameOrigin = a.origin === window.location.origin;
          
          if(sameOrigin){
            var iframe = document.createElement('iframe');
            iframe.src = fullUrl + '#toolbar=0&navpanes=0&scrollbar=0';
            iframe.title = 'PDF preview';
            iframe.className = 'w-100 h-100';
            iframe.style.border = '0';
            iframe.style.minHeight = '400px';
            iframe.style.background = 'white';
            host.innerHTML = '';
            host.appendChild(iframe);
          } else {
            host.innerHTML = '<div class="d-flex w-100 h-100 align-items-center justify-content-center text-center text-muted p-3"><div><i class="fa fa-file-pdf-o fa-2x mb-2"></i><div>External PDF - Download to view</div><a class="btn btn-outline-primary btn-sm mt-2" target="_blank" rel="noopener" href="'+fullUrl+'"><i class="fa fa-download me-1"></i>Download PDF</a></div></div>';
          }
        }
      } catch (e) {
        console.error('Error embedding PDF:', e);
        // Fallback: show download link
        host.innerHTML = '<div class="d-flex w-100 h-100 align-items-center justify-content-center text-center text-muted p-3"><div><i class="fa fa-file-pdf-o fa-2x mb-2"></i><div>Preview unavailable</div><a class="btn btn-outline-primary btn-sm mt-2" target="_blank" rel="noopener" href="'+url+'"><i class="fa fa-external-link me-1"></i>Open PDF</a></div></div>';
      }
    });
  }

  // Function to handle signing existing documents
  function initializeExistingDocSigning() {
    const signExistingModal = document.getElementById('signExistingModal');
    if (!signExistingModal) return;

    const signExistingForm = document.getElementById('signExistingForm');
    const signExistingSignatureData = document.getElementById('signExistingSignatureData');
    const signExistingAttachmentId = document.getElementById('signExistingAttachmentId');
    const signExistingFileName = document.getElementById('signExistingFileName');
    const currentDocumentName = document.getElementById('currentDocumentName');
    const existingDocPreviewHost = document.getElementById('existingDocPreviewHost');
    const existingDocSignaturePad = document.getElementById('existingDocSignaturePad');
    const existingPreviewCanvas = document.getElementById('existingSignaturePreview');
    const existingPreviewCtx = existingPreviewCanvas ? existingPreviewCanvas.getContext('2d') : null;
    const clearExistingSignatureBtn = document.getElementById('clearExistingSignatureBtn');
    const signExistingDocBtn = document.getElementById('signExistingDocBtn');
    const footerSignExistingDoc = document.getElementById('footerSignExistingDoc');

    let existingDocCurrentFileUrl = null;
    let existingDocCurrentCanvas = null;
    let existingDocHasSignature = false;

    // Initialize signature functionality for existing documents
    function initializeExistingDocSignaturePad() {
      existingDocCurrentCanvas = createExistingDocSignatureCanvas();
      if (!existingDocCurrentCanvas) return;
      setupExistingDocCanvasEvents(existingDocCurrentCanvas);
    }

    function createExistingDocSignatureCanvas() {
      const existingCanvas = document.getElementById('existingDocSignaturePad');
      if (existingCanvas) {
        existingCanvas.remove();
      }
      
      const container = document.getElementById('existingDocSignContainer');
      if (!container) return null;

      const canvas = document.createElement('canvas');
      canvas.id = 'existingDocSignaturePad';
      canvas.className = 'position-absolute top-0 start-0 w-100 h-100';
      canvas.style.cssText = 'cursor: crosshair; z-index: 10; display: block; pointer-events: auto; touch-action: none;';

      const rect = container.getBoundingClientRect();
      const scale = window.devicePixelRatio || 1;
      canvas.width = (rect.width || container.offsetWidth || 400) * scale;
      canvas.height = (rect.height || container.offsetHeight || 360) * scale;
      canvas.style.width = (canvas.width / scale) + 'px';
      canvas.style.height = (canvas.height / scale) + 'px';

      const ctx = canvas.getContext('2d');
      ctx.scale(scale, scale);
      ctx.lineWidth = 2.5;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = '#000000';
      ctx.globalCompositeOperation = 'source-over';

      container.appendChild(canvas);
      return canvas;
    }

    function setupExistingDocCanvasEvents(canvas) {
      const ctx = canvas.getContext('2d');
      const scale = window.devicePixelRatio || 1;
      let drawing = false;
      let lastX = 0;
      let lastY = 0;

      function clearExistingPreview(){
        if (!existingPreviewCtx || !existingPreviewCanvas) return;
        existingPreviewCtx.clearRect(0, 0, existingPreviewCanvas.width, existingPreviewCanvas.height);
      }

      function scaleToExistingPreview(x, y) {
        if (!existingPreviewCanvas) return { x, y };
        const scaleX = existingPreviewCanvas.width / (canvas.width / scale);
        const scaleY = existingPreviewCanvas.height / (canvas.height / scale);
        return { x: x * scaleX, y: y * scaleY };
      }

      function getCanvasPosition(e) {
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;

        if (e.type.includes('touch')) {
          if (e.touches && e.touches[0]) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
          }
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }

        return {
          x: (clientX - rect.left) * (canvas.width / rect.width / scale),
          y: (clientY - rect.top) * (canvas.height / rect.height / scale)
        };
      }

      function beginStroke(x, y) {
        drawing = true;
        lastX = x;
        lastY = y;
        ctx.beginPath();
        ctx.moveTo(x, y);
        if (existingPreviewCtx) {
          const s = scaleToExistingPreview(x, y);
          existingPreviewCtx.beginPath();
          existingPreviewCtx.moveTo(s.x, s.y);
          existingPreviewCtx.lineTo(s.x, s.y);
          existingPreviewCtx.lineWidth = 2;
          existingPreviewCtx.strokeStyle = '#000000';
          existingPreviewCtx.stroke();
        }
        existingDocHasSignature = true;
        showExistingDocSignatureTools();
      }

      function drawStroke(x, y) {
        if (!drawing) return;
        ctx.lineTo(x, y);
        ctx.stroke();
        if (existingPreviewCtx) {
          const a = scaleToExistingPreview(lastX, lastY);
          const b = scaleToExistingPreview(x, y);
          existingPreviewCtx.beginPath();
          existingPreviewCtx.moveTo(a.x, a.y);
          existingPreviewCtx.lineTo(b.x, b.y);
          existingPreviewCtx.lineWidth = 2;
          existingPreviewCtx.strokeStyle = '#000000';
          existingPreviewCtx.stroke();
        }
        lastX = x;
        lastY = y;
      }

      function endStroke() {
        drawing = false;
      }

      // Event listeners
      canvas.addEventListener('mousedown', (e) => {
        const pos = getCanvasPosition(e);
        beginStroke(pos.x, pos.y);
      });

      canvas.addEventListener('mousemove', (e) => {
        const pos = getCanvasPosition(e);
        drawStroke(pos.x, pos.y);
      });

      canvas.addEventListener('mouseup', endStroke);
      canvas.addEventListener('mouseout', endStroke);

      // Touch events
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const pos = getCanvasPosition(e);
        beginStroke(pos.x, pos.y);
      }, { passive: false });

      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const pos = getCanvasPosition(e);
        drawStroke(pos.x, pos.y);
      }, { passive: false });

      canvas.addEventListener('touchend', endStroke, { passive: false });
    }

    function showExistingDocSignatureTools() {
      if (clearExistingSignatureBtn) clearExistingSignatureBtn.style.display = 'inline-block';
      if (signExistingDocBtn) {
        signExistingDocBtn.style.display = 'inline-block';
        signExistingDocBtn.disabled = false;
      }
      if (footerSignExistingDoc) {
        footerSignExistingDoc.disabled = false;
      }
      if (existingDocCurrentCanvas) {
        existingDocCurrentCanvas.style.display = 'block';
      }
    }

      function clearExistingDocSignature() {
        if (existingDocCurrentCanvas) {
          const ctx = existingDocCurrentCanvas.getContext('2d');
          const scale = window.devicePixelRatio || 1;
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          ctx.clearRect(0, 0, existingDocCurrentCanvas.width, existingDocCurrentCanvas.height);
          ctx.scale(scale, scale);
        }
        existingDocHasSignature = false;
        if (signExistingSignatureData) {
          signExistingSignatureData.value = '';
        }
        clearExistingPreview();
      }

    function cleanupExistingDocFileUrl() {
      if (existingDocCurrentFileUrl) {
        try {
          URL.revokeObjectURL(existingDocCurrentFileUrl);
        } catch (e) {
          console.log('Error revoking URL:', e);
        }
        existingDocCurrentFileUrl = null;
      }
    }

    function loadExistingDocPreview(fileUrl, fileName) {
      cleanupExistingDocFileUrl();
      existingDocHasSignature = false;
      if (signExistingSignatureData) {
        signExistingSignatureData.value = '';
      }

      existingDocPreviewHost.innerHTML = '';
      existingDocPreviewHost.style.position = 'relative';
      existingDocPreviewHost.style.overflow = 'hidden';

      if (!fileUrl) {
        existingDocPreviewHost.innerHTML = '<div class="w-100 h-100 bg-white d-flex align-items-center justify-content-center"><div class="text-center text-muted"><i class="fa fa-pen fa-3x mb-3"></i><div>Draw signature here</div></div></div>';
        initializeExistingDocSignaturePad();
        return;
      }

      existingDocCurrentFileUrl = fileUrl;
      const fileType = fileName.toLowerCase();

      try {
        if (fileType.includes('.jpg') || fileType.includes('.jpeg') || fileType.includes('.png') || fileType.includes('.gif') || fileType.includes('.webp')) {
          const img = document.createElement('img');
          img.src = existingDocCurrentFileUrl;
          img.alt = 'Document to sign';
          img.className = 'w-100 h-100';
          img.style.objectFit = 'contain';
          img.style.pointerEvents = 'none';
          img.onload = function() {
            if (!existingDocPreviewHost.contains(img)) {
              existingDocPreviewHost.appendChild(img);
            }
            initializeExistingDocSignaturePad();
          };
        } else if (fileType.includes('.pdf')) {
          const iframe = document.createElement('iframe');
          iframe.src = existingDocCurrentFileUrl + '#toolbar=0&navpanes=0&scrollbar=0';
          iframe.title = 'PDF preview';
          iframe.className = 'w-100 h-100';
          iframe.style.border = 'none';
          iframe.style.pointerEvents = 'none';
          iframe.style.minHeight = '360px';

          existingDocPreviewHost.appendChild(iframe);
          setTimeout(initializeExistingDocSignaturePad, 300);
        } else {
          const container = document.createElement('div');
          container.className = 'w-100 h-100 d-flex align-items-center justify-content-center flex-column';
          container.style.pointerEvents = 'none';
          container.innerHTML = `
            <i class="fa fa-file fa-4x text-muted mb-3"></i>
            <p class="text-muted text-center mb-3">Preview not available for this file type</p>
            <a href="${existingDocCurrentFileUrl}" download="${fileName}" class="btn btn-outline-primary btn-sm">
              <i class="fa fa-download me-1"></i>Download to View
            </a>
          `;
          existingDocPreviewHost.appendChild(container);
          initializeExistingDocSignaturePad();
        }
      } catch (error) {
        console.error('Error setting document preview:', error);
        existingDocPreviewHost.innerHTML = '<div class="text-center text-muted p-4">Error loading file preview</div>';
        initializeExistingDocSignaturePad();
      }
    }

    // Set up event listeners for the "Sign" buttons on existing documents
    document.querySelectorAll('.sign-existing-doc').forEach(button => {
      button.addEventListener('click', function() {
        const fileUrl = this.getAttribute('data-file-url');
        const fileName = this.getAttribute('data-file-name');
        const attachmentId = this.getAttribute('data-attachment-id');
        
        // Set the form values
        if (signExistingAttachmentId) signExistingAttachmentId.value = attachmentId;
        if (signExistingFileName) signExistingFileName.value = fileName;
        if (currentDocumentName) currentDocumentName.textContent = fileName;
        
        // Load the document preview
        loadExistingDocPreview(fileUrl, fileName);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('signExistingModal'));
        modal.show();
      });
    });

    // Clear signature button
    if (clearExistingSignatureBtn) {
      clearExistingSignatureBtn.addEventListener('click', function(e) {
        e.preventDefault();
        clearExistingDocSignature();
      });
    }

    // Sign existing document button
    if (signExistingDocBtn) {
      signExistingDocBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (!existingDocCurrentCanvas) {
          alert('Signature surface is not available.');
          return;
        }
        if (!existingDocHasSignature) {
          alert('Please draw the customer signature before adding it to the document.');
          return;
        }
        try {
          const signatureDataUrl = existingDocCurrentCanvas.toDataURL('image/png', 0.8);
          if (signExistingSignatureData) signExistingSignatureData.value = signatureDataUrl;
          const originalHTML = this.innerHTML;
          this.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i>Processing...';
          this.disabled = true;
          cleanupExistingDocFileUrl();
          
          // Submit the form
          signExistingForm.submit();
        } catch (error) {
          console.error('Error capturing signature:', error);
          alert('Could not capture signature. Please try again.');
          this.innerHTML = '<i class="fa fa-check me-1"></i>Add Signature to Document';
          this.disabled = false;
        }
      });
    }

    // Footer sign button
    if (footerSignExistingDoc) {
      footerSignExistingDoc.addEventListener('click', function(e) {
        e.preventDefault();
        const btn = document.getElementById('signExistingDocBtn');
        if (btn) btn.click();
      });
    }

    // Cleanup on modal close
    signExistingModal.addEventListener('hidden.bs.modal', function() {
      clearExistingDocSignature();
      cleanupExistingDocFileUrl();
    });
  }

  // Prevent any automatic modal opening for completed/cancelled orders
  const orderStatus = '{{ order.status }}';
  const isFinalStatus = orderStatus === 'completed' || orderStatus === 'cancelled';
  
  // Only initialize modal functionality for non-final status orders
  if (!isFinalStatus) {
    var bootstrap = window.bootstrap || (function(){ try { return window['bootstrap']; } catch(e){ return undefined; } })();
    function showModal(el){
      if (!el) return;
      if (bootstrap && typeof bootstrap.Modal === 'function') {
        new bootstrap.Modal(el).show();
        return;
      }
      el.classList.add('show');
      el.style.display = 'block';
      el.removeAttribute('aria-hidden');
      el.setAttribute('aria-modal', 'true');
    }
    
    // Initialize action buttons to trigger modals - ONLY for active orders
    function initializeFormToggles() {
      const signatureModalEl = document.getElementById('completeModal');
      const attachmentsModalEl = document.getElementById('attachmentModal');
      const cancelModalEl = document.getElementById('cancelModal');

      // Only add event listeners if modals exist (they won't for completed/cancelled orders)
      if (signatureModalEl) {
        document.querySelectorAll('.attachment-signature-trigger').forEach(function(btn){
          btn.addEventListener('click', function(){
            showModal(signatureModalEl);
          });
        });
      }
      
      if (attachmentsModalEl) {
        document.querySelectorAll('.attachments-modal-trigger').forEach(function(btn){
          btn.addEventListener('click', function(){
            showModal(attachmentsModalEl);
          });
        });
      }
    }

    // Improved signature functionality with better drawing accuracy
      function initializeSignaturePad() {
      const attInput = document.getElementById('attachmentInput');
      const docHost = document.getElementById('docPreviewHost');
      const sigDataInput = document.getElementById('signatureDataInput');
      const clearBtn = document.getElementById('clearSignatureBtn');
      const signBtn = document.getElementById('signAndCompleteBtn');
      const form = document.getElementById('completeForm');
      const previewCanvas = document.getElementById('signaturePreviewMini');
      const previewCtx = previewCanvas ? previewCanvas.getContext('2d') : null;
      const previewWrap = document.getElementById('signaturePreviewSmall');
      // HiDPI scaling for preview canvas for crisp strokes
      if (previewCanvas && previewCtx) {
        const dpr = window.devicePixelRatio || 1;
        const cssW = previewCanvas.clientWidth || previewCanvas.width;
        const cssH = previewCanvas.clientHeight || previewCanvas.height;
        previewCanvas.width = Math.max(1, Math.floor(cssW * dpr));
        previewCanvas.height = Math.max(1, Math.floor(cssH * dpr));
        previewCanvas.style.width = cssW + 'px';
        previewCanvas.style.height = cssH + 'px';
        previewCtx.setTransform(1, 0, 0, 1, 0, 0);
        previewCtx.scale(dpr, dpr);
      }

      let drawing = false;
      let hasSignature = false;
      let currentFileUrl = null;
      let currentCanvas = null;
      let points = []; // Store points for smoother drawing

      function clearPreview() {
        if (!previewCtx || !previewCanvas) return;
        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
      }

      function createSignatureCanvas() {
        const existingCanvas = document.getElementById('signaturePad');
        if (existingCanvas) {
          existingCanvas.remove();
        }
        const container = document.getElementById('docSignContainer');
        if (!container) return null;

        const canvas = document.createElement('canvas');
        canvas.id = 'signaturePad';
        canvas.className = 'position-absolute top-0 start-0 w-100 h-100';
        canvas.style.cssText = 'cursor: crosshair; z-index: 10; display: block; pointer-events: auto; touch-action: none;';

        // Use higher resolution for better quality
        const rect = container.getBoundingClientRect();
        const scale = window.devicePixelRatio || 1;
        canvas.width = (rect.width || container.offsetWidth || 400) * scale;
        canvas.height = (rect.height || container.offsetHeight || 360) * scale;
        canvas.style.width = (canvas.width / scale) + 'px';
        canvas.style.height = (canvas.height / scale) + 'px';

        const ctx = canvas.getContext('2d');
        ctx.scale(scale, scale);
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#000000';
        ctx.globalCompositeOperation = 'source-over';

        container.appendChild(canvas);
        return canvas;
      }

      function setupCanvasEvents(canvas) {
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const scale = window.devicePixelRatio || 1;
        let lastX = 0;
        let lastY = 0;
        points = [];

        function getCanvasPosition(e) {
          const rect = canvas.getBoundingClientRect();
          let clientX, clientY;

          if (e.type.includes('touch')) {
            if (e.touches && e.touches[0]) {
              clientX = e.touches[0].clientX;
              clientY = e.touches[0].clientY;
            }
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }

          return {
            x: (clientX - rect.left) * (canvas.width / rect.width / scale),
            y: (clientY - rect.top) * (canvas.height / rect.height / scale)
          };
        }

        function beginStrokeAt(x, y) {
          drawing = true;
          points = [{x, y}];
          lastX = x;
          lastY = y;
          
          ctx.beginPath();
          ctx.moveTo(x, y);
          ctx.lineTo(x, y);
          ctx.stroke();
          
          drawToPreview(x, y, x, y);
          hasSignature = true;
          showSignatureTools();
        }

        function continueStrokeTo(x, y) {
          if (!drawing) return;
          
          points.push({x, y});
          
          // Use quadratic curves for smoother lines
          if (points.length > 2) {
            const lastPoint = points[points.length - 1];
            const controlPoint = points[points.length - 2];
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.quadraticCurveTo(controlPoint.x, controlPoint.y, lastPoint.x, lastPoint.y);
            ctx.stroke();
          } else {
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
          }
          
          drawToPreview(lastX, lastY, x, y);
          lastX = x;
          lastY = y;
        }

        function endStroke() {
          if (!drawing) return;
          drawing = false;
          points = [];
        }

        function scaleToPreview(x, y) {
          if (!previewCanvas) return { x, y };
          const scaleX = previewCanvas.width / (canvas.width / scale);
          const scaleY = previewCanvas.height / (canvas.height / scale);
          return {
            x: x * scaleX,
            y: y * scaleY
          };
        }

        function drawToPreview(fromX, fromY, toX, toY) {
          if (!previewCtx || !previewCanvas) return;
          
          const start = scaleToPreview(fromX, fromY);
          const end = scaleToPreview(toX, toY);
          
          previewCtx.beginPath();
          previewCtx.moveTo(start.x, start.y);
          previewCtx.lineTo(end.x, end.y);
          const lineScale = previewCanvas ? (previewCanvas.width / canvas.width) : 1;
          previewCtx.lineWidth = Math.max(1, (ctx.lineWidth || 2) * lineScale);
          previewCtx.lineCap = 'round';
          previewCtx.lineJoin = 'round';
          previewCtx.strokeStyle = '#000000';
          previewCtx.stroke();
        }

        function startDrawing(e) {
          e.preventDefault();
          e.stopPropagation();
          const pos = getCanvasPosition(e);
          beginStrokeAt(pos.x, pos.y);
        }

        function draw(e) {
          if (!drawing) return;
          e.preventDefault();
          e.stopPropagation();
          const pos = getCanvasPosition(e);
          continueStrokeTo(pos.x, pos.y);
        }

        function stopDrawing(e) {
          if (!drawing) return;
          e.preventDefault();
          e.stopPropagation();
          endStroke();
        }

        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch events
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing, { passive: false });
        canvas.addEventListener('touchcancel', stopDrawing, { passive: false });

        // Pointer events (preferred for pen/stylus with pressure)
        if (window.PointerEvent) {
          let pointerActive = false;
          canvas.addEventListener('pointerdown', function(e){
            e.preventDefault();
            canvas.setPointerCapture && canvas.setPointerCapture(e.pointerId);
            pointerActive = true;
            const pos = getCanvasPosition(e);
            // Apply pressure-based width if available
            const p = (typeof e.pressure === 'number' && e.pressure > 0) ? e.pressure : 0.5;
            ctx.lineWidth = Math.max(1.5, 4 * p);
            beginStrokeAt(pos.x, pos.y);
          });
          canvas.addEventListener('pointermove', function(e){
            if (!pointerActive) return;
            e.preventDefault();
            const pos = getCanvasPosition(e);
            const p = (typeof e.pressure === 'number' && e.pressure > 0) ? e.pressure : 0.5;
            ctx.lineWidth = Math.max(1.5, 4 * p);
            continueStrokeTo(pos.x, pos.y);
          });
          canvas.addEventListener('pointerup', function(e){
            if (!pointerActive) return;
            e.preventDefault();
            pointerActive = false;
            endStroke();
          });
          canvas.addEventListener('pointercancel', function(e){
            if (!pointerActive) return;
            e.preventDefault();
            pointerActive = false;
            endStroke();
          });
        }

        // Prevent scrolling on touch devices
        document.addEventListener('touchmove', function(e) {
          if (drawing) {
            e.preventDefault();
          }
        }, { passive: false });
      }

      function showSignatureTools() {
        if (clearBtn) {
          clearBtn.style.display = 'inline-block';
        }
        if (signBtn) {
          signBtn.style.display = 'inline-block';
          signBtn.disabled = false;
        }
        if (currentCanvas) {
          currentCanvas.style.display = 'block';
        }
        if (previewWrap) {
          previewWrap.style.display = 'flex';
        }
      }

      function resetSignatureSurface() {
        currentCanvas = createSignatureCanvas();
        if (!currentCanvas) return;
        setupCanvasEvents(currentCanvas);
        showSignatureTools();
      }

      function clearSignature() {
        if (currentCanvas) {
          const ctx = currentCanvas.getContext('2d');
          const scale = window.devicePixelRatio || 1;
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          ctx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
          ctx.scale(scale, scale);
        }
        clearPreview();
        hasSignature = false;
        points = [];
        if (sigDataInput) {
          sigDataInput.value = '';
        }
        if (previewWrap) {
          previewWrap.style.display = 'none';
        }
      }

      function cleanupFileUrl() {
        if (currentFileUrl) {
          try {
            URL.revokeObjectURL(currentFileUrl);
          } catch (e) {
            console.log('Error revoking URL:', e);
          }
          currentFileUrl = null;
        }
      }

      function setDocPreview(file) {
        if (!docHost) return;

        cleanupFileUrl();
        hasSignature = false;
        if (sigDataInput) {
          sigDataInput.value = '';
        }
        clearPreview();

        docHost.innerHTML = '';
        docHost.style.position = 'relative';
        docHost.style.overflow = 'hidden';

        if (!file) {
          docHost.innerHTML = '<div class="w-100 h-100 bg-white d-flex align-items-center justify-content-center"><div class="text-center text-muted"><i class="fa fa-pen fa-3x mb-3"></i><div>Draw signature here</div></div></div>';
          resetSignatureSurface();
          return;
        }

        currentFileUrl = URL.createObjectURL(file);
        const fileType = file.type || '';
        const fileName = (file.name || '').toLowerCase();

        try {
          if (fileType.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = currentFileUrl;
            img.alt = 'Document to sign';
            img.className = 'w-100 h-100';
            img.style.objectFit = 'contain';
            img.style.pointerEvents = 'none';
            img.onload = function() {
              if (!docHost.contains(img)) {
                docHost.appendChild(img);
              }
              resetSignatureSurface();
            };
          } else if (fileName.endsWith('.pdf')) {
            const pdfContainer = document.createElement('div');
            pdfContainer.className = 'w-100 h-100 position-relative';

            const iframe = document.createElement('iframe');
            iframe.src = currentFileUrl + '#toolbar=0&navpanes=0&scrollbar=0';
            iframe.title = 'PDF preview';
            iframe.className = 'w-100 h-100';
            iframe.style.border = 'none';
            iframe.style.pointerEvents = 'none';
            iframe.style.minHeight = '360px';

            pdfContainer.appendChild(iframe);
            docHost.appendChild(iframe);

            setTimeout(resetSignatureSurface, 300);
          } else {
            const container = document.createElement('div');
            container.className = 'w-100 h-100 d-flex align-items-center justify-content-center flex-column';
            container.style.pointerEvents = 'none';
            container.innerHTML = `
              <i class="fa fa-file fa-4x text-muted mb-3"></i>
              <p class="text-muted text-center mb-3">Preview not available for this file type</p>
              <a href="${currentFileUrl}" download="${file.name}" class="btn btn-outline-primary btn-sm">
                <i class="fa fa-download me-1"></i>Download to View
              </a>
            `;
            docHost.appendChild(container);
            resetSignatureSurface();
          }
        } catch (error) {
          console.error('Error setting document preview:', error);
          docHost.innerHTML = '<div class="text-center text-muted p-4">Error loading file preview</div>';
          resetSignatureSurface();
        }
      }

      function setupSignButton() {
        if (!signBtn) return;
        
        signBtn.onclick = function(e) {
          e.preventDefault();
          if (!currentCanvas) {
            alert('Signature surface is not available.');
            return;
          }
          if (!hasSignature) {
            alert('Please draw the customer signature before completing the order.');
            return;
          }
          try {
            const signatureDataUrl = currentCanvas.toDataURL('image/png', 0.8);
            if (sigDataInput) sigDataInput.value = signatureDataUrl;
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i>Processing...';
            this.disabled = true;
            cleanupFileUrl();
            
            // Submit the form
            form.submit();
          } catch (error) {
            console.error('Error capturing signature:', error);
            alert('Could not capture signature. Please try again.');
            this.innerHTML = '<i class="fa fa-check me-1"></i>Complete Order';
            this.disabled = false;
          }
        };
      }

      if (attInput) {
        attInput.addEventListener('change', function() {
          if (!this.files || !this.files[0]) {
            setDocPreview(null);
            return;
          }
          const file = this.files[0];
          setDocPreview(file);
        });
      }

      if (clearBtn) {
        clearBtn.onclick = function(e) {
          e.preventDefault();
          clearSignature();
        };
      }

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        setupSignButton();
        const footerBtn = document.getElementById('footerSignAndComplete');
        if (footerBtn) {
          footerBtn.addEventListener('click', function(e){
            e.preventDefault();
            const btn = document.getElementById('signAndCompleteBtn');
            if (btn) btn.click();
          });
        }

        const completeModalEl = document.getElementById('completeModal');
        if (completeModalEl) {
          completeModalEl.addEventListener('shown.bs.modal', function(){
            setTimeout(function(){
              setDocPreview(attInput && attInput.files && attInput.files[0] ? attInput.files[0] : null);
            }, 200);
          });
          completeModalEl.addEventListener('hidden.bs.modal', function(){
            clearSignature();
          });
        }
      });

      setDocPreview(attInput && attInput.files && attInput.files[0] ? attInput.files[0] : null);
      setupSignButton();
      window.addEventListener('beforeunload', cleanupFileUrl);
    }
  }

  // Time tracking functions - ALWAYS initialize these regardless of status
  function statusBadge(status){
    switch(status){
      case 'created': return '<span class="badge bg-secondary">Start</span>';
      case 'in_progress': return '<span class="badge bg-warning text-dark">In Progress</span>';
      case 'overdue': return '<span class="badge bg-danger">Overdue</span>';
      case 'completed': return '<span class="badge bg-success">Completed</span>';
      case 'cancelled': return '<span class="badge bg-dark">Cancelled</span>';
      default: return '<span class="badge bg-light text-dark">'+(status||'-')+'</span>';
    }
  }
  
  function parseTimestamp(value){
    if(!value) return null;
    const dt = new Date(value);
    return Number.isNaN(dt.getTime()) ? null : dt;
  }
  
  function formatMinutes(value){
    if(value === null || value === undefined || Number.isNaN(value)) return '0m';
    const total = Math.max(0, Math.round(value));
    const hours = Math.floor(total / 60);
    const minutes = total % 60;
    if(hours && minutes){ return `${hours}h ${minutes}m`; }
    if(hours){ return `${hours}h`; }
    return `${minutes}m`;
  }
  
  function describeStatus(status){
    switch(status){
      case 'completed': return 'Completed';
      case 'cancelled': return 'Cancelled';
            case 'in_progress': return 'In progress';
      case 'overdue': return 'Overdue';
      case 'created': return 'Created';
      default: return status ? status.replace(/_/g, ' ') : '';
    }
  }
  
  const timeState = {
    status: '{{ order.status }}',
    estimatedMinutes: {{ order.estimated_duration|default_if_none:"null" }},
    actualMinutes: {{ order.actual_duration|default_if_none:"null" }},
    createdAt: parseTimestamp('{{ order.created_at|date:"c" }}'),
    startedAt: parseTimestamp('{{ order.started_at|date:"c" }}'),
    completedAt: parseTimestamp('{{ order.completed_at|date:"c" }}'),
    cancelledAt: parseTimestamp('{{ order.cancelled_at|date:"c" }}')
  };
  
  const timeEls = {
    estimate: document.getElementById('timeEstimateValue'),
    elapsed: document.getElementById('timeElapsedValue'),
    actual: document.getElementById('timeActualValue'),
    remaining: document.getElementById('timeRemainingValue'),
    startLabel: document.getElementById('timeStartLabel'),
    statusMessage: document.getElementById('timeStatusMessage'),
    progressBar: document.getElementById('orderTimeProgressBar')
  };
  
  function progressBarClassFor(status, exceeded){
    if(exceeded && status !== 'completed' && status !== 'cancelled') return 'bg-danger';
    switch(status){
      case 'completed': return 'bg-success';
      case 'cancelled': return 'bg-secondary';
      case 'overdue': return 'bg-danger';
      case 'in_progress': return 'bg-warning';
      default: return 'bg-primary';
    }
  }
  
  function applyProgressClass(newClass){
    if(!timeEls.progressBar) return;
    timeEls.progressBar.classList.remove('bg-primary','bg-success','bg-warning','bg-secondary','bg-danger','time-progress-over');
    timeEls.progressBar.classList.add(newClass);
  }
  
  function updateTimeTrackingDisplay(){
    if(!timeEls.progressBar) return;
    const now = new Date();
    const start = timeState.startedAt || timeState.createdAt;
    if(!start){
      timeEls.progressBar.style.width = '0%';
      timeEls.progressBar.setAttribute('aria-valuenow','0');
      if(timeEls.elapsed) timeEls.elapsed.textContent = '--';
      if(timeEls.remaining) timeEls.remaining.textContent = 'Remaining: --';
      if(timeEls.statusMessage) timeEls.statusMessage.textContent = 'Timing will begin when this order starts.';
      return;
    }
    
    const closingTime = (timeState.status === 'completed' && timeState.completedAt) ? timeState.completedAt :
                        (timeState.status === 'cancelled' && timeState.cancelledAt) ? timeState.cancelledAt :
                        now;
    let elapsed = (closingTime.getTime() - start.getTime()) / 60000;
    if(elapsed < 0){ elapsed = 0; }
    const roundedElapsed = Math.round(elapsed);
    
    if(timeEls.elapsed) timeEls.elapsed.textContent = formatMinutes(elapsed);
    if(timeEls.startLabel){
      const prefix = timeState.startedAt ? 'Started' : 'Created';
      timeEls.startLabel.textContent = `${prefix} ${start.toLocaleString()}`;
    }
    
    let exceeded = false;
    if(timeState.estimatedMinutes && timeState.estimatedMinutes > 0){
      const ratio = (elapsed / timeState.estimatedMinutes) * 100;
      exceeded = ratio > 100;
      const percent = Math.min(100, Math.round(ratio));
      timeEls.progressBar.style.width = `${percent}%`;
      timeEls.progressBar.setAttribute('aria-valuenow', String(Math.round(ratio)));
      
      if(timeEls.remaining){
        if(exceeded && timeState.status !== 'completed' && timeState.status !== 'cancelled'){
          const overrun = Math.max(0, Math.round(elapsed - timeState.estimatedMinutes));
          timeEls.remaining.textContent = `Exceeded by ${formatMinutes(overrun)}`;
        } else {
          const remaining = Math.max(0, Math.round(timeState.estimatedMinutes - elapsed));
          timeEls.remaining.textContent = `Remaining: ${formatMinutes(remaining)}`;
        }
      }
      
      if(timeEls.estimate){
        timeEls.estimate.textContent = `${formatMinutes(timeState.estimatedMinutes)} est.`;
      }
      
      if(exceeded && timeState.status !== 'completed' && timeState.status !== 'cancelled'){
        timeEls.progressBar.classList.add('time-progress-over');
      } else {
        timeEls.progressBar.classList.remove('time-progress-over');
      }
      applyProgressClass(progressBarClassFor(timeState.status, exceeded));
    } else {
      timeEls.progressBar.style.width = '0%';
      timeEls.progressBar.setAttribute('aria-valuenow','0');
      if(timeEls.estimate) timeEls.estimate.textContent = 'No estimate';
      if(timeEls.remaining) timeEls.remaining.textContent = 'Remaining: --';
      applyProgressClass(progressBarClassFor(timeState.status, false));
    }
    
    if(timeEls.actual){
      if(timeState.status === 'completed' || timeState.status === 'cancelled'){
        const actualMinutes = timeState.actualMinutes != null ? timeState.actualMinutes : roundedElapsed;
        timeEls.actual.textContent = `${formatMinutes(actualMinutes)} actual`;
      } else {
        timeEls.actual.textContent = 'Pending';
      }
    }
    
    if(timeEls.statusMessage){
      let msgText = `${describeStatus(timeState.status)}.`;
      let perfBadge = '';
      if(timeState.status === 'completed' && timeState.completedAt){
        msgText = `Completed on ${timeState.completedAt.toLocaleString()}.`;
        if(timeState.estimatedMinutes && timeState.estimatedMinutes > 0){
          const actualMin = (timeState.actualMinutes != null) ? timeState.actualMinutes : roundedElapsed;
          const ratio = actualMin / timeState.estimatedMinutes;
          let label = '';
          let klass = '';
          if(ratio <= 1){ label = 'On estimate'; klass = 'badge bg-success'; }
          else if(ratio <= 1.10){ label = 'Within 10%'; klass = 'badge bg-warning text-dark'; }
          else { label = 'Exceeded estimate'; klass = 'badge bg-danger'; }
          perfBadge = ` <span class="${klass}">${label}</span>`;
        }
      } else if(timeState.status === 'cancelled' && timeState.cancelledAt){
        msgText = `Cancelled on ${timeState.cancelledAt.toLocaleString()}.`;
      } else if(exceeded){
        msgText = 'This order is taking longer than estimated.';
      } else if(timeState.status === 'in_progress'){
        msgText = 'Order is actively in progress.';
      } else if(timeState.status === 'created'){
        msgText = 'Order is created and awaiting processing.';
      }
      timeEls.statusMessage.innerHTML = msgText + perfBadge;
    }
  }
  
  function syncTimeState(payload){
    if(!payload) return;
    if(Object.prototype.hasOwnProperty.call(payload, 'status')){
      timeState.status = payload.status || timeState.status;
    }
    if(Object.prototype.hasOwnProperty.call(payload, 'estimated_duration')){
      if(payload.estimated_duration === null || payload.estimated_duration === undefined){
        timeState.estimatedMinutes = null;
      } else {
        const estimate = Number(payload.estimated_duration);
        timeState.estimatedMinutes = Number.isNaN(estimate) ? timeState.estimatedMinutes : estimate;
      }
    }
    if(Object.prototype.hasOwnProperty.call(payload, 'actual_duration')){
      if(payload.actual_duration === null || payload.actual_duration === undefined){
        timeState.actualMinutes = null;
      } else {
        const actualVal = Number(payload.actual_duration);
        timeState.actualMinutes = Number.isNaN(actualVal) ? timeState.actualMinutes : actualVal;
      }
    }
    if(Object.prototype.hasOwnProperty.call(payload, 'created_at')){
      const createdAt = parseTimestamp(payload.created_at);
      if(createdAt) timeState.createdAt = createdAt;
    }
    if(Object.prototype.hasOwnProperty.call(payload, 'started_at')){
      timeState.startedAt = parseTimestamp(payload.started_at);
    }
    if(Object.prototype.hasOwnProperty.call(payload, 'completed_at')){
      timeState.completedAt = parseTimestamp(payload.completed_at);
    }
    if(Object.prototype.hasOwnProperty.call(payload, 'cancelled_at')){
      timeState.cancelledAt = parseTimestamp(payload.cancelled_at);
    }
  }

  // ============================================================================
  // FILE UPLOAD AND DOCUMENT PREVIEW FUNCTIONALITY
  // ============================================================================
  (function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('attachmentsInput');
    const filePreviewContainer = document.getElementById('filePreviewContainer');
    const selectedFilesDiv = document.getElementById('selectedFiles');
    const uploadBtn = document.getElementById('uploadFilesBtn');
    let selectedFiles = [];

    if (dropZone && fileInput) {
      dropZone.addEventListener('click', () => fileInput.click());

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '#e9ecef';
        dropZone.style.borderColor = '#0d6efd';
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = '';
        dropZone.style.borderColor = '#dee2e6';
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '';
        dropZone.style.borderColor = '#dee2e6';
        const files = e.dataTransfer.files;
        fileInput.files = files;
        updateFilePreview(files);
      });

      fileInput.addEventListener('change', () => {
        updateFilePreview(fileInput.files);
      });
    }

    function updateFilePreview(files) {
      selectedFiles = Array.from(files);
      selectedFilesDiv.innerHTML = '';
      filePreviewContainer.innerHTML = '';
      uploadBtn.disabled = selectedFiles.length === 0;

      if (selectedFiles.length === 0) {
        filePreviewContainer.innerHTML = '<div class="text-center text-muted"><i class="fa fa-images fa-3x mb-3 d-block opacity-50"></i><small>Selected files will appear here</small></div>';
        return;
      }

      selectedFilesDiv.innerHTML = '<h6 class="text-muted mb-2"><i class="fa fa-file-check me-2 text-success"></i>Selected Files (' + selectedFiles.length + ')</h6>';
      let previewHTML = '';

      selectedFiles.forEach((file, index) => {
        const fileName = file.name;
        const fileSize = (file.size / 1024).toFixed(2);
        const isImage = file.type.startsWith('image/');
        const isPdf = file.type === 'application/pdf';

        selectedFilesDiv.innerHTML += `
          <div class="d-flex align-items-center justify-content-between mb-2 p-2 border rounded" style="background-color: #f8f9fa;">
            <div class="d-flex align-items-center flex-grow-1">
              <i class="fa fa-check-circle text-success me-2"></i>
              <div>
                <small class="d-block fw-medium">${fileName}</small>
                <small class="text-muted">${fileSize} KB</small>
              </div>
            </div>
          </div>
        `;

        if (isImage) {
          const reader = new FileReader();
          reader.onload = (e) => {
            previewHTML += `
              <div class="mb-3">
                <small class="text-muted d-block mb-2">${fileName}</small>
                <img src="${e.target.result}" alt="${fileName}" style="max-width: 100%; max-height: 150px; border-radius: 4px; border: 1px solid #dee2e6;">
              </div>
            `;
            filePreviewContainer.innerHTML = previewHTML;
          };
          reader.readAsDataURL(file);
        } else if (isPdf) {
          previewHTML += `
            <div class="mb-3">
              <small class="text-muted d-block mb-2">${fileName}</small>
              <div class="text-center p-3 border rounded" style="background-color: #f8f9fa;">
                <i class="fa fa-file-pdf text-danger fa-3x"></i>
                <small class="d-block text-muted mt-2">PDF file: ${fileName}</small>
              </div>
            </div>
          `;
          filePreviewContainer.innerHTML = previewHTML;
        } else {
          previewHTML += `
            <div class="mb-3">
              <small class="text-muted d-block mb-2">${fileName}</small>
              <div class="text-center p-3 border rounded" style="background-color: #f8f9fa;">
                <i class="fa fa-file text-muted fa-3x"></i>
                <small class="d-block text-muted mt-2">${fileName}</small>
              </div>
            </div>
          `;
          filePreviewContainer.innerHTML = previewHTML;
        }
      });
    }
  })();

  // ============================================================================
  // DOCUMENT SELECTION AND SIGNATURE MODAL FUNCTIONALITY
  // ============================================================================
  (function() {
    // Main signature modal document selection
    const docSelectors = document.querySelectorAll('.doc-selector');
    const selectedDocInfo = document.getElementById('selectedDocInfo');
    const selectedDocName = document.getElementById('selectedDocName');
    const selectedDocumentInput = document.getElementById('selectedDocumentInput');
    const docPreviewSection = document.getElementById('existingDocPreviewSection');

    docSelectors.forEach(selector => {
      selector.addEventListener('change', function() {
        if (this.checked && selectedDocumentInput) {
          selectedDocumentInput.value = this.value;
          if (selectedDocInfo && selectedDocName) {
            selectedDocName.textContent = this.dataset.docName || 'Selected Document';
            selectedDocInfo.style.display = 'block';
          }
        }
      });
    });

    // Supporting documents modal document selection
    const existingDocSelectors = document.querySelectorAll('.existing-doc-selector');
    const existingSelectedDocInfo = document.getElementById('existingSelectedDocInfo');
    const existingSelectedDocName = document.getElementById('existingSelectedDocName');
    const signExistingAttachmentId = document.getElementById('signExistingAttachmentId');
    const signExistingFileName = document.getElementById('signExistingFileName');

    existingDocSelectors.forEach(selector => {
      selector.addEventListener('change', function() {
        if (this.checked) {
          if (signExistingAttachmentId) signExistingAttachmentId.value = this.dataset.attachmentId || '';
          if (signExistingFileName) signExistingFileName.value = this.dataset.docName || '';
          if (existingSelectedDocInfo && existingSelectedDocName) {
            existingSelectedDocName.textContent = this.dataset.docName || 'Selected Document';
            existingSelectedDocInfo.style.display = 'block';
          }
        }
      });
    });

    // Make footer buttons trigger their respective form submissions
    const footerSignAndComplete = document.getElementById('footerSignAndComplete');
    if (footerSignAndComplete) {
      footerSignAndComplete.addEventListener('click', function(e) {
        e.preventDefault();
        const completeForm = document.getElementById('completeForm');
        const sigDataInput = document.getElementById('signatureDataInput');
        const signaturePad = document.getElementById('signaturePad');

        if (signaturePad && sigDataInput) {
          const signatureDataUrl = signaturePad.toDataURL('image/png', 0.8);
          sigDataInput.value = signatureDataUrl;
        }

        if (completeForm) {
          completeForm.submit();
        }
      });
    }

    const footerSignExistingDoc = document.getElementById('footerSignExistingDoc');
    if (footerSignExistingDoc) {
      footerSignExistingDoc.addEventListener('click', function(e) {
        e.preventDefault();
        const signExistingForm = document.getElementById('signExistingForm');
        const signExistingSignatureData = document.getElementById('signExistingSignatureData');
        const existingDocSignaturePad = document.getElementById('existingDocSignaturePad');

        if (existingDocSignaturePad && signExistingSignatureData) {
          const signatureDataUrl = existingDocSignaturePad.toDataURL('image/png', 0.8);
          signExistingSignatureData.value = signatureDataUrl;
        }

        if (signExistingForm) {
          signExistingForm.submit();
        }
      });
    }
  })();

  // ============================================================================
  // ADDITIONAL INVOICE UPLOAD & EXTRACTION FUNCTIONALITY
  // ============================================================================
  (function() {
    const additionalFileInput = document.getElementById('additionalInvoiceFile');
    const additionalUploadBtn = document.getElementById('additionalUploadBtn');
    const additionalErrorBox = document.getElementById('additionalUploadError');
    const additionalSuccessMsg = document.getElementById('additionalExtractionSuccess');
    const additionalProgressWrap = document.getElementById('additionalUploadProgress');
    const additionalProgressBar = document.getElementById('additionalUploadProgressBar');
    const additionalPreviewSection = document.getElementById('additionalExtractedDataPreview');
    const additionalLineItemsSection = document.getElementById('additionalExtractedLineItemsSection');
    const additionalLineItemsBody = document.getElementById('additionalLineItemsBody');
    const additionalHiddenFieldsDiv = document.getElementById('additionalInvoiceHiddenFields');
    const additionalInvoiceForm = document.getElementById('additionalInvoiceForm');
    const addAdditionalInvoiceBtn = document.getElementById('addAdditionalInvoiceBtn');

    if (!additionalUploadBtn) return;

    function getCSRF() {
      const name = 'csrftoken=';
      const parts = document.cookie.split(';');
      for (let i = 0; i < parts.length; i++) {
        const c = parts[i].trim();
        if (c.indexOf(name) === 0) return c.substring(name.length);
      }
      const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
      return el ? el.value : '';
    }

    function setAdditionalProgress(p) {
      if (additionalProgressBar) additionalProgressBar.style.width = Math.max(0, Math.min(100, p)) + '%';
      if (additionalProgressWrap) additionalProgressWrap.style.display = p > 0 && p < 100 ? 'block' : (p >= 100 ? 'block' : 'none');
    }

    function populateAdditionalLineItems(items) {
      additionalLineItemsBody.innerHTML = '';

      if (!items || items.length === 0) {
        additionalLineItemsSection.style.display = 'none';
        return;
      }

      additionalLineItemsSection.style.display = 'block';

      items.forEach((item, idx) => {
        const code = item.code || '';
        const desc = item.description || '';
        const unit = item.unit || '';
        const qty = item.qty || 1;
        const rate = item.rate || 0;
        const value = item.value || (qty * rate);

        const row = document.createElement('tr');
        row.dataset.itemIndex = idx;
        row.innerHTML = `
          <td style="text-align: center;"><small>${idx + 1}</small></td>
          <td><small>${code}</small></td>
          <td><small>${desc}</small></td>
          <td><small>${unit}</small></td>
          <td style="text-align: center;"><small>${qty}</small></td>
          <td style="text-align: right;"><small>${parseFloat(rate).toLocaleString('en-US', {minimumFractionDigits: 2})}</small></td>
          <td style="text-align: right;"><small><strong>${value.toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></small></td>
        `;
        additionalLineItemsBody.appendChild(row);

        const fields = [
          { name: 'item_code[]', value: code },
          { name: 'item_description[]', value: desc },
          { name: 'item_unit[]', value: unit },
          { name: 'item_qty[]', value: qty },
          { name: 'item_price[]', value: rate },
          { name: 'item_value[]', value: value }
        ];

        fields.forEach(field => {
          const inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = field.name;
          inp.value = field.value;
          inp.dataset.itemIndex = idx;
          additionalHiddenFieldsDiv.appendChild(inp);
        });
      });
    }

    function populateAdditionalFormFields(header) {
      const invoiceNumber = header.invoice_no || '';
      const invoiceDate = header.date || '';
      const subtotal = header.subtotal || 0;
      const tax = header.tax || 0;
      const total = header.total || 0;

      const fields = [
        { name: 'invoice_number', value: invoiceNumber },
        { name: 'invoice_date', value: invoiceDate },
        { name: 'subtotal', value: subtotal },
        { name: 'tax_amount', value: tax },
        { name: 'total_amount', value: total },
        { name: 'code_no', value: header.code_no || '' },
        { name: 'reference', value: header.reference || '' }
      ];

      fields.forEach(field => {
        let inp = additionalInvoiceForm.querySelector(`[name="${field.name}"]`);
        if (!inp) {
          inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = field.name;
          additionalHiddenFieldsDiv.appendChild(inp);
        }
        inp.value = field.value;
      });
    }

    function displayAdditionalPreview(header) {
      document.getElementById('additionalPreviewInvoiceNumber').textContent = header.invoice_no || '-';
      document.getElementById('additionalPreviewInvoiceDate').textContent = header.date || '-';
      document.getElementById('additionalPreviewSubtotal').textContent = parseFloat(header.subtotal || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
      document.getElementById('additionalPreviewTax').textContent = parseFloat(header.tax || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
      document.getElementById('additionalPreviewTotal').textContent = parseFloat(header.total || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
    }

    additionalUploadBtn.addEventListener('click', async function() {
      if (!additionalFileInput || !additionalFileInput.files || !additionalFileInput.files[0]) {
        additionalErrorBox.style.display = 'block';
        additionalErrorBox.innerHTML = '<i class="fa fa-warning me-2"></i>Please select a PDF file to upload.';
        additionalErrorBox.className = 'alert alert-warning';
        return;
      }

      const file = additionalFileInput.files[0];
      const maxSize = parseInt(additionalFileInput.dataset.maxFileSize) || 50485760;

      if (file.size > maxSize) {
        additionalErrorBox.style.display = 'block';
        additionalErrorBox.innerHTML = `<i class="fa fa-warning me-2"></i>File is too large. Maximum size is ${(maxSize / 1024 / 1024).toFixed(1)}MB.`;
        additionalErrorBox.className = 'alert alert-warning';
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('csrfmiddlewaretoken', getCSRF());

      setAdditionalProgress(10);
      additionalUploadBtn.disabled = true;
      additionalUploadBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Uploading...';

      try {
        const response = await fetch('/api/invoices/extract-preview/', {
          method: 'POST',
          body: formData
        });

        setAdditionalProgress(70);

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          additionalErrorBox.style.display = 'none';
          additionalSuccessMsg.style.display = 'block';
          additionalPreviewSection.style.display = 'block';

          const header = data.header || {};
          const items = data.items || [];

          displayAdditionalPreview(header);
          populateAdditionalFormFields(header);
          populateAdditionalLineItems(items);

          addAdditionalInvoiceBtn.disabled = false;
          setAdditionalProgress(100);

          setTimeout(() => { setAdditionalProgress(0); }, 1000);
        } else {
          throw new Error(data.message || 'Failed to extract invoice data');
        }
      } catch (err) {
        additionalErrorBox.style.display = 'block';
        additionalErrorBox.innerHTML = '<i class="fa fa-exclamation-triangle me-2"></i>' + (err?.message || 'Failed to upload or extract invoice');
        additionalErrorBox.className = 'alert alert-danger';
        console.error('Upload error:', err);
        setAdditionalProgress(0);
      } finally {
        additionalUploadBtn.disabled = false;
        additionalUploadBtn.innerHTML = '<i class="fa fa-upload me-2"></i>Upload & Extract';
      }
    });

    additionalInvoiceForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      if (!additionalFileInput.files || !additionalFileInput.files[0]) {
        additionalErrorBox.style.display = 'block';
        additionalErrorBox.innerHTML = '<i class="fa fa-warning me-2"></i>No PDF file was uploaded or extracted.';
        additionalErrorBox.className = 'alert alert-warning';
        return;
      }

      addAdditionalInvoiceBtn.disabled = true;
      const originalBtnText = addAdditionalInvoiceBtn.innerHTML;
      addAdditionalInvoiceBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Adding...';

      try {
        const formData = new FormData(additionalInvoiceForm);

        const response = await fetch(additionalInvoiceForm.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          additionalErrorBox.style.display = 'none';
          additionalSuccessMsg.innerHTML = '<i class="fa fa-check-circle me-2"></i>Invoice added successfully! Reloading...';
          additionalSuccessMsg.style.display = 'block';

          setTimeout(() => {
            location.reload();
          }, 1500);
        } else {
          throw new Error(data.message || 'Failed to add invoice');
        }
      } catch (err) {
        additionalErrorBox.style.display = 'block';
        additionalErrorBox.innerHTML = '<i class="fa fa-exclamation-triangle me-2"></i>' + (err?.message || 'Failed to add invoice');
        additionalErrorBox.className = 'alert alert-danger';
        console.error('Form submission error:', err);
      } finally {
        addAdditionalInvoiceBtn.disabled = false;
        addAdditionalInvoiceBtn.innerHTML = originalBtnText;
      }
    });
  })();

  // ============================================================================
  // SUPPORTING DOCUMENTS SIGNING FUNCTIONALITY (only for completed orders)
  // ============================================================================
  (function() {
    const supportingDocSelectors = document.querySelectorAll('.supporting-doc-selector');
    const supportingDocSelectedInfo = document.getElementById('supportingDocSelectedInfo');
    const supportingDocSelectedName = document.getElementById('supportingDocSelectedName');
    const supportingDocAttachmentId = document.getElementById('supportingDocAttachmentId');
    const supportingDocSignatureData = document.getElementById('supportingDocSignatureData');
    const signSupportingDocBtn = document.getElementById('footerSignSupportingDoc');
    let supportingDocSignaturePad = document.getElementById('supportingDocSignaturePad');
    const supportingDocContainer = document.getElementById('supportingDocSignContainer');
    const supportingDocPreviewHost = document.getElementById('supportingDocPreviewHost');
    const clearSupportingDocSignBtn = document.getElementById('clearSupportingDocSignatureBtn');
    const supportingDocSignaturePreviewSmall = document.getElementById('supportingDocSignaturePreviewSmall');
    const supportingDocSignPreviewMini = document.getElementById('supportingDocSignaturePreviewMini');
    const supportingDocPreviewSection = document.getElementById('supportingDocPreviewSection');
    const supportingDocSignPreviewHost = document.getElementById('supportingDocSignPreviewHost');

    let currentSupportingDocFile = null;
    let supportingDocSignatureCanvas = null;
    let supportingDocPoints = [];
    let supportingDocDrawing = false;
    let supportingDocHasSignature = false;

    // Document selector change handler
    supportingDocSelectors.forEach(selector => {
      selector.addEventListener('change', function() {
        if (this.checked) {
          supportingDocAttachmentId.value = this.dataset.attachmentId || '';
          supportingDocSelectedName.textContent = this.dataset.docName || 'Selected Document';
          supportingDocSelectedInfo.style.display = 'block';
          displaySupportingDocPreview(this.dataset.docUrl);
          supportingDocSignaturePad = createSupportingDocSignatureCanvas();
          if (supportingDocSignaturePad) {
            supportingDocSignaturePad.style.pointerEvents = 'auto';
            supportingDocSignaturePad.style.touchAction = 'none';
            resetSupportingDocSignature();
            setupSupportingDocCanvasEvents(supportingDocSignaturePad);
          }
        }
      });
    });

    function displaySupportingDocPreview(docUrl) {
      if (!docUrl) return;

      supportingDocPreviewSection.style.display = 'block';
      supportingDocPreviewHost.innerHTML = '';

      const docName = docUrl.toLowerCase();
      if (docName.includes('.pdf')) {
        const iframe = document.createElement('iframe');
        iframe.src = docUrl + '#toolbar=0&navpanes=0&scrollbar=0';
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        supportingDocPreviewHost.appendChild(iframe);
      } else if (docName.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        const img = document.createElement('img');
        img.src = docUrl;
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        img.style.objectFit = 'contain';
        supportingDocPreviewHost.appendChild(img);
      } else {
        supportingDocPreviewHost.innerHTML = '<div class="text-center text-muted"><i class="fa fa-file fa-3x mb-3"></i><p>Document preview not available</p></div>';
      }
    }

    function createSupportingDocSignatureCanvas() {
      if (supportingDocSignaturePad) {
        supportingDocSignaturePad.style.display = 'block';
        return supportingDocSignaturePad;
      }
      return null;
    }

    function resetSupportingDocSignature() {
      supportingDocDrawing = false;
      supportingDocHasSignature = false;
      supportingDocPoints = [];
      if (supportingDocSignaturePad) {
        supportingDocSignaturePad.width = supportingDocSignaturePad.offsetWidth * window.devicePixelRatio;
        supportingDocSignaturePad.height = supportingDocSignaturePad.offsetHeight * window.devicePixelRatio;
        const ctx = supportingDocSignaturePad.getContext('2d');
        ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        ctx.clearRect(0, 0, supportingDocSignaturePad.width, supportingDocSignaturePad.height);
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#000000';
      }
      if (clearSupportingDocSignBtn) clearSupportingDocSignBtn.style.display = 'none';
      if (supportingDocSignaturePreviewSmall) supportingDocSignaturePreviewSmall.style.display = 'none';
    }

    function drawToSupportingDocPreview(x0, y0, x1, y1) {
      if (!supportingDocSignPreviewMini) return;
      const ctx = supportingDocSignPreviewMini.getContext('2d');
      ctx.beginPath();
      ctx.moveTo(x0, y0);
      ctx.lineTo(x1, y1);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 1.5;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.stroke();
    }

    function setupSupportingDocCanvasEvents(canvas) {
      if (!canvas) return;

      let lastX = 0;
      let lastY = 0;

      canvas.addEventListener('mousedown', (e) => {
        supportingDocDrawing = true;
        supportingDocHasSignature = true;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left);
        const y = (e.clientY - rect.top);
        supportingDocPoints.push({x, y});
        const ctx = canvas.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(x, y);
        lastX = x;
        lastY = y;
      });

      canvas.addEventListener('mousemove', (e) => {
        if (!supportingDocDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left);
        const y = (e.clientY - rect.top);
        supportingDocPoints.push({x, y});
        const ctx = canvas.getContext('2d');
        if (supportingDocPoints.length > 2) {
          const lastPoint = supportingDocPoints[supportingDocPoints.length - 1];
          const controlPoint = supportingDocPoints[supportingDocPoints.length - 2];
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.quadraticCurveTo(controlPoint.x, controlPoint.y, lastPoint.x, lastPoint.y);
          ctx.stroke();
        } else {
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
        }
        drawToSupportingDocPreview(lastX, lastY, x, y);
        lastX = x;
        lastY = y;
      });

      canvas.addEventListener('mouseup', () => {
        if (supportingDocDrawing && supportingDocHasSignature) {
          if (clearSupportingDocSignBtn) clearSupportingDocSignBtn.style.display = 'inline-block';
          if (supportingDocSignaturePreviewSmall) supportingDocSignaturePreviewSmall.style.display = 'flex';
        }
        supportingDocDrawing = false;
      });

      // Touch support
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        supportingDocDrawing = true;
        supportingDocHasSignature = true;
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        const x = (t.clientX - rect.left);
        const y = (t.clientY - rect.top);
        supportingDocPoints.push({x, y});
        const ctx = canvas.getContext('2d');
        ctx.beginPath();
        ctx.moveTo(x, y);
        lastX = x;
        lastY = y;
      }, { passive: false });

      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!supportingDocDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const t = e.touches[0];
        const x = (t.clientX - rect.left);
        const y = (t.clientY - rect.top);
        supportingDocPoints.push({x, y});
        const ctx = canvas.getContext('2d');
        if (supportingDocPoints.length > 2) {
          const lastPoint = supportingDocPoints[supportingDocPoints.length - 1];
          const controlPoint = supportingDocPoints[supportingDocPoints.length - 2];
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.quadraticCurveTo(controlPoint.x, controlPoint.y, lastPoint.x, lastPoint.y);
          ctx.stroke();
        } else {
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
        }
        drawToSupportingDocPreview(lastX, lastY, x, y);
        lastX = x;
        lastY = y;
      }, { passive: false });

      canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        if (supportingDocDrawing && supportingDocHasSignature) {
          if (clearSupportingDocSignBtn) clearSupportingDocSignBtn.style.display = 'inline-block';
          if (supportingDocSignaturePreviewSmall) supportingDocSignaturePreviewSmall.style.display = 'flex';
        }
        supportingDocDrawing = false;
      });
    }

    function clearSupportingDocSignature() {
      resetSupportingDocSignature();
      if (supportingDocSignPreviewMini) {
        const ctx = supportingDocSignPreviewMini.getContext('2d');
        ctx.clearRect(0, 0, supportingDocSignPreviewMini.width, supportingDocSignPreviewMini.height);
      }
    }

    if (clearSupportingDocSignBtn) {
      clearSupportingDocSignBtn.addEventListener('click', function(e) {
        e.preventDefault();
        clearSupportingDocSignature();
      });
    }

    // Sign and save supporting document
    if (signSupportingDocBtn) {
      signSupportingDocBtn.addEventListener('click', function(e) {
        e.preventDefault();

        if (!supportingDocAttachmentId.value) {
          alert('Please select a document to sign.');
          return;
        }

        if (!supportingDocSignaturePad || !supportingDocHasSignature) {
          alert('Please draw a signature.');
          return;
        }

        const signatureDataUrl = supportingDocSignaturePad.toDataURL('image/png', 0.8);
        supportingDocSignatureData.value = signatureDataUrl;

        const formData = new FormData();
        formData.append('attachment_id', supportingDocAttachmentId.value);
        formData.append('signature_data', signatureDataUrl);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name="csrfmiddlewaretoken"]').value);

        signSupportingDocBtn.disabled = true;
        signSupportingDocBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Signing...';

        fetch('{% url "tracker:sign_supporting_documents" pk=order.id %}', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Document signed successfully!');
            const modalEl = document.getElementById('signSupportingDocsModal');
            try {
              const modal = (window.bootstrap && window.bootstrap.Modal) ? window.bootstrap.Modal.getInstance(modalEl) : null;
              if (modal) {
                modal.hide();
              } else if (modalEl) {
                modalEl.classList.remove('show');
                modalEl.style.display = 'none';
                modalEl.setAttribute('aria-hidden', 'true');
              }
            } catch (e) {}
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Could not sign document'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error signing document: ' + error.message);
        })
        .finally(() => {
          signSupportingDocBtn.disabled = false;
          signSupportingDocBtn.innerHTML = '<i class="fa fa-check-circle me-2"></i>Sign & Save Document';
        });
      });
    }

    // Handle supporting document sign button click
    document.querySelectorAll('.supporting-doc-sign-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        supportingDocSignaturePad = createSupportingDocSignatureCanvas();
        if (supportingDocSignaturePad) {
          supportingDocSignaturePad.style.pointerEvents = 'auto';
          supportingDocSignaturePad.style.touchAction = 'none';
          resetSupportingDocSignature();
          setupSupportingDocCanvasEvents(supportingDocSignaturePad);
        }
      });
    });

    // Ensure signature pad is initialized when switching to Signature tab inside the modal
    const supportingDocSignTab = document.getElementById('supportingDocSignTab');
    if (supportingDocSignTab) {
      supportingDocSignTab.addEventListener('shown.bs.tab', function() {
        supportingDocSignaturePad = createSupportingDocSignatureCanvas();
        if (supportingDocSignaturePad) {
          supportingDocSignaturePad.style.pointerEvents = 'auto';
          supportingDocSignaturePad.style.touchAction = 'none';
          resetSupportingDocSignature();
          setupSupportingDocCanvasEvents(supportingDocSignaturePad);
        }
      });
    }
  })();

  // Initialize everything when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing components');
    
    // Initialize PDF embeds for ALL orders (completed/cancelled too)
    initializePdfEmbeds();
    
    // Only initialize modal-related functionality for active orders
    if (!isFinalStatus) {
      initializeFormToggles();
      initializeSignaturePad();
      initializeExistingDocSigning();
    } else {
      console.log('Order is completed or cancelled - skipping modal initialization');
    }
    
    // Always initialize time tracking
    updateTimeTrackingDisplay();
    
    // Set up auto-refresh for time tracking (works for all statuses)
    const id = {{ order.id }};
    function refresh(){
      fetch(`/api/orders/${id}/status/`)
        .then(r=>r.json()).then(j=>{
          if(!j.success) return;
          syncTimeState(j);
          updateTimeTrackingDisplay();
          const badgeHost = document.getElementById('orderStatusBadge');
          if(badgeHost){ badgeHost.innerHTML = statusBadge(j.status); }
        });
    }
    
    setInterval(() => { 
      if(!document.hidden) updateTimeTrackingDisplay(); 
    }, 1000);
    
    setInterval(refresh, 12000);
    
    document.addEventListener('visibilitychange', () => { 
      if(!document.hidden){ 
        refresh(); 
        updateTimeTrackingDisplay(); 
      } 
    });
    
    refresh();

    // Initialize invoice upload modal for order detail page
    const orderUploadBtn = document.getElementById('orderUploadInvoiceBtn');
    const uploadInvoiceModal = document.getElementById('uploadInvoiceModal');

    if (orderUploadBtn && uploadInvoiceModal) {
      const modal = new bootstrap.Modal(uploadInvoiceModal);
      orderUploadBtn.addEventListener('click', function() {
        modal.show();
      });
    }

    // Initialize additional invoice upload handler
    initializeAdditionalInvoiceUpload();
  });

  function initializeAdditionalInvoiceUpload() {
    if (window.__additionalInvInit) return;
    window.__additionalInvInit = true;
    const fileInput = document.getElementById('additionalInvoiceFile');
    const uploadBtn = document.getElementById('additionalUploadBtn');
    const form = document.getElementById('additionalInvoiceForm');
    const uploadError = document.getElementById('additionalUploadError');
    const uploadSuccess = document.getElementById('additionalExtractionSuccess');
    const uploadProgress = document.getElementById('additionalUploadProgress');
    const progressBar = document.getElementById('additionalUploadProgressBar');
    const submitBtn = document.getElementById('addAdditionalInvoiceBtn');
    const previewSection = document.getElementById('additionalExtractedDataPreview');
    const hiddenFieldsDiv = document.getElementById('additionalInvoiceHiddenFields');

    function getCSRF() {
      return document.querySelector('[name="csrfmiddlewaretoken"]')?.value || '';
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount);
    }

    function setProgress(percent) {
      uploadProgress.style.display = percent > 0 ? 'block' : 'none';
      progressBar.style.width = percent + '%';
    }

    uploadBtn?.addEventListener('click', async function() {
      if (this.dataset.loading === 'true') return;
      const file = fileInput?.files[0];
      if (!file) {
        uploadError.textContent = 'Please select a PDF file';
        uploadError.style.display = 'block';
        return;
      }

      uploadError.style.display = 'none';
      uploadSuccess.style.display = 'none';
      setProgress(10);
      this.dataset.loading = 'true';
      this.disabled = true;
      fileInput.disabled = true;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('X-CSRFToken', getCSRF());

      try {
        const response = await fetch('{% url "tracker:api_extract_invoice_preview" %}', {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRF()
          }
        });

        setProgress(90);

        if (!response.ok) {
          const errorData = await response.json();
          uploadError.textContent = errorData.message || 'Failed to extract invoice data';
          uploadError.style.display = 'block';
          return;
        }

        const data = await response.json();
        setProgress(100);

        if (!data.success) {
          uploadError.textContent = data.message || 'Failed to extract invoice data';
          uploadError.style.display = 'block';
          return;
        }

        // Display success
        uploadSuccess.style.display = 'block';
        previewSection.style.display = 'block';

        // Populate header information
        const header = data.header || {};
        document.getElementById('additionalPreviewInvoiceNumber').textContent = header.invoice_no || '-';
        document.getElementById('additionalPreviewInvoiceDate').textContent = header.date || '-';
        document.getElementById('additionalPreviewSubtotal').textContent = formatCurrency(header.subtotal || 0);
        document.getElementById('additionalPreviewTax').textContent = formatCurrency(header.tax || 0);
        document.getElementById('additionalPreviewTotal').textContent = formatCurrency(header.total || 0);

        // Populate line items
        const items = data.items || [];
        const lineItemsBody = document.getElementById('additionalLineItemsBody');
        lineItemsBody.innerHTML = '';

        if (items.length > 0) {
          document.getElementById('additionalExtractedLineItemsSection').style.display = 'block';

          items.forEach((item, idx) => {
            const row = document.createElement('tr');
            const typeBadge = (function(){
              const ot = String(item.order_type||'sales');
              if (ot === 'labour') return '<span class="badge bg-info"><i class="fa fa-tools me-1"></i>Labour</span>';
              if (ot === 'service') return '<span class="badge bg-primary"><i class="fa fa-wrench me-1"></i>Service</span>';
              return '<span class="badge bg-success"><i class="fa fa-shopping-cart me-1"></i>Sales</span>';
            })();
            row.innerHTML = `
              <td style="text-align: center;"><small>${idx + 1}</small></td>
              <td><small><code>${item.code || '-'}</code></small></td>
              <td><small>${item.description || '-'}</small></td>
              <td style="text-align:center;"><small>${typeBadge}</small></td>
              <td><small>${item.unit || '-'}</small></td>
              <td style="text-align: center;"><small>${item.qty || 0}</small></td>
              <td style="text-align: right;"><small>${formatCurrency(item.rate || 0)}</small></td>
              <td style="text-align: right;"><small><strong>${formatCurrency(item.value || 0)}</strong></small></td>
            `;
            lineItemsBody.appendChild(row);
          });
        } else {
          document.getElementById('additionalExtractedLineItemsSection').style.display = 'none';
        }

        // Store extracted data in hidden fields
        hiddenFieldsDiv.innerHTML = '';
        const computedVatRate = (function(){
          const s = Number(header.subtotal || 0);
          const t = Number(header.tax || 0);
          if (s > 0 && t >= 0) {
            return Number(((t / s) * 100).toFixed(2));
          }
          return 0;
        })();

        const fields = {
          'invoice_number': header.invoice_no,
          'invoice_date': header.date,
          'code_no': header.code_no,
          'reference': header.reference,
          'customer_name': header.customer_name,
          'phone': header.phone,
          'email': header.email,
          'address': header.address,
          'subtotal': header.subtotal,
          'tax_amount': header.tax,
          'tax_rate': computedVatRate,
          'total_amount': header.total
        };

        Object.keys(fields).forEach(key => {
          if (fields[key] !== undefined && fields[key] !== null) {
            const inp = document.createElement('input');
            inp.type = 'hidden';
            inp.name = key;
            inp.value = fields[key];
            hiddenFieldsDiv.appendChild(inp);
          }
        });

        items.forEach((item, idx) => {
          const pairs = [
            { name: 'item_code[]', value: item.code || '' },
            { name: 'item_description[]', value: item.description || '' },
            { name: 'item_unit[]', value: item.unit || '' },
            { name: 'item_qty[]', value: item.qty || 0 },
            { name: 'item_price[]', value: item.rate || 0 },
            { name: 'item_value[]', value: item.value || 0 },
          ];
          pairs.forEach(p => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = p.name;
            input.value = p.value;
            input.dataset.itemIndex = idx;
            hiddenFieldsDiv.appendChild(input);
          });
        });

        // Enable submit button
        submitBtn.disabled = false;
        setProgress(0);
        this.dataset.loading = 'false';
        this.disabled = false;
        fileInput.disabled = false;
      } catch (error) {
        console.error('Error uploading invoice:', error);
        uploadError.textContent = 'Error uploading invoice: ' + error.message;
        uploadError.style.display = 'block';
        setProgress(0);
        this.dataset.loading = 'false';
        this.disabled = false;
        fileInput.disabled = false;
      }
    });

    // Handle form submission
    form?.addEventListener('submit', async function(e) {
      e.preventDefault();
      if (form.dataset.submitting === 'true') return;

      const selectedOrderId = form.querySelector('input[name="selected_order_id"]').value;
      const customerId = form.querySelector('input[name="customer_id"]')?.value;

      const formData = new FormData(form);
      formData.append('commit', 'true');
      form.dataset.submitting = 'true';
      submitBtn.disabled = true;

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRF()
          }
        });

        const data = await response.json();

        if (data.success) {
          // Show success message
          const successAlert = document.createElement('div');
          successAlert.className = 'alert alert-success alert-dismissible fade show';
          successAlert.innerHTML = `
            <i class="fa fa-check-circle me-2"></i>Invoice linked successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.querySelector('.modal-body').insertBefore(successAlert, document.querySelector('.card'));

          // Close modal after a delay and reload page to show updated invoice
          setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadAdditionalInvoiceModal'));
            modal?.hide();

            // Reload page to show the newly added invoice
            location.reload();

          }, 2000);
        } else {
          uploadError.textContent = data.message || 'Failed to create invoice';
          uploadError.style.display = 'block';
          form.dataset.submitting = 'false';
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        uploadError.textContent = 'Error: ' + error.message;
        uploadError.style.display = 'block';
        form.dataset.submitting = 'false';
        submitBtn.disabled = false;
      }
    });
  }

})();
</script>
{% endblock %}